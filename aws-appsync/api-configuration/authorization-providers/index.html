<!doctypehtml><html lang="en"><meta charset="utf-8"><link rel="icon"type="image/svg+xml"href="/assets/favicon.15621087ab873d484cfdc234ae6d4f0559d2ece6.svg"><meta name="viewport"content="width=device-width,initial-scale=1"><link href="/assets/main.d3c4fd66da45b5fe1b587fd7bc4b64cc7a34bcf3.css"rel="stylesheet"><title>Authorization providers - API configuration - Building GraphQL APIs with AWS AppSync</title><nav class="navbar navbar-light"><div class="container-fluid flex-nowrap"><a class="navbar-brand"href="/">Building GraphQL APIs with AWS AppSync</a> <button class="navbar-toggler d-lg-none align-self-start"type="button"data-bs-toggle="offcanvas"data-bs-target="#offcanvasNavbar"aria-controls="offcanvasNavbar"><span class="navbar-toggler-icon"></span></button><div class="offcanvas offcanvas-end"tabindex="-1"id="offcanvasNavbar"aria-labelledby="offcanvasNavbarLabel"><div class="offcanvas-header"><h5 class="offcanvas-title"id="offcanvasNavbarLabel">Building GraphQL APIs with AWS AppSync</h5><button type="button"class="btn-close text-reset"data-bs-dismiss="offcanvas"aria-label="Close"></button></div><div class="offcanvas-body keep-scrolltop"><ul class="nav navbar-nav justify-content-end flex-grow-1 pe-3"><li class="nav-item"><a class="nav-link"href="/introduction/">Introduction</a><li class="nav-item"><a class="nav-link"href="/graphql-basics/">GraphQL basics</a><ul class="nav flex-column"><li class="nav-item"><a class="nav-link"href="/graphql-basics/graphql-vs-rest/">GraphQL vs REST</a><li class="nav-item"><a class="nav-link"href="/graphql-basics/schema/">Schema</a><li class="nav-item"><a class="nav-link"href="/graphql-basics/queries-and-mutations/">Queries and Mutations</a><li class="nav-item"><a class="nav-link"href="/graphql-basics/resolvers/">Resolvers</a><li class="nav-item"><a class="nav-link"href="/graphql-basics/access-control/">Access control</a></ul><li class="nav-item"><a class="nav-link active"href="/aws-appsync/">AWS AppSync</a><ul class="nav flex-column"><li class="nav-item"><a class="nav-link active"href="/aws-appsync/api-configuration/">API configuration</a><ul class="nav flex-column"><li class="nav-item"><a class="nav-link active"href="/aws-appsync/api-configuration/authorization-providers/">Authorization providers</a><li class="nav-item"><a class="nav-link"href="/aws-appsync/api-configuration/logging-and-monitoring/">Logging and monitoring</a><li class="nav-item"><a class="nav-link"href="/aws-appsync/api-configuration/custom-domains/">Custom domains</a><li class="nav-item"><a class="nav-link"href="/aws-appsync/api-configuration/waf/">WAF</a></ul><li class="nav-item"><a class="nav-link"href="/aws-appsync/data-sources/">Data sources</a><ul class="nav flex-column"><li class="nav-item"><a class="nav-link"href="/aws-appsync/data-sources/lambda-1/">Lambda</a><li class="nav-item"><a class="nav-link"href="/aws-appsync/data-sources/dynamodb/">DynamoDB</a><li class="nav-item"><span class="nav-link">HTTP ðŸš§</span><li class="nav-item"><span class="nav-link">RDS ðŸš§</span><li class="nav-item"><span class="nav-link">None ðŸš§</span></ul><li class="nav-item"><span class="nav-link">Resolvers ðŸš§</span><li class="nav-item"><span class="nav-link">Authorization ðŸš§</span><li class="nav-item"><span class="nav-link">Error handling ðŸš§</span><li class="nav-item"><span class="nav-link">Real-time data with subscriptions ðŸš§</span></ul><li class="nav-item"><span class="nav-link">Infrastructure-as-code ðŸš§</span><ul class="nav flex-column"><li class="nav-item"><span class="nav-link">Terraform ðŸš§</span><li class="nav-item"><span class="nav-link">CDK ðŸš§</span><li class="nav-item"><span class="nav-link">Amplify ðŸš§</span></ul><li class="nav-item"><span class="nav-link">Example application ðŸš§</span><li class="nav-item"><a class="nav-link"href="/glossary/">Glossary</a><li class="nav-item"><a class="nav-link"href="/about-the-author/">About the author</a><li class="nav-item"><a class="nav-link"href="/changelog/">Changelog</a><li class="nav-item"><a class="nav-link"href="/copyright/">Copyright</a></ul></div></div></div></nav><div class="d-flex flex-row"><ul class="nav flex-column navigation flex-shrink-0 flex-nowrap overflow-auto d-none d-lg-flex keep-scrolltop"><li class="nav-item"><a class="nav-link"href="/introduction/">Introduction</a><li class="nav-item"><a class="nav-link"href="/graphql-basics/">GraphQL basics</a><ul class="nav flex-column"><li class="nav-item"><a class="nav-link"href="/graphql-basics/graphql-vs-rest/">GraphQL vs REST</a><li class="nav-item"><a class="nav-link"href="/graphql-basics/schema/">Schema</a><li class="nav-item"><a class="nav-link"href="/graphql-basics/queries-and-mutations/">Queries and Mutations</a><li class="nav-item"><a class="nav-link"href="/graphql-basics/resolvers/">Resolvers</a><li class="nav-item"><a class="nav-link"href="/graphql-basics/access-control/">Access control</a></ul><li class="nav-item"><a class="nav-link active"href="/aws-appsync/">AWS AppSync</a><ul class="nav flex-column"><li class="nav-item"><a class="nav-link active"href="/aws-appsync/api-configuration/">API configuration</a><ul class="nav flex-column"><li class="nav-item"><a class="nav-link active"href="/aws-appsync/api-configuration/authorization-providers/">Authorization providers</a><li class="nav-item"><a class="nav-link"href="/aws-appsync/api-configuration/logging-and-monitoring/">Logging and monitoring</a><li class="nav-item"><a class="nav-link"href="/aws-appsync/api-configuration/custom-domains/">Custom domains</a><li class="nav-item"><a class="nav-link"href="/aws-appsync/api-configuration/waf/">WAF</a></ul><li class="nav-item"><a class="nav-link"href="/aws-appsync/data-sources/">Data sources</a><ul class="nav flex-column"><li class="nav-item"><a class="nav-link"href="/aws-appsync/data-sources/lambda-1/">Lambda</a><li class="nav-item"><a class="nav-link"href="/aws-appsync/data-sources/dynamodb/">DynamoDB</a><li class="nav-item"><span class="nav-link">HTTP ðŸš§</span><li class="nav-item"><span class="nav-link">RDS ðŸš§</span><li class="nav-item"><span class="nav-link">None ðŸš§</span></ul><li class="nav-item"><span class="nav-link">Resolvers ðŸš§</span><li class="nav-item"><span class="nav-link">Authorization ðŸš§</span><li class="nav-item"><span class="nav-link">Error handling ðŸš§</span><li class="nav-item"><span class="nav-link">Real-time data with subscriptions ðŸš§</span></ul><li class="nav-item"><span class="nav-link">Infrastructure-as-code ðŸš§</span><ul class="nav flex-column"><li class="nav-item"><span class="nav-link">Terraform ðŸš§</span><li class="nav-item"><span class="nav-link">CDK ðŸš§</span><li class="nav-item"><span class="nav-link">Amplify ðŸš§</span></ul><li class="nav-item"><span class="nav-link">Example application ðŸš§</span><li class="nav-item"><a class="nav-link"href="/glossary/">Glossary</a><li class="nav-item"><a class="nav-link"href="/about-the-author/">About the author</a><li class="nav-item"><a class="nav-link"href="/changelog/">Changelog</a><li class="nav-item"><a class="nav-link"href="/copyright/">Copyright</a></ul><div class="flex-grow-1 main container-fluid"><div class="row"><div class="col-lg-9 body p-3"><div class="d-lg-none mb-4"><div class="accordion"id="accordionExample"><div class="accordion-item"><h2 class="accordion-header"id="mobile-toc-header"><button class="accordion-button collapsed"type="button"data-bs-toggle="collapse"data-bs-target="#mobile-toc"aria-expanded="true"aria-controls="mobile-toc">In this chapter</button></h2><div id="mobile-toc"class="accordion-collapse collapse"aria-labelledby="mobile-toc-header"data-bs-parent="#accordionExample"><div class="accordion-body"><div class="toc-container"><a style="margin-left: 0em"href="#authorization-providers">Authorization providers</a> <a style="margin-left: 1em"href="#defined-authorization-cognito">Cognito User Pool</a> <a style="margin-left: 1em"href="#defined-authorization-iam">IAM</a> <a style="margin-left: 2em"href="#aws-signatures">AWS Signatures</a> <a style="margin-left: 2em"href="#calling-appsync-from-javascript">Calling AppSync from Javascript</a> <a style="margin-left: 1em"href="#defined-authorization-openid-connect">OpenID Connect</a> <a style="margin-left: 1em"href="#api-key">API key</a> <a style="margin-left: 1em"href="#lambda">Lambda</a> <a style="margin-left: 2em"href="#deniedfields">deniedFields</a> <a style="margin-left: 2em"href="#resolvercontext">resolverContext</a> <a style="margin-left: 2em"href="#ttl">TTL</a></div></div></div></div></div></div><h3 id="authorization-providers">Authorization providers</h3><p>Authorization is probably the most important AppSync API configuration as this defines who can call the API, and as we'll see later what queries, mutations, subscriptions, and fields they can use.<p>Access control is also defined in the schema using directives, but they don't allow much configuration. You can use the <code>@aws_cognito_user_pools</code> directive and define the user group, but you can't specify <em>which</em> user pool users need to authenticate to. Similarly, you can add API keys and define in the schema what fields are available using these keys, but creating and rotating them is done on the API level, separate from the schema.<p>AppSync allows the configuration of a default authorization mode as well as additional authorization providers. Each of these can be one of the supported provider.<figure class="image"><img srcset="/assets/CwmAY29nbml0b19hdXRoQDMucG5nJQM.5601ff0243649779894c70002913b575059e469b.png 3x, /assets/iwuAY29nbml0b19hdXRoQDMucG5nJXctNzkyAw.a2eb0b61c0042e38ce0bd7f16625a1507907f3a2.png, /assets/CwyAY29nbml0b19hdXRoQDMucG5nJXctMTE4OAM.f0794eb1ff9b7cb55aad716b60755b1a26f675b1.png 1.5x"title="Default authorization mode configured with a Cognito User Pool"><figcaption class="caption">Default authorization mode configured with a Cognito User Pool</figcaption></figure><p>With this two-layered approach, you can combine multiple providers, such as IAM and Cognito (a rather useful combination) or even add multiple user pools to a single API.<figure class="image"><img srcset="/assets/CweAaWFtX2F1dGhAMy5wbmclAw.7442ca19cc4e32da55be6c89cd772f5ef16d6a84.png 3x, /assets/iwmAaWFtX2F1dGhAMy5wbmcldy01MjkD.67e49346b7b4d11a825bfe60b19addce833247be.png, /assets/iwmAaWFtX2F1dGhAMy5wbmcldy03OTMD.d90ed17cf559a03117db6888711c8e8edc96cd3e.png 1.5x"title="IAM configured as an additional authorization mode"><figcaption class="caption">IAM configured as an additional authorization mode</figcaption></figure><p>AppSync supports several providers:<ul><li>Cognito User Pool<li>IAM<li>OpenID connect<li>API key<li>Lambda</ul><p>Let's see how each of them works!<h4 id="defined-authorization-cognito">Cognito User Pool</h4><p>A Cognito User Pool is a managed user directory in AWS. It provides a storage for users, defines a flow for authentication, and handles things like passwords, MFA, user groups, and token refresh/revocation. New applications usually use Cognito as it is integrated into the AWS ecosystem and it handles a lot of edge cases out-of-the-box.<p>Cognito User Pools issue <em>access tokens</em> that services can consume. A logged-in user is identified by its token that it sends with every request made to AppSync.<figure class="plantuml image"><svg xmlns="http://www.w3.org/2000/svg"height="424"preserveAspectRatio="none"style="width:319px;height:424px;background:#fff"viewBox="0 0 319 424"width="319"><defs><filter height="300%"id="bdea33ea3e90faf4e488f03fb65e03a567ea916665e12ed2df0dded38a56b67a__a"width="300%"x="-1"y="-1"><feGaussianBlur result="blurOut"stdDeviation="2"></feGaussianBlur><feColorMatrix in="blurOut"result="blurOut2"values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"></feColorMatrix><feOffset dx="4"dy="4"in="blurOut2"result="blurOut3"></feOffset><feBlend in="SourceGraphic"in2="blurOut3"></feBlend></filter></defs><path style="stroke:#a80036;stroke-width:1;stroke-dasharray:5,5"d="M26 88.297v329.594M137.5 88.297v329.594m93-329.594v329.594"></path><text font-family="sans-serif"font-size="14"textLength="31"x="8"y="84.995">user</text><circle cx="26.5"cy="15"fill="#FEFECE"filter="url(#bdea33ea3e90faf4e488f03fb65e03a567ea916665e12ed2df0dded38a56b67a__a)"style="stroke:#a80036;stroke-width:2"r="8"></circle><path d="M26.5 23v27m-13-19h26m-13 19-13 15m13-15 13 15"fill="none"filter="url(#bdea33ea3e90faf4e488f03fb65e03a567ea916665e12ed2df0dded38a56b67a__a)"style="stroke:#a80036;stroke-width:2;fill:none"></path><text font-family="sans-serif"font-size="14"textLength="54"x="107.5"y="84.995">Cognito</text><circle cx="137.5"cy="56"fill="#FEFECE"filter="url(#bdea33ea3e90faf4e488f03fb65e03a567ea916665e12ed2df0dded38a56b67a__a)"style="stroke:#a80036;stroke-width:2"r="12"></circle><path fill="#A80036"style="stroke:#a80036;stroke-width:1;fill:#a80036"d="m133.5 44 6-5-2 5 2 5-6-5z"></path><text font-family="sans-serif"font-size="14"textLength="60"x="197.5"y="68.698">GraphQL</text><text font-family="sans-serif"font-size="14"textLength="60"x="197.5"y="84.995">backend</text><circle cx="230.5"cy="39.703"fill="#FEFECE"filter="url(#bdea33ea3e90faf4e488f03fb65e03a567ea916665e12ed2df0dded38a56b67a__a)"style="stroke:#a80036;stroke-width:2"r="12"></circle><path fill="#A80036"style="stroke:#a80036;stroke-width:1;fill:#a80036"d="m226.5 27.703 6-5-2 5 2 5-6-5zm-101 87.727 10 4-10 4 4-4z"></path><path style="stroke:#a80036;stroke-width:1"d="M26.5 119.43h105"></path><text font-family="sans-serif"font-size="13"textLength="30"x="33.5"y="114.364">login</text><path d="M5 132.43v25h154v-15l-10-10H5"fill="#FBFB77"filter="url(#bdea33ea3e90faf4e488f03fb65e03a567ea916665e12ed2df0dded38a56b67a__a)"style="stroke:#a80036;stroke-width:1;fill:#fbfb77"></path><path d="M149 132.43v10h10l-10-10"fill="#FBFB77"style="stroke:#a80036;stroke-width:1;fill:#fbfb77"></path><text font-family="sans-serif"font-size="13"textLength="58"x="46.75"y="149.497">Auth flow</text><path fill="#A80036"style="stroke:#a80036;stroke-width:1;fill:#a80036"d="m37.5 183.695-10 4 10 4-4-4z"></path><path style="stroke:#a80036;stroke-width:1"d="M31.5 187.695h105"></path><text font-family="sans-serif"font-size="13"textLength="87"x="43.5"y="182.629">Access Token</text><path fill="#A80036"style="stroke:#a80036;stroke-width:1;fill:#a80036"d="m218.5 288.492 10 4-10 4 4-4z"></path><path style="stroke:#a80036;stroke-width:1"d="M26.5 292.492h198"></path><text font-family="sans-serif"font-size="13"textLength="180"x="33.5"y="211.762">Authorization: Access Token</text><text font-family="sans-serif"font-size="13"textLength="108"x="33.5"y="226.895">query MyQuery {</text><text font-family="sans-serif"font-size="13"textLength="63"x="41.5"y="242.028">allUsers {</text><text font-family="sans-serif"font-size="13"textLength="65"x="49.5"y="257.161">username</text><text font-family="sans-serif"font-size="13"textLength="8"x="41.5"y="272.293">}</text><text font-family="sans-serif"font-size="13"textLength="8"x="33.5"y="287.426">}</text><path d="M146 305.492v25h164v-15l-10-10H146"fill="#FBFB77"filter="url(#bdea33ea3e90faf4e488f03fb65e03a567ea916665e12ed2df0dded38a56b67a__a)"style="stroke:#a80036;stroke-width:1;fill:#fbfb77"></path><path d="M300 305.492v10h10l-10-10"fill="#FBFB77"style="stroke:#a80036;stroke-width:1;fill:#fbfb77"></path><text font-family="sans-serif"font-size="13"textLength="143"x="152"y="322.559">Validate Access Token</text><path d="M169 344.625v25h119v-15l-10-10H169"fill="#FBFB77"filter="url(#bdea33ea3e90faf4e488f03fb65e03a567ea916665e12ed2df0dded38a56b67a__a)"style="stroke:#a80036;stroke-width:1;fill:#fbfb77"></path><path d="M278 344.625v10h10l-10-10"fill="#FBFB77"style="stroke:#a80036;stroke-width:1;fill:#fbfb77"></path><text font-family="sans-serif"font-size="13"textLength="98"x="175"y="361.692">Resolve fields...</text><path fill="#A80036"style="stroke:#a80036;stroke-width:1;fill:#a80036"d="m37.5 395.89-10 4 10 4-4-4z"></path><path style="stroke:#a80036;stroke-width:1"d="M31.5 399.891h198"></path><text font-family="sans-serif"font-size="13"textLength="59"x="43.5"y="394.825">response</text></svg><figcaption class="caption">Cognito authentication</figcaption></figure><p>A successful authentication returns a short-lived <code>AccessToken</code>:<figure class="image prevp"><img srcset="/assets/CwmAY29nbml0b19hdXRoQDIucG5nJQM.060fe435e63cc107ae60a3680436f3ebbd78b1fa.png 2x, /assets/iwuAY29nbml0b19hdXRoQDIucG5nJXctOTU5Aw.7d4b933a640b33d472ea9672852564ac98f440f2.png, /assets/CwyAY29nbml0b19hdXRoQDIucG5nJXctMTQzOQM.91cccdf5b498004f35a8d97e29998bd9fa17c19b.png 1.5x"title="Authentication to Cognito returns an access token"><figcaption class="caption">Authentication to Cognito returns an access token</figcaption></figure><div class="floatbox floatbox-center"><div class="tcolorbox tcolorbox-info"><div class="tbox-header">Access Token vs Refresh Token</div><div class="tbox-body"><p>Access Tokens are short-lived (usually 15 minutes to a few hours), while Refresh Tokens have a long expiration time (months to years). A Refresh Token <a href="https://advancedweb.hu/how-to-use-the-refresh-token-with-cognito/">can request new Access Tokens</a>, so make sure you store it securely.</div></div></div><p>Then requests to AppSync needs to include this token in the <code>Authorization</code> header:<figure class="image prevp"><img srcset="/assets/iwyAYXBwc3luY19hdXRoX2hlYWRlckAyLnBuZyUD.fcd9e54a269abee9f74722a2800aaf87d1ba9845.png 2x, /assets/Cw-AYXBwc3luY19hdXRoX2hlYWRlckAyLnBuZyV3LTk2MAM.0eafd882bd9bdaf9cbb677a394543823dd228001.png, /assets/iw-AYXBwc3luY19hdXRoX2hlYWRlckAyLnBuZyV3LTE0NDAD.3e52ceaf070fee2301be1a4b7bb1ec6ebb65fc1f.png 1.5x"title="The user needs to send the access token with the GraphQL request"><figcaption class="caption">The user needs to send the access token with the GraphQL request</figcaption></figure><div class="floatbox floatbox-center"><div class="tcolorbox tcolorbox-info"><div class="tbox-header">User Pool vs Identity Pool</div><div class="tbox-body"><p>Cognito User Pools return <strong>access tokens</strong> that the consuming services can <a href="https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-tokens-verifying-a-jwt.html">validate against the user pool</a>. Services that support User Pools (such as AppSync) do this automatically.<p>Cognito Identity Pools return AWS IAM credentials (Access Key ID and Secret Access Keys), so they provide direct access to the AWS environment. As a result, if you use Identity Pools you need to configure <a href="#defined-authorization-iam">IAM</a> authorization for AppSync.<p>Usually, you'll want to use User Pools and not Identity Pools.</div></div></div><p>Configuring a Cognito User Pool for an API allows the use of the <code>@aws_cognito_user_pools</code> and the <code>@aws_auth</code> directives (depending on whether there are multiple providers configured or just a single one) that can restrict access to specific groups:<pre class="highlight"><code><span class="hljs-keyword">type</span><span class="hljs-literal"> Query</span> {
  <span class="hljs-comment"># everybody can get themselves</span>
  currentUser:<span class="hljs-literal"> User</span>

  <span class="hljs-comment"># only admins can query all users</span>
  allUsers: [<span class="hljs-literal">User</span>]
  <span class="hljs-meta">@aws_cognito_user_pools</span>(cognito_groups: [<span class="hljs-literal">"admin"</span>])
}</code></pre><h4 id="defined-authorization-iam">IAM</h4><p>IAM authorization is useful when the caller is an IAM identity: an IAM user or an IAM role. This is usually the case when using the Management Console, or when you want to call the API from a Lambda function or the AWS CLI.<p>IAM identities can have IAM policies and those policies can give them access to AWS resources. As an AppSync API is an AWS resource, a policy can give access to its queries, mutations, and subscriptions:<pre class="highlight prevp"><code><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"Version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2012-10-17"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"Statement"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"Effect"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Allow"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Action"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"appsync:GraphQL"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Resource"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"arn:aws:appsync:&lt;region&gt;:&lt;accountid&gt;:apis/&lt;apiid&gt;
/types/Query/fields/allUsers"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span></code></pre><p>An IAM policy is necessary to give access to an API, but it might not be sufficient depending on how the API authorization is configured. If you have multiple providers, you also need to add the <code>@aws_iam</code> directive in the schema:<pre class="highlight prevp"><code><span class="hljs-keyword">type</span><span class="hljs-literal"> Query</span> {
  <span class="hljs-comment"># everybody can get themselves</span>
  currentUser:<span class="hljs-literal"> User</span>

  <span class="hljs-comment"># only admins and IAM identities can query all users</span>
  allUsers: [<span class="hljs-literal">User</span>]
  <span class="hljs-meta">@aws_cognito_user_pools</span>(cognito_groups: [<span class="hljs-literal">"admin"</span>])
  <span class="hljs-meta">@aws_iam</span>
}</code></pre><figure class="plantuml image"><svg xmlns="http://www.w3.org/2000/svg"xmlns:xlink="http://www.w3.org/1999/xlink"height="325"preserveAspectRatio="none"style="width:369px;height:325px;background:#fff"viewBox="0 0 369 325"width="369"><path fill="#FFF"style="stroke:#00000000;stroke-width:1.5;fill:#fff"d="M7 7h167v118.922H7z"></path><image height="64"width="64"x="58.5"xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAIAAAAlC+aJAAACYUlEQVR4Xu2aQUsDMRCF+9v9B/4E/4DgzauePXjzqudQKIWCFEodGCxhX5N5mZ1kLe7yTm7czPdeMtlaN+nx7qa1wR/dllaApbUCLK0VYGn9S4Dt8/3+7YkXPiFQHoDDx8u55dq9PuBDouQHEGulsrpkjIw8pk98SJT8ALKQ8Bbq++u9awjdAaT0riF0BxBJ9U3jmzQCQEOQtYS35msEQOoZwiCAfiEMAkjdQvADnA47qWmiSrvUM0F+F2/NkQdAqsTS1eBjtV0Kc3gIHoCSzDOrRwiRAMyZFR5CJED63akjQwgGMNuleC8hiKJCCAZIRLu8vMziLYfiAZgQtAvjLYcCALSr5paPDCEAQMvNLdedOiaEuQC6YPTKLTfbpXlokJoLoPaj5Wa71BDqhwajWQB5Ebjux4QwCyCvAJvPmBD8ADj9xHI9s3qH4AfAudFybZeVEJjXp7qcAGi/CkM4W+0SN0+TnAClk6gUAo68CDdPkzwAdV8Hh+ABqJs6OIRmAMZRRwhmvyqpGcC0M12rBlvWRJgbqTYAbe2n6seRq+uh1LVyITajNgDGp9KO7BRCG4Bp0lX7VXwIx+xPNfW1mpoAGIdK9quYEPLqS17kagAg7a94bA6YKBKAsd80OFkRTRQJYNrPLPFU3SQoZiQFwMzK2K/iQzAnTSSAOSVpv4qxQ8UMswGY+ZjjOZfpiMqcNzEA5mRqf/1VZyKmJaQQALVfitvBl9gX6ern7VdpV9hXvy0PANDizKvJfpWGYF5zAbbc/3XsiOaDwuegKktXZQD8fa0AS2sFWForwNJaAZbWD9vq2LmAPvgfAAAAAElFTkSuQmCC"y="17"></image><text font-family="sans-serif"font-size="16"font-weight="bold"textLength="147"x="17"y="112.148">Lambda function</text><path fill="#FFF"style="stroke:#00000000;stroke-width:1.5;fill:#fff"d="M17.5 201h146v118.922h-146z"></path><image height="64"width="64"x="58.5"xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAIAAAAlC+aJAAADcElEQVR4Xu1Yy2pcMQzNn3bVZVfddtN1F1130X2h+0I/oPQHkg+4bSAQAiUDYSAQpgeLEWckW/Z9DM6AD2K4Y8vXOrIk2/fqcOG4sg2XhkGgNwaB3hgEemMQ6I1BoDcGgd44O4GXx0fI/vrm6ddv/ELw1yqtwFkIwMp/377fffg4vXlbEvRCB5p28ExsSQCuffjy1dtaFYx6/vPXvq4N2xDA9PefPnvL0Ajjdj9+In4geIDX0VJSXkBjLQHv9dt372FoiykSadDn4WixeiFWEYAFPDfCellMY3GYBp5b+AuWE4CbeUopL2jEgoCJMQgtEkuBZYYG/lqNHBYSwELrTIhdHwmxQD/LBC7g9ABhq+GwhEBLqYHLJYPxaxaEdbI0eG2rHGYT4LcbgbnxPpXNWozyQxA/qhDH0jwCJmtFYFA8hwfeYyqpz37mkF0owQwC8JOPhLmmM2A079Y+WnS1oWa6FDMI+N0ncEw7uB74TUAn9V2CVgKw9RzWCzgyzTpg2bXLp8qhnYA5mfmQXQnmYMJSAwnpzu2CJgLG/aXVXAnmYJytuecXoYkAF368y3ZvB3U2Qj/b7n3XRIDdv3nwGGismolK7qsT4JUNytlW0HA1c2kUmOJRJ8Dx40v1OaClk23Vfc3YUCfA9cfnkAGmxEx6awlOQdDJboIyXNTwBvwVGlpPTXrUCfCstu8IhFnW0BYRKw+FnV5EFKTXpEGFAO8j2TIs8NuciNwE5FiqYrYUlVK7vIfPHRwIFQJsWZwAd8crS3wgVcjtxx9PpuTvffoAYw5LLDpFhUCwQW4FYVLKtBIBNaZCgE//y3aAl/RhCysJiVdGcxcBo8IWwwC1R8OhSODp9IY65XZBD6lCEuiljEQ7FPx6lhJpovRTnYgA+oK5/XU2iOaqPJx+0tqni44RdlyFAAcMT+Dbp1Q0pNj7rom+RGB6DBfBM/S9d6AZVwhFRIB33CkFDIcsnvnmkRUYt0tVSEeV4BNXxCyIKu/Tt+Fd+mYjmpZAe7n0qwE7fEA3AvMax4mYDPaibsoQkAyTci4FRNLf70G386/zJezKiedFc/rAIVSK5pK0FKW52KfvLpzBsjnu0ufh7BZ5ksS+dHq5Px5dXgkyZVSSRktHwP41IEPgsjAI9MYg0BuDQG8MAr0xCPTGINAbg0Bv/Ae3IF2lX4hXSgAAAABJRU5ErkJggg=="y="211"></image><text font-family="sans-serif"font-size="16"font-weight="bold"textLength="126"x="27.5"y="306.148">Execution role</text><path fill="#FFF"style="stroke:#00000000;stroke-width:1.5;fill:#fff"d="M198.5 201h110v118.922h-110z"></path><image height="64"width="64"x="221.5"xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAIAAAAlC+aJAAACEElEQVR4Xu3asUoDQRgE4LyplaWVrY21hXWK9IK94AOIL6APcCoIEpAIIRCQ8SeL63+7uVzIzWw43GGrS3I3XzS7d5dMMPJM0g1jSz9g9fS8fHgsP+y4aZVt2QX4vLltTk6PO77u7tNa7XQC7D3Id3eUYU3Sci6dgPeLy/B6ew/yv2+BYccNBaxJWs6lExBe/HF1nT5QMHb0UCN9wKUClDkCwCau+XSWbj00pQFx2mUZigL8orHnGtSbcgBFe9AB34uFe/wvovbgAqz929l5vqbo2oMLiPvyBml7cAFwJxfBoG4POgDO4IeoPRQAZAZde4gAcAZpe+gAFjvXXb+8plvZEQLKpAL+ISBcCqZbD01pwPL3PgDLUBQQ2zd99xH2TzmAoj2KAUTtQQfYApx7dO3BBcR9eYO0PbiAcEHjN6rbgwtA2+DPSUXtQQegbVC3hwKAtkHaHiIANob5dKa+GIAOUCwVUAEDUwHbAF13SBXX+HyALcC2COQGm1Ib3tcCMWRAvJeYGEL7MLhLGxkAt8do8O1N6J88PHwA2gZ/QkpvDxEAbr/S9tAB0L7FS//sxqgA/v++yT7TxEgAvn08rxYZ+IB8zsnnJWLIgLx9iM5ABsRJM59z4pG4JxRkADaGvH2IzUXc9lAACqcCKmBgBgFG/6O/5dh/donNl8H57gqP3m+rdgFCVuP96fEoMnrADxiOGik5ulnkAAAAAElFTkSuQmCC"y="211"></image><text font-family="sans-serif"font-size="16"font-weight="bold"textLength="90"x="208.5"y="306.148">IAM policy</text><path fill="#FFF"style="stroke:#00000000;stroke-width:1.5;fill:#fff"d="M231.5 7h132v118.922h-132z"></path><image height="64"width="64"x="265.5"xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAIAAAAlC+aJAAADOUlEQVR4Xu2ZsWocMRCG/cB5g7xBnsC1m1Rp4zpFOneGdALbXGE4MOTgCoNh87M/OyialTSzq4tyIPFj1ruz0nwjzUhe34RPt1etG33rujQAemsA9NYA6K0B0FsDoLcaAzx/vjt+/XF+fHp/OX78Pk9zwwWEm2/fH15v7/Vbe9QGgH6Lx3QaDHCaMJA8Qjv9/HX48k33s0ENABBXcRqeIcbg0WYQnIaxwMBY23i1CwAOMerwCTOgDXLCi5gZ1ys5bQeQwDfxY7M2AtB7BD63Wv6ZtgBg7cJ7rIHu3ocNAFgw9F4/2inWX8ytq0D5ANA1q80lYh9XYcbIAuMDYAWsdkqxYkK40E8TMTRssIf3cq2NYzkAuHiqPVL0gHsww6ltYsnKnKKyBqrqVDsA6E21x7CEU/YpJn153ug6Ouco2iAnKwD2V3v4GU7xmDzl7YJHD3nXfmSyAjCKlvAHRctNo+ATupUZi68tsgJM87al7+fEdOdhrvounI4LDk+y2mxVJgCuAeP6oThj0lzvcsbKOSMyAXBJFNZAIgJL1L156RrOBOAKSVhKitgzL8tJHMs14SYArgd9f1WMX5yFLI7lNEiU9FBQewCmb1KvqoUoUTeA3G7N4mifhMYAjF9hEzjMfytiyMJuzSjg52n+s1MbxGoMUN4d+VRa7tiTmBX843TpaVyVCaBwFuBgiDoPXqw/GnXVLFfWWAZWh9MyAXB4CS1+lbGTwYiaa4lZLsauqm0CCEtp53U8QOIKed6XL0KxtFkuxqxj+v6qrABxGsQwYRkPzh2Xb1urScxHVbNLHebiOjj9namYBDKw6QQQM/o9zcmQMysXDK0KQBwk1kGuH7184R8TVHfiMvMenCoAjMd5+S4rYTZmmFfeU1OoAsBprvikacv9klKrHxVUARAd5r2WMPYMc4mJZF/9lBXg0pIE04/K+i8AOLFxZbOrM4AcK7Z5H/oCyPFuT1I1AEDanZz/MsIrTNnCjmZUAwDmH5cBgpojwWohquzHuC7saEY1AAhzkU22i/g8x+888gjXqDb7XafaAFASYzideEyeN8Pncq9aAnTRAOitAdBbA6C3BkBvDYDeunqAPxdjffOs6ZOIAAAAAElFTkSuQmCC"y="17"></image><text font-family="sans-serif"font-size="16"font-weight="bold"textLength="112"x="241.5"y="112.148">AppSync API</text><path d="M90.5 126.15v69.68"fill="none"style="stroke:#666;stroke-width:1;fill:none"></path><path fill="#666"style="stroke:#666;stroke-width:1;fill:#666"d="m90.5 200.88 4-9-4 4-4-4 4 9z"></path><text fill="#666"font-family="sans-serif"font-size="12"textLength="56"x="91.5"y="168.139">assumes</text><path d="M163.72 260.5h29.57"fill="none"style="stroke:#666;stroke-width:1;fill:none"></path><path fill="#666"style="stroke:#666;stroke-width:1;fill:#666"d="m198.44 260.5-9-4 4 4-4 4 9-4z"></path><path d="M174.1 66.5h52.14"fill="none"style="stroke:#666;stroke-width:1;fill:none"></path><path fill="#666"style="stroke:#666;stroke-width:1;fill:#666"d="m231.41 66.5-9-4 4 4-4 4 9-4z"></path><text fill="#666"font-family="sans-serif"font-size="12"textLength="21"x="192.25"y="60.639">call</text></svg><figcaption class="caption">IAM permissions to call an AppSync API</figcaption></figure><h5 id="aws-signatures">AWS Signatures</h5><p>Under the hood, calls with IAM credentials (Access Key ID and Secret Access Key) use an <a href="https://docs.aws.amazon.com/general/latest/gr/signature-version-4.html">AWS signature on the HTTP request</a>.<p>For example, this is an AppSync query, signed with an IAM role's credentials:<pre class="highlight prevp"><code><span class="hljs-title class_">HttpRequest</span> {
  <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
  <span class="hljs-attr">hostname</span>: <span class="hljs-string">'zb6sucjqnna73ncwc4juglddxi.appsync-api...'</span>,
  <span class="hljs-attr">port</span>: <span class="hljs-literal">undefined</span>,
  <span class="hljs-attr">query</span>: {},
  <span class="hljs-attr">headers</span>: {
    <span class="hljs-attr">host</span>: <span class="hljs-string">'zb6sucjqnna73ncwc4juglddxi.appsync-api...'</span>,
    <span class="hljs-string">'x-amz-date'</span>: <span class="hljs-string">'20220215T082225Z'</span>,
    <span class="hljs-string">'x-amz-security-token'</span>: <span class="hljs-string">'IQoJb3JpZ2luX2VjE...'</span>,
    <span class="hljs-string">'x-amz-content-sha256'</span>: <span class="hljs-string">'baf7492d61aaacdcb...'</span>,
    <span class="hljs-attr">authorization</span>: <span class="hljs-string">'AWS4-HMAC-SHA256 ... , Signature=21e592...'</span>
  },
  <span class="hljs-attr">body</span>: <span class="hljs-string">'{"query":"\\nquery MyQuery {...}\\n    ",
    "operationName":"MyQuery"}'</span>,
  <span class="hljs-attr">protocol</span>: <span class="hljs-string">'https:'</span>,
  <span class="hljs-attr">path</span>: <span class="hljs-string">'/graphql'</span>
}</code></pre><p>Notice that it has some extra headers: the <code>x-amz-date</code>, the <code>x-amz-security-token</code>, and the <code>x-amz-content-sha256</code>, and it also has a <code>Signature</code> in the <code>authorization</code> header. These are results of the signature process, and AWS automatically checks that the request contains all the required elements and that it was signed by an identity with sufficient permissions.<p>Usually, you don't need to know how the signature process works, and AWS provides tools to sign a request.<h5 id="calling-appsync-from-javascript">Calling AppSync from Javascript</h5><p>The <a href="https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/">AWS JS SDK v3</a> provides all the necessary libraries to calculate the signature and sign a request. With it, you can implement Lambda fuctions that call AppSync using their roles' permissions.<p>First, import the libraries:<pre class="highlight prevp"><code><span class="hljs-keyword">import</span> {<span class="hljs-title class_">HttpRequest</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">"@aws-sdk/protocol-http"</span>;
<span class="hljs-keyword">import</span> {<span class="hljs-title class_">SignatureV4</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">"@aws-sdk/signature-v4"</span>;
<span class="hljs-keyword">import</span> {defaultProvider}
  <span class="hljs-keyword">from</span> <span class="hljs-string">"@aws-sdk/credential-provider-node"</span>;
<span class="hljs-keyword">import</span> fetch <span class="hljs-keyword">from</span> <span class="hljs-string">"node-fetch"</span>;
<span class="hljs-keyword">import</span> {<span class="hljs-variable constant_">URL</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">"url"</span>;
<span class="hljs-keyword">import</span> pkg <span class="hljs-keyword">from</span> <span class="hljs-string">"@aws-crypto/sha256-js"</span>;
<span class="hljs-keyword">const</span> {<span class="hljs-title class_">Sha256</span>} = pkg;

<span class="hljs-comment">// this is the AppSync API URL</span>
<span class="hljs-keyword">const</span> appsyncAPI =
  <span class="hljs-string">"https://syr5fg5g2navzh2u3emfhhlyze.appsync-api"</span> +
  <span class="hljs-string">".eu-central-1.amazonaws.com/graphql"</span>;</code></pre><p>Then create the HTTP request:<pre class="highlight prevp"><code><span class="hljs-keyword">const</span> {host, pathname} = <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(appsyncAPI);

<span class="hljs-keyword">const</span> request = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpRequest</span>({
  <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
    <span class="hljs-comment">// the GraphQL query</span>
    <span class="hljs-attr">query</span>: <span class="hljs-string">`
query MyQuery {
  test_nothing
}
    `</span>,
    <span class="hljs-comment">// operation name</span>
    <span class="hljs-attr">operationName</span>: <span class="hljs-string">"MyQuery"</span>,
    <span class="hljs-comment">// it also supports variables</span>
  }),
  <span class="hljs-attr">headers</span>: {
    host,
  },
  <span class="hljs-attr">hostname</span>: host,
  <span class="hljs-attr">method</span>: <span class="hljs-string">"POST"</span>,
  <span class="hljs-attr">path</span>: pathname,
});</code></pre><p>Initialize the signer:<pre class="highlight prevp"><code><span class="hljs-keyword">const</span> signer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SignatureV4</span>({
  <span class="hljs-attr">credentials</span>: <span class="hljs-title function_">defaultProvider</span>(),
  <span class="hljs-attr">region</span>: host
    .<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/^[^.]+\.appsync-api\.(?&lt;region&gt;[^.]+)\..*$/</span>)
    .<span class="hljs-property">groups</span>.<span class="hljs-property">region</span>,
  <span class="hljs-attr">service</span>: <span class="hljs-string">"appsync"</span>,
  <span class="hljs-attr">sha256</span>: <span class="hljs-title class_">Sha256</span>
});</code></pre><p>Then generate the signed request and send it:<pre class="highlight prevp"><code><span class="hljs-comment">// generate the signed request</span>
<span class="hljs-keyword">const</span> signedRequest = <span class="hljs-keyword">await</span> signer.<span class="hljs-title function_">sign</span>(request);

<span class="hljs-comment">// send the request</span>
<span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(
  signedRequest.<span class="hljs-property">protocol</span> +
    <span class="hljs-string">"//"</span> +
    signedRequest.<span class="hljs-property">hostname</span> +
    signedRequest.<span class="hljs-property">path</span>,
  {
    <span class="hljs-attr">body</span>: signedRequest.<span class="hljs-property">body</span>,
    <span class="hljs-attr">headers</span>: signedRequest.<span class="hljs-property">headers</span>,
    <span class="hljs-attr">method</span>: signedRequest.<span class="hljs-property">method</span>,
  }
);

<span class="hljs-comment">// print the result</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">await</span> res.<span class="hljs-title function_">json</span>());</code></pre><h4 id="defined-authorization-openid-connect">OpenID Connect</h4><p>If you have users in a directory that supports OpenID Connect then you can configure that with AppSync. For example, Auth0 provides a user directory that is compatible with AppSync.<figure class="plantuml image"><svg xmlns="http://www.w3.org/2000/svg"height="530"preserveAspectRatio="none"style="width:426px;height:530px;background:#fff"viewBox="0 0 426 530"width="426"><defs><filter height="300%"id="ac0a41c83562ba00a62ae6e1a204fb7285c9b71edd1490a6bc1905ea0e190d30__a"width="300%"x="-1"y="-1"><feGaussianBlur result="blurOut"stdDeviation="2"></feGaussianBlur><feColorMatrix in="blurOut"result="blurOut2"values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"></feColorMatrix><feOffset dx="4"dy="4"in="blurOut2"result="blurOut3"></feOffset><feBlend in="SourceGraphic"in2="blurOut3"></feBlend></filter></defs><path style="stroke:#a80036;stroke-width:1;stroke-dasharray:5,5"d="M23 88.297v434.992M233 88.297v434.992M353 88.297v434.992"></path><text font-family="sans-serif"font-size="14"textLength="31"x="5"y="84.995">user</text><circle cx="23.5"cy="15"fill="#FEFECE"filter="url(#ac0a41c83562ba00a62ae6e1a204fb7285c9b71edd1490a6bc1905ea0e190d30__a)"style="stroke:#a80036;stroke-width:2"r="8"></circle><path d="M23.5 23v27m-13-19h26m-13 19-13 15m13-15 13 15"fill="none"filter="url(#ac0a41c83562ba00a62ae6e1a204fb7285c9b71edd1490a6bc1905ea0e190d30__a)"style="stroke:#a80036;stroke-width:2;fill:none"></path><text font-family="sans-serif"font-size="14"textLength="96"x="182.5"y="68.698">User directory</text><text font-family="sans-serif"font-size="14"textLength="147"x="157"y="84.995">with OpenID Connect</text><circle cx="233.5"cy="39.703"fill="#FEFECE"filter="url(#ac0a41c83562ba00a62ae6e1a204fb7285c9b71edd1490a6bc1905ea0e190d30__a)"style="stroke:#a80036;stroke-width:2"r="12"></circle><path fill="#A80036"style="stroke:#a80036;stroke-width:1;fill:#a80036"d="m229.5 27.703 6-5-2 5 2 5-6-5z"></path><text font-family="sans-serif"font-size="14"textLength="60"x="320"y="84.995">AppSync</text><circle cx="353"cy="56"fill="#FEFECE"filter="url(#ac0a41c83562ba00a62ae6e1a204fb7285c9b71edd1490a6bc1905ea0e190d30__a)"style="stroke:#a80036;stroke-width:2"r="12"></circle><path fill="#A80036"style="stroke:#a80036;stroke-width:1;fill:#a80036"d="m349 44 6-5-2 5 2 5-6-5z"></path><path fill="#EEE"filter="url(#ac0a41c83562ba00a62ae6e1a204fb7285c9b71edd1490a6bc1905ea0e190d30__a)"style="stroke:#eee;stroke-width:1;fill:#eee"d="M0 118.863h419v3H0z"></path><path style="stroke:#000;stroke-width:1"d="M0 118.863h419m-419 3h419"></path><path fill="#EEE"filter="url(#ac0a41c83562ba00a62ae6e1a204fb7285c9b71edd1490a6bc1905ea0e190d30__a)"style="stroke:#000;stroke-width:2;fill:#eee"d="M180 108.297h59v23.133h-59z"></path><text font-family="sans-serif"font-size="13"font-weight="bold"textLength="40"x="186"y="124.364">Login</text><path fill="#A80036"style="stroke:#a80036;stroke-width:1;fill:#a80036"d="m221.5 158.563 10 4-10 4 4-4z"></path><path style="stroke:#a80036;stroke-width:1"d="M23.5 162.563h204"></path><text font-family="sans-serif"font-size="13"textLength="186"x="30.5"y="157.497">/authorize?...&amp;scope=openid</text><path fill="#A80036"style="stroke:#a80036;stroke-width:1;fill:#a80036"d="m34.5 187.695-10 4 10 4-4-4z"></path><path style="stroke:#a80036;stroke-width:1"d="M28.5 191.695h204"></path><text font-family="sans-serif"font-size="13"textLength="118"x="40.5"y="186.629">redirect /?code=...</text><path fill="#A80036"style="stroke:#a80036;stroke-width:1;fill:#a80036"d="m221.5 216.828 10 4-10 4 4-4z"></path><path style="stroke:#a80036;stroke-width:1"d="M23.5 220.828h204"></path><text font-family="sans-serif"font-size="13"textLength="40"x="30.5"y="215.762">/token</text><path fill="#A80036"style="stroke:#a80036;stroke-width:1;fill:#a80036"d="m34.5 245.96-10 4 10 4-4-4z"></path><path style="stroke:#a80036;stroke-width:1"d="M28.5 249.961h204"></path><text font-family="sans-serif"font-size="13"textLength="54"x="40.5"y="244.895">id_token</text><path fill="#EEE"filter="url(#ac0a41c83562ba00a62ae6e1a204fb7285c9b71edd1490a6bc1905ea0e190d30__a)"style="stroke:#eee;stroke-width:1;fill:#eee"d="M0 278.527h419v3H0z"></path><path style="stroke:#000;stroke-width:1"d="M0 278.527h419m-419 3h419"></path><path fill="#EEE"filter="url(#ac0a41c83562ba00a62ae6e1a204fb7285c9b71edd1490a6bc1905ea0e190d30__a)"style="stroke:#000;stroke-width:2;fill:#eee"d="M152 267.961h115v23.133H152z"></path><text font-family="sans-serif"font-size="13"font-weight="bold"textLength="96"x="158"y="284.028">Call AppSync</text><path fill="#A80036"style="stroke:#a80036;stroke-width:1;fill:#a80036"d="m341 393.89 10 4-10 4 4-4z"></path><path style="stroke:#a80036;stroke-width:1"d="M23.5 397.891H347"></path><text font-family="sans-serif"font-size="13"textLength="148"x="30.5"y="317.161">Authorization: ID Token</text><text font-family="sans-serif"font-size="13"textLength="108"x="30.5"y="332.293">query MyQuery {</text><text font-family="sans-serif"font-size="13"textLength="63"x="38.5"y="347.426">allUsers {</text><text font-family="sans-serif"font-size="13"textLength="65"x="46.5"y="362.559">username</text><text font-family="sans-serif"font-size="13"textLength="8"x="38.5"y="377.692">}</text><text font-family="sans-serif"font-size="13"textLength="8"x="30.5"y="392.825">}</text><path d="M293 410.89v25h115v-15l-10-10H293"fill="#FBFB77"filter="url(#ac0a41c83562ba00a62ae6e1a204fb7285c9b71edd1490a6bc1905ea0e190d30__a)"style="stroke:#a80036;stroke-width:1;fill:#fbfb77"></path><path d="M398 410.89v10h10l-10-10"fill="#FBFB77"style="stroke:#a80036;stroke-width:1;fill:#fbfb77"></path><text font-family="sans-serif"font-size="13"textLength="94"x="299"y="427.957">Validate Token</text><path d="M291 450.023v25h119v-15l-10-10H291"fill="#FBFB77"filter="url(#ac0a41c83562ba00a62ae6e1a204fb7285c9b71edd1490a6bc1905ea0e190d30__a)"style="stroke:#a80036;stroke-width:1;fill:#fbfb77"></path><path d="M400 450.023v10h10l-10-10"fill="#FBFB77"style="stroke:#a80036;stroke-width:1;fill:#fbfb77"></path><text font-family="sans-serif"font-size="13"textLength="98"x="297"y="467.09">Resolve fields...</text><path fill="#A80036"style="stroke:#a80036;stroke-width:1;fill:#a80036"d="m34.5 501.29-10 4 10 4-4-4z"></path><path style="stroke:#a80036;stroke-width:1"d="M28.5 505.289H352"></path><text font-family="sans-serif"font-size="13"textLength="59"x="40.5"y="500.223">response</text></svg><figcaption class="caption">OpenID Connect flow</figcaption></figure><p>To configure an Auth0 user directory with AppSync, first create an Application:<figure class="image prevp"><img srcset="/assets/iwqAYXV0aDBfZGFzaGJvYXJkQDMucG5nJQM.3c4a2ef3f95f9ba9554c109af51474ce84be6254.png 3x, /assets/Cw2AYXV0aDBfZGFzaGJvYXJkQDMucG5nJXctOTg0Aw.fd903f3165729c74fd1cb12f1b8625b7b114545a.png, /assets/iw2AYXV0aDBfZGFzaGJvYXJkQDMucG5nJXctMTQ3NgM.cbcd1c64fa86e0533a0473fa1593c032ef46a2fe.png 1.5x"title="Auth0 application on the Auth0 dashboard"><figcaption class="caption">Auth0 application on the Auth0 dashboard</figcaption></figure><p>Then add its domain for the AppSync API:<figure class="image prevp"><img srcset="/assets/iwmAb3BlbmlkX2NvbmZpZ0AzLnBuZyUD.2ff1eb5b40d9cda9f3efff065d69c084fff9f278.png 3x, /assets/CwyAb3BlbmlkX2NvbmZpZ0AzLnBuZyV3LTgwMQM.e8526e1ccc267f2829e8777d165ea9f48ffdd1f6.png, /assets/iwyAb3BlbmlkX2NvbmZpZ0AzLnBuZyV3LTEyMDID.ca1a0b4bb9712b3eb2c5ebefdd0381a255e31462.png 1.5x"title="Configuring Auth0 for AppSync"><figcaption class="caption">Configuring Auth0 for AppSync</figcaption></figure><p>This is all the configuration you'll need, now users authenticated on Auth0 can send GraphQL requests to the AppSync API. This requires the OAuth flow to get the ID token first:<figure class="image prevp"><img srcset="/assets/CwmAb3BlbmlkX2xvZ2luQDIucG5nJQM.b043610cd06c15ea28663ebcafde13459a1cc305.png 2x, /assets/iwuAb3BlbmlkX2xvZ2luQDIucG5nJXctOTYwAw.4af86c2b58392324f986f6156024fb2789a12075.png, /assets/CwyAb3BlbmlkX2xvZ2luQDIucG5nJXctMTQ0MAM.023ca602192e4f757503c89db19be95cd5cc36bc.png 1.5x"title="Login flow"><figcaption class="caption">Login flow</figcaption></figure><p>Then include that token to the GraphQL requests, just like with Cognito:<figure class="image prevp"><img srcset="/assets/CwmAb3BlbmlkX3Rva2VuQDIucG5nJQM.f98d5457ad58130c9106055a474d4f4ce28ed387.png 2x, /assets/iwuAb3BlbmlkX3Rva2VuQDIucG5nJXctOTYwAw.1e3390d655adf72380056b0c075a77ca538679cf.png, /assets/CwyAb3BlbmlkX3Rva2VuQDIucG5nJXctMTQ0MAM.fefac573ba3efb9335a3ab9c74c6ce808cf2ab59.png 1.5x"title="ID token is included in the GraphQL request"><figcaption class="caption">ID token is included in the GraphQL request</figcaption></figure><p>With this, a user in the Auth0 domain can log in and send requests:<figure class="image prevp"><img srcset="/assets/CwiAYXV0aDBfdXNlckAzLnBuZyUD.7eabe364e5387a2fd94cdc9f77000de87d3f420b.png 3x, /assets/iwqAYXV0aDBfdXNlckAzLnBuZyV3LTc3MgM.65d702a60db57ffb78fdef75a713e15e5708bdea.png, /assets/CwuAYXV0aDBfdXNlckAzLnBuZyV3LTExNTgD.4110ce10c2d3a64f7123d0b9a4e85dc354ef3a20.png 1.5x"title="The user on the Auth0 dashboard"><figcaption class="caption">The user on the Auth0 dashboard</figcaption></figure><p>AppSync resolvers get the information about the signed-in user:<pre class="highlight prevp"><code><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"claims"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"sub"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"auth0|621203151b635f0070ea9978"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"aud"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"3SxmB0t1p4GQNlBTHHyYnnu3QJVlAOcp"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"iss"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://dev-at4in79i.us.auth0.com/"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"exp"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1645385061</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"iat"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1645349061</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"issuer"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://dev-at4in79i.us.auth0.com/"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"sub"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"auth0|621203151b635f0070ea9978"</span>
<span class="hljs-punctuation">}</span></code></pre><p>Notice the <code>sub</code> is the identifier of the Auth0 user, the <code>issuer</code> is the domain, and the <code>aud</code> is the Client ID of the application. AppSync verifies the token.<div class="floatbox floatbox-center"><div class="tcolorbox tcolorbox-info"><div class="tbox-header">Example code</div><div class="tbox-body"><p>To deploy a configured AppSync API and an Auth0 application to your account, see the code example in the GitHub repository: <a href="https://github.com/sashee/auth0-appsync">https://github.com/sashee/auth0-appsync</a></div></div></div><div class="floatbox floatbox-center"><div class="tcolorbox tcolorbox-info"><div class="tbox-header">Note</div><div class="tbox-body"><p>AppSync works with any provider that supports OpenID Connect and not just Auth0.</div></div></div><h4 id="api-key">API key</h4><p>API key authorization provides a simple way to restrict access to an AppSync API. These keys are texts that you can create on the AppSync console (or CLI, or SDK):<figure class="image prevp"><img srcset="/assets/CwmAYXBpX2tleV9saXN0QDMucG5nJQM.896870894847891f339fe72c40fb505700bf8b82.png 3x, /assets/iwuAYXBpX2tleV9saXN0QDMucG5nJXctOTMzAw.803f299b54dc87416a864cca5331012ef38e7da1.png, /assets/CwyAYXBpX2tleV9saXN0QDMucG5nJXctMTM5OQM.8398c131b09fa776e4a5ba698800f5b631282085.png 1.5x"title="API keys can be added to the API"><figcaption class="caption">API keys can be added to the API</figcaption></figure><p>Notice that every API key has an expiration time. This can go up to <a href="https://docs.aws.amazon.com/appsync/latest/devguide/security-authz.html#api-key-authorization">365 days</a>, then you need to create a new one.<p>Then the key is sent in the <code>x-api-key</code> header:<figure class="image prevp"><img srcset="/assets/iwqAYXBpX2tleV9yZXF1ZXN0QDIucG5nJQM.06378a437459c1227342b5f1e9ad772d3a206a2c.png 2x, /assets/Cw2AYXBpX2tleV9yZXF1ZXN0QDIucG5nJXctNjQ2Aw.3f13ee0b943b242bb4c0450af1c9fb1e8f21ecf2.png, /assets/Cw2AYXBpX2tleV9yZXF1ZXN0QDIucG5nJXctOTY5Aw.f4a89e3b2c7196a73e099a38daf14fc9771edfa4.png 1.5x"title="The API key is defined in the x-api-key header"><figcaption class="caption">The API key is defined in the x-api-key header</figcaption></figure><p>API keys are useful for getting started with AppSync development, but they are good only for a temporary solution. For admin tasks, <a href="#defined-authorization-iam">AWS IAM</a> is a better option, and for clients, a user directory, such as <a href="#defined-authorization-cognito">Cognito</a> or <a href="#defined-authorization-openid-connect">OpenID Connect</a> provides a good solution.<div class="floatbox floatbox-center"><div class="tcolorbox tcolorbox-info"><div class="tbox-header">Tip</div><div class="tbox-body"><p>API keys are only good for getting started with AppSync. Make sure you move to a user directory or IAM in the long run.</div></div></div><h4 id="lambda">Lambda</h4><p>(<a href="https://github.com/sashee/appsync-lambda-auth">Example code</a>)<p>The Lambda authorizer allows a Lambda function with arbitrary code to decide whether a request is allowed or not. This is the most versatile solution as it has the full power of a function: it can call other services and do any type of custom processing to reach the auth decision (allow or deny).<p>On the other hand, it involves writing custom code and maintaining a function that is run for (potentially) all requests hitting the API. This adds a lot of extra code and complexity, so my recommendation is to use it only when the other solutions are not sufficient for your case.<figure class="plantuml image"><svg xmlns="http://www.w3.org/2000/svg"height="394"preserveAspectRatio="none"style="width:453px;height:394px;background:#fff"viewBox="0 0 453 394"width="453"><defs><filter height="300%"id="bde7e1545f049e17f7e11b7a628918761dcd2af7fab327e019ed42550d78ec79__a"width="300%"x="-1"y="-1"><feGaussianBlur result="blurOut"stdDeviation="2"></feGaussianBlur><feColorMatrix in="blurOut"result="blurOut2"values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"></feColorMatrix><feOffset dx="4"dy="4"in="blurOut2"result="blurOut3"></feOffset><feBlend in="SourceGraphic"in2="blurOut3"></feBlend></filter></defs><path fill="#FFF"filter="url(#bde7e1545f049e17f7e11b7a628918761dcd2af7fab327e019ed42550d78ec79__a)"style="stroke:#000;stroke-width:2;fill:#fff"d="M10 163.563h429.5v206.734H10z"></path><path fill="#FFF"style="stroke:none;stroke-width:1;fill:#fff"d="M10 297.227h429.5v73.07H10z"></path><path style="stroke:#a80036;stroke-width:1;stroke-dasharray:5,5"d="M38 88.297v299m108.5-299v299m117-299v299m125-299v299"></path><text font-family="sans-serif"font-size="14"textLength="31"x="20"y="84.995">user</text><circle cx="38.5"cy="15"fill="#FEFECE"filter="url(#bde7e1545f049e17f7e11b7a628918761dcd2af7fab327e019ed42550d78ec79__a)"style="stroke:#a80036;stroke-width:2"r="8"></circle><path d="M38.5 23v27m-13-19h26m-13 19-13 15m13-15 13 15"fill="none"filter="url(#bde7e1545f049e17f7e11b7a628918761dcd2af7fab327e019ed42550d78ec79__a)"style="stroke:#a80036;stroke-width:2;fill:none"></path><text font-family="sans-serif"font-size="14"textLength="60"x="113.5"y="84.995">AppSync</text><circle cx="146.5"cy="56"fill="#FEFECE"filter="url(#bde7e1545f049e17f7e11b7a628918761dcd2af7fab327e019ed42550d78ec79__a)"style="stroke:#a80036;stroke-width:2"r="12"></circle><path fill="#A80036"style="stroke:#a80036;stroke-width:1;fill:#a80036"d="m142.5 44 6-5-2 5 2 5-6-5z"></path><path fill="#FEFECE"filter="url(#bde7e1545f049e17f7e11b7a628918761dcd2af7fab327e019ed42550d78ec79__a)"style="stroke:#a80036;stroke-width:1.5;fill:#fefece"d="M189.5 53h145v30.297h-145z"></path><text font-family="sans-serif"font-size="14"textLength="131"x="196.5"y="72.995">Authorizer function</text><path fill="#FEFECE"filter="url(#bde7e1545f049e17f7e11b7a628918761dcd2af7fab327e019ed42550d78ec79__a)"style="stroke:#a80036;stroke-width:1.5;fill:#fefece"d="M348.5 53h77v30.297h-77z"></path><text font-family="sans-serif"font-size="14"textLength="63"x="355.5"y="72.995">resolvers</text><path fill="#A80036"style="stroke:#a80036;stroke-width:1;fill:#a80036"d="m134.5 115.43 10 4-10 4 4-4z"></path><path style="stroke:#a80036;stroke-width:1"d="M38.5 119.43h102"></path><text font-family="sans-serif"font-size="13"textLength="49"x="45.5"y="114.364">request</text><path fill="#A80036"style="stroke:#a80036;stroke-width:1;fill:#a80036"d="m252 144.563 10 4-10 4 4-4z"></path><path style="stroke:#a80036;stroke-width:1"d="M146.5 148.563H258"></path><text font-family="sans-serif"font-size="13"textLength="36"x="153.5"y="143.497">token</text><path d="M10 163.563h64v7l-10 10H10v-17"fill="#EEE"style="stroke:#000;stroke-width:1;fill:#eee"></path><path fill="none"style="stroke:#000;stroke-width:2;fill:none"d="M10 163.563h429.5v206.734H10z"></path><text font-family="sans-serif"font-size="13"font-weight="bold"textLength="19"x="25"y="176.629">alt</text><text font-family="sans-serif"font-size="11"font-weight="bold"textLength="79"x="89"y="175.773">[authorized]</text><path fill="#A80036"style="stroke:#a80036;stroke-width:1;fill:#a80036"d="m157.5 197.828-10 4 10 4-4-4z"></path><path style="stroke:#a80036;stroke-width:1"d="M151.5 201.828H263"></path><text font-family="sans-serif"font-size="13"textLength="68"x="163.5"y="196.762">authorized</text><path fill="#A80036"style="stroke:#a80036;stroke-width:1;fill:#a80036"d="m377 226.96 10 4-10 4 4-4z"></path><path style="stroke:#a80036;stroke-width:1"d="M146.5 230.961H383"></path><text font-family="sans-serif"font-size="13"textLength="36"x="153.5"y="225.895">query</text><path fill="#A80036"style="stroke:#a80036;stroke-width:1;fill:#a80036"d="m157.5 256.094-10 4 10 4-4-4z"></path><path style="stroke:#a80036;stroke-width:1;stroke-dasharray:2,2"d="M151.5 260.094H388"></path><text font-family="sans-serif"font-size="13"textLength="59"x="163.5"y="255.028">response</text><path fill="#A80036"style="stroke:#a80036;stroke-width:1;fill:#a80036"d="m49.5 285.227-10 4 10 4-4-4z"></path><path style="stroke:#a80036;stroke-width:1;stroke-dasharray:2,2"d="M43.5 289.227h102"></path><text font-family="sans-serif"font-size="13"textLength="59"x="55.5"y="284.161">response</text><path style="stroke:#000;stroke-width:1;stroke-dasharray:2,2"d="M10 298.227h429.5"></path><text font-family="sans-serif"font-size="11"font-weight="bold"textLength="54"x="15"y="308.437">[denied]</text><path fill="#A80036"style="stroke:#a80036;stroke-width:1;fill:#a80036"d="m157.5 329.164-10 4 10 4-4-4z"></path><path style="stroke:#a80036;stroke-width:1"d="M151.5 333.164H263"></path><text font-family="sans-serif"font-size="13"textLength="43"x="163.5"y="328.098">denied</text><path fill="#A80036"style="stroke:#a80036;stroke-width:1;fill:#a80036"d="m49.5 358.297-10 4 10 4-4-4z"></path><path style="stroke:#a80036;stroke-width:1;stroke-dasharray:2,2"d="M43.5 362.297h102"></path><text font-family="sans-serif"font-size="13"textLength="84"x="55.5"y="357.231">unauthorized</text></svg><figcaption class="caption">The authorizer Lambda decides if a request is allowed or not</figcaption></figure><p>Configuring a Lambda authorizer for the API is straightforward. All you need is to define which function AppSync should run:<figure class="image prevp"><img srcset="/assets/CwyAbGFtYmRhX2F1dGhfY29uZmlnQDMucG5nJQM.83f5cb49d87fe2c207fbe505c1d6b55e6b690f9c.png 3x, /assets/iw6AbGFtYmRhX2F1dGhfY29uZmlnQDMucG5nJXctNzc2Aw.682693ef2fda98ada156d4e3867919bcb7f7f51b.png, /assets/Cw-AbGFtYmRhX2F1dGhfY29uZmlnQDMucG5nJXctMTE2NAM.a30f34da60550ea69d8f6dc4916e918d1305c42f.png 1.5x"title="Lambda authorizer config"><figcaption class="caption">Lambda authorizer config</figcaption></figure><p>The function then needs to give <code>lambda:InvokeFunction</code> access to the AppSync API. This is done using a resource-based permission on the function:<figure class="image prevp"><img srcset="/assets/GxwA-AVqckYBBRLZ71oQlFUqIglQ5cUki7_WsFlI4TE.dce05dff4aaa951be1bda762bca11d03b384e4dd.png 3x, /assets/GyEA-EVP1pIoKaLU7CYINCYlkQWo8mKShdvyxkTCMSn0rKI.a5bc02491abf3d9bd5719184cb640e690e9cbf21.png, /assets/CxGAYXV0aF9sYW1iZGFfcGVybWlzc2lvbkAzLnBuZyV3LTEyNTgD.0e06d66667362df9af0765fd677ce7ddc34cc6af.png 1.5x"title="Resource-based policy to allow AppSync to call the function"><figcaption class="caption">Resource-based policy to allow AppSync to call the function</figcaption></figure><p>The programming model takes the usual process as other Lambdas: the processing can be in any language and it can use any resources as long as it responds in a specific format. And the response is a JSON object with at least an <code>isAuthorized</code> field.<p>The function gets the authorization token, which is the value the clients sends in the Authorization header when it makes a request:<figure class="image prevp"><img srcset="/assets/iwuAbGFtYmRhX2F1dGhfdG9rZW5AMi5wbmclAw.7c7706c02b57d87cdb80ee1c5e7008b1bbed10ea.png 2x, /assets/Cw6AbGFtYmRhX2F1dGhfdG9rZW5AMi5wbmcldy05NjAD.2d419ee4d92ef5ca65eeb1d14fd45bdc3708123e.png, /assets/iw6AbGFtYmRhX2F1dGhfdG9rZW5AMi5wbmcldy0xNDQwAw.2e5d362d9c6be0891de47c9a2cc0858f4349e1a7.png 1.5x"title="The authorization token is in the request header"><figcaption class="caption">The authorization token is in the request header</figcaption></figure><p>The function gets this value along with some information about the request:<pre class="highlight prevp"><code>{
  <span class="hljs-string">"authorizationToken"</span>: <span class="hljs-string">"token2"</span>,
  <span class="hljs-string">"requestContext"</span>: {
    <span class="hljs-string">"apiId"</span>: <span class="hljs-string">"q6ggwm5zqfgszjtnz4iatx7sam"</span>,
    <span class="hljs-string">"accountId"</span>: <span class="hljs-string">"278868411450"</span>,
    <span class="hljs-string">"requestId"</span>: <span class="hljs-string">"82035a43-bb90-4cf4-b498-d50bb74b663e"</span>,
    <span class="hljs-string">"queryString"</span>: <span class="hljs-string">"query MyQuery {\n  document(id: \"doc2\")
    {\n    id\n    title\n  }\n}\n"</span>,
    <span class="hljs-string">"operationName"</span>: <span class="hljs-string">"MyQuery"</span>,
    <span class="hljs-string">"variables"</span>: {}
  }
}</code></pre><p>AppSync supports several fields in the response, but the only required is the <code>isAuthorized</code>. If it is true, AppSync runs the resolvers for the query. If <code>isAuthorized</code> if false, the request is denied without further processing. Note that resolvers can also return an unauthorized error as we've seen in the <a href="/graphql-basics/access-control/#defined-resolver-based-access-control">Resolver-based access control</a> chapter.<p>For example, a simple access control scheme can use a DynamoDB table to implement an API key-like functionality:<pre class="highlight prevp"><code><span class="hljs-keyword">const</span> client = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamoDBClient</span>();
<span class="hljs-keyword">const</span> item = <span class="hljs-keyword">await</span> client.<span class="hljs-title function_">send</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">GetItemCommand</span>({
  <span class="hljs-title class_">TableName</span>: tokens_table,
  <span class="hljs-title class_">Key</span>: {<span class="hljs-attr">id</span>: {<span class="hljs-attr">S</span>: token}},
}));
<span class="hljs-keyword">if</span> (!item.<span class="hljs-property">Item</span>) {
  <span class="hljs-comment">// token missing, deny access</span>
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">isAuthorized</span>: <span class="hljs-literal">false</span>,
  };
}<span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// token found</span>
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">isAuthorized</span>: <span class="hljs-literal">true</span>,
  };
}</code></pre><h5 id="deniedfields">deniedFields</h5><p>AppSync can deny requests based on what fields are in query. This mimics the <code>@aws_cognito_user_pools</code> directive that restricts what data is accessible for Cognito users. Since the Lambda authorizer does not support a similar directive, it would be harder to implement <a href="/graphql-basics/access-control/#defined-schema-based-access-control">schema-based access control</a>.<p>That's the motivation behind the <code>deniedFields</code> response value. It is optional, and if it's defined then it's a list of denied fields in the form of <code>TypeName.FieldName</code> and if the query contains any of them it will be denied.<p>For example, this schema has multiple fields for a type:<pre class="highlight prevp"><code><span class="hljs-keyword">type</span><span class="hljs-literal"> Document</span> {
  id: <span class="hljs-literal">ID</span>!
  title:<span class="hljs-literal"> String</span>!
  text:<span class="hljs-literal"> String</span>!
}</code></pre><p>Then the Lambda can deny access to the text without parsing the query string itself:<pre class="highlight prevp"><code><span class="hljs-keyword">return</span> {
  <span class="hljs-attr">isAuthorized</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">deniedFields</span>: [<span class="hljs-string">"Document.text"</span>],
};</code></pre><p>Note that it can not restrict access to top-level fields (Queries, Mutations, or Subscriptions). This is a serious limitation, and we'll take a look at a possible implementation by combining an authorizer Lambda with resolvers.<h5 id="resolvercontext">resolverContext</h5><p>The <code>resolverContext</code> field in the result object allows the Lambda function to provide data to the resolvers that process the fields. It is an object with string fields and it is available under the <code>$ctx.identity.resolverContext</code>.<p>Since it does not support complex types, such as lists, the usual pattern is to stringify the value and then parse it in the resolver:<pre class="highlight prevp"><code><span class="hljs-keyword">return</span> {
  <span class="hljs-attr">isAuthorized</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">resolverContext</span>: {
    <span class="hljs-attr">documents</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>([<span class="hljs-string">"doc1"</span>]),
  },
};</code></pre><p>Then the resolver can use the value, for example, to restrict what objects the user is able to access:<pre class="highlight prevp"><code>#if(
  !$util.parseJson($ctx.identity.resolverContext.documents)
    .contains($ctx.arguments.id)
)
  $util.unauthorized()
#end</code></pre><p>This pattern is also useful to deny access to specific Queries, Mutations, or Subscriptions. The function can provide info for the resolvers in the <code>resolverContext</code>:<pre class="highlight prevp"><code><span class="hljs-keyword">return</span> {
  <span class="hljs-attr">isAuthorized</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">resolverContext</span>: {
    <span class="hljs-attr">allowedQueries</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>([<span class="hljs-string">"document"</span>]),
  },
  <span class="hljs-comment">// ...</span>
};</code></pre><p>Then the resolver for that field can check this value:<pre class="highlight prevp"><code>## document resolver
#if(
  !$util.parseJson($ctx.identity.resolverContext.allowedQueries)
    .contains("document")
)
  $util.unauthorized()
#end</code></pre><p>Just keep in mind that you need to implement this checking for all resolvers you want to protect:<pre class="highlight prevp"><code>## file resolver
#if(
  !$util.parseJson($ctx.identity.resolverContext.allowedQueries)
    .contains("file")
)
  $util.unauthorized()
#end</code></pre><h5 id="ttl">TTL</h5><p>By default, AppSync caches the result of the authorizer Lambda for 5 minutes (300 seconds). This caching is often useful as without it every single call to the API triggers the function, which can in turn send requests to databases or other systems. This is usually wasteful as if a user is allowed to access an API, it is usually allowed to access it for subsequent requests too. This is where caching comes into play: AppSync only runs the Lambda every once in a while and reuse the result for most requests.<p>This sounds good, but <strong>caching is always a tradeoff and it can create edge cases</strong>. Short caching time doesn't save too many requests, while long caching can backfire when, for example, you want to revoke a token and it will still be valid until the cache time passes.<p>A more problematic case is when the decision is based on other data and not just the authorization token. For example, the function gets the GraphQL query in the <code>requestContext.queryString</code>, but it is not part of the cache key. If the authorization decision is based on the query, a user can send a request that is allowed, then send another one after it and AppSync might allow the request without calling the Lambda at all, which breaks authorization.<p>Because of this, use a short caching time, such as 5 minutes which is the default. Also, if you use anything from the <code>requestContext</code>, make sure to disable the cache.<p>Cache time is called TTL (time-to-live). You can set a defalt for the API when you configure the authorizer.<figure class="image prevp"><img srcset="/assets/iwmAYXBpX2NhY2hlX3R0bEAzLnBuZyUD.15e202f1f7697ab21b74597d86b3fa4d795cbb59.png 3x, /assets/CwyAYXBpX2NhY2hlX3R0bEAzLnBuZyV3LTc3MgM.0b86050d6356905db5b081ba3ffcb6352eb471e0.png, /assets/iwyAYXBpX2NhY2hlX3R0bEAzLnBuZyV3LTExNTgD.5a317ae4792d09f312be733eb3205644e1d7a39b.png 1.5x"title="The default cache TTL on the API level is 300 seconds"><figcaption class="caption">The default cache TTL on the API level is 300 seconds</figcaption></figure><p>Also, you can overwrite it for individual responses using the <code>ttlOverride</code> field:<pre class="highlight prevp"><code><span class="hljs-keyword">return</span> {
  <span class="hljs-attr">isAuthorized</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-comment">// ...</span>
  <span class="hljs-attr">ttlOverride</span>: <span class="hljs-number">0</span>,
};</code></pre><div class="floatbox floatbox-center"><div class="tcolorbox tcolorbox-info"><div class="tbox-header">Tip</div><div class="tbox-body"><p>Caching can drastically speed up authorization, but in some cases it can break authorization too. Make sure you understand how it works, especially if you use any value from the <code>requestContext</code>.</div></div></div><div class="tcolorbox tcolorbox-secondary my-5"><div class="tbox-header fw-bold">Master AppSync and GraphQL</div><div class="tbox-body"><div>Support this book and get all future updates and extra chapters in ebook format.</div><div class="d-flex justify-content-center"><a role="button"href="https://tsallai.gumroad.com/l/graphql-on-aws-appsync-book"class="btn btn-primary not-styled mt-3 text-white">Buy the book</a></div></div></div><div class="pagination row"><div class="col-6"><a href="/aws-appsync/api-configuration/"class="border rounded d-block p-3"><div class="pagination-sublabel text-muted small">Previous</div><div class="pagination-title">&lt; API configuration</div></a></div><div class="col-6"><a href="/aws-appsync/api-configuration/logging-and-monitoring/"class="border rounded d-block p-3 text-end ms-auto"><div class="pagination-sublabel text-muted small">Next</div><div class="pagination-title">Logging and monitoring &gt;</div></a></div></div><footer>Â© TamÃ¡s Sallai - <a href="https://advancedweb.hu">advancedweb.hu</a></footer></div><div class="col-lg-3 d-none d-lg-block"><div class="toc-container"><a style="margin-left: 0em"href="#authorization-providers">Authorization providers</a> <a style="margin-left: 1em"href="#defined-authorization-cognito">Cognito User Pool</a> <a style="margin-left: 1em"href="#defined-authorization-iam">IAM</a> <a style="margin-left: 2em"href="#aws-signatures">AWS Signatures</a> <a style="margin-left: 2em"href="#calling-appsync-from-javascript">Calling AppSync from Javascript</a> <a style="margin-left: 1em"href="#defined-authorization-openid-connect">OpenID Connect</a> <a style="margin-left: 1em"href="#api-key">API key</a> <a style="margin-left: 1em"href="#lambda">Lambda</a> <a style="margin-left: 2em"href="#deniedfields">deniedFields</a> <a style="margin-left: 2em"href="#resolvercontext">resolverContext</a> <a style="margin-left: 2em"href="#ttl">TTL</a></div></div></div></div></div><script src="/assets/main.077454cb0bffe3695e9176b1b5f8a7fd9676d920.js"></script>