<!doctypehtml><html lang="en"><meta charset="utf-8"><link rel="icon"type="image/svg+xml"href="/assets/favicon.15621087ab873d484cfdc234ae6d4f0559d2ece6.svg"><meta name="viewport"content="width=device-width,initial-scale=1"><link href="/assets/main.d3c4fd66da45b5fe1b587fd7bc4b64cc7a34bcf3.css"rel="stylesheet"><title>WAF - API configuration - Building GraphQL APIs with AWS AppSync</title><nav class="navbar navbar-light"><div class="container-fluid flex-nowrap"><a class="navbar-brand"href="/">Building GraphQL APIs with AWS AppSync</a> <button class="navbar-toggler d-lg-none align-self-start"type="button"data-bs-toggle="offcanvas"data-bs-target="#offcanvasNavbar"aria-controls="offcanvasNavbar"><span class="navbar-toggler-icon"></span></button><div class="offcanvas offcanvas-end"tabindex="-1"id="offcanvasNavbar"aria-labelledby="offcanvasNavbarLabel"><div class="offcanvas-header"><h5 class="offcanvas-title"id="offcanvasNavbarLabel">Building GraphQL APIs with AWS AppSync</h5><button type="button"class="btn-close text-reset"data-bs-dismiss="offcanvas"aria-label="Close"></button></div><div class="offcanvas-body keep-scrolltop"><ul class="nav navbar-nav justify-content-end flex-grow-1 pe-3"><li class="nav-item"><a class="nav-link"href="/introduction/">Introduction</a><li class="nav-item"><a class="nav-link"href="/graphql-basics/">GraphQL basics</a><ul class="nav flex-column"><li class="nav-item"><a class="nav-link"href="/graphql-basics/graphql-vs-rest/">GraphQL vs REST</a><li class="nav-item"><a class="nav-link"href="/graphql-basics/schema/">Schema</a><li class="nav-item"><a class="nav-link"href="/graphql-basics/queries-and-mutations/">Queries and Mutations</a><li class="nav-item"><a class="nav-link"href="/graphql-basics/resolvers/">Resolvers</a><li class="nav-item"><a class="nav-link"href="/graphql-basics/access-control/">Access control</a></ul><li class="nav-item"><a class="nav-link active"href="/aws-appsync/">AWS AppSync</a><ul class="nav flex-column"><li class="nav-item"><a class="nav-link active"href="/aws-appsync/api-configuration/">API configuration</a><ul class="nav flex-column"><li class="nav-item"><a class="nav-link"href="/aws-appsync/api-configuration/authorization-providers/">Authorization providers</a><li class="nav-item"><a class="nav-link"href="/aws-appsync/api-configuration/logging-and-monitoring/">Logging and monitoring</a><li class="nav-item"><a class="nav-link"href="/aws-appsync/api-configuration/custom-domains/">Custom domains</a><li class="nav-item"><a class="nav-link active"href="/aws-appsync/api-configuration/waf/">WAF</a></ul><li class="nav-item"><a class="nav-link"href="/aws-appsync/data-sources/">Data sources</a><ul class="nav flex-column"><li class="nav-item"><a class="nav-link"href="/aws-appsync/data-sources/lambda-1/">Lambda</a><li class="nav-item"><a class="nav-link"href="/aws-appsync/data-sources/dynamodb/">DynamoDB</a><li class="nav-item"><span class="nav-link">HTTP ðŸš§</span><li class="nav-item"><span class="nav-link">RDS ðŸš§</span><li class="nav-item"><span class="nav-link">None ðŸš§</span></ul><li class="nav-item"><span class="nav-link">Resolvers ðŸš§</span><li class="nav-item"><span class="nav-link">Authorization ðŸš§</span><li class="nav-item"><span class="nav-link">Error handling ðŸš§</span><li class="nav-item"><span class="nav-link">Real-time data with subscriptions ðŸš§</span></ul><li class="nav-item"><span class="nav-link">Infrastructure-as-code ðŸš§</span><ul class="nav flex-column"><li class="nav-item"><span class="nav-link">Terraform ðŸš§</span><li class="nav-item"><span class="nav-link">CDK ðŸš§</span><li class="nav-item"><span class="nav-link">Amplify ðŸš§</span></ul><li class="nav-item"><span class="nav-link">Example application ðŸš§</span><li class="nav-item"><a class="nav-link"href="/glossary/">Glossary</a><li class="nav-item"><a class="nav-link"href="/about-the-author/">About the author</a><li class="nav-item"><a class="nav-link"href="/changelog/">Changelog</a><li class="nav-item"><a class="nav-link"href="/copyright/">Copyright</a></ul></div></div></div></nav><div class="d-flex flex-row"><ul class="nav flex-column navigation flex-shrink-0 flex-nowrap overflow-auto d-none d-lg-flex keep-scrolltop"><li class="nav-item"><a class="nav-link"href="/introduction/">Introduction</a><li class="nav-item"><a class="nav-link"href="/graphql-basics/">GraphQL basics</a><ul class="nav flex-column"><li class="nav-item"><a class="nav-link"href="/graphql-basics/graphql-vs-rest/">GraphQL vs REST</a><li class="nav-item"><a class="nav-link"href="/graphql-basics/schema/">Schema</a><li class="nav-item"><a class="nav-link"href="/graphql-basics/queries-and-mutations/">Queries and Mutations</a><li class="nav-item"><a class="nav-link"href="/graphql-basics/resolvers/">Resolvers</a><li class="nav-item"><a class="nav-link"href="/graphql-basics/access-control/">Access control</a></ul><li class="nav-item"><a class="nav-link active"href="/aws-appsync/">AWS AppSync</a><ul class="nav flex-column"><li class="nav-item"><a class="nav-link active"href="/aws-appsync/api-configuration/">API configuration</a><ul class="nav flex-column"><li class="nav-item"><a class="nav-link"href="/aws-appsync/api-configuration/authorization-providers/">Authorization providers</a><li class="nav-item"><a class="nav-link"href="/aws-appsync/api-configuration/logging-and-monitoring/">Logging and monitoring</a><li class="nav-item"><a class="nav-link"href="/aws-appsync/api-configuration/custom-domains/">Custom domains</a><li class="nav-item"><a class="nav-link active"href="/aws-appsync/api-configuration/waf/">WAF</a></ul><li class="nav-item"><a class="nav-link"href="/aws-appsync/data-sources/">Data sources</a><ul class="nav flex-column"><li class="nav-item"><a class="nav-link"href="/aws-appsync/data-sources/lambda-1/">Lambda</a><li class="nav-item"><a class="nav-link"href="/aws-appsync/data-sources/dynamodb/">DynamoDB</a><li class="nav-item"><span class="nav-link">HTTP ðŸš§</span><li class="nav-item"><span class="nav-link">RDS ðŸš§</span><li class="nav-item"><span class="nav-link">None ðŸš§</span></ul><li class="nav-item"><span class="nav-link">Resolvers ðŸš§</span><li class="nav-item"><span class="nav-link">Authorization ðŸš§</span><li class="nav-item"><span class="nav-link">Error handling ðŸš§</span><li class="nav-item"><span class="nav-link">Real-time data with subscriptions ðŸš§</span></ul><li class="nav-item"><span class="nav-link">Infrastructure-as-code ðŸš§</span><ul class="nav flex-column"><li class="nav-item"><span class="nav-link">Terraform ðŸš§</span><li class="nav-item"><span class="nav-link">CDK ðŸš§</span><li class="nav-item"><span class="nav-link">Amplify ðŸš§</span></ul><li class="nav-item"><span class="nav-link">Example application ðŸš§</span><li class="nav-item"><a class="nav-link"href="/glossary/">Glossary</a><li class="nav-item"><a class="nav-link"href="/about-the-author/">About the author</a><li class="nav-item"><a class="nav-link"href="/changelog/">Changelog</a><li class="nav-item"><a class="nav-link"href="/copyright/">Copyright</a></ul><div class="flex-grow-1 main container-fluid"><div class="row"><div class="col-lg-9 body p-3"><div class="d-lg-none mb-4"><div class="accordion"id="accordionExample"><div class="accordion-item"><h2 class="accordion-header"id="mobile-toc-header"><button class="accordion-button collapsed"type="button"data-bs-toggle="collapse"data-bs-target="#mobile-toc"aria-expanded="true"aria-controls="mobile-toc">In this chapter</button></h2><div id="mobile-toc"class="accordion-collapse collapse"aria-labelledby="mobile-toc-header"data-bs-parent="#accordionExample"><div class="accordion-body"><div class="toc-container"><a style="margin-left: 0em"href="#waf">WAF</a> <a style="margin-left: 1em"href="#disable-introspection-queries">Disable introspection queries</a> <a style="margin-left: 1em"href="#rate-limiting">Rate limiting</a> <a style="margin-left: 1em"href="#geo-filter">Geo filter</a> <a style="margin-left: 1em"href="#ip-filter">IP filter</a></div></div></div></div></div></div><h3 id="waf">WAF</h3><p>WAF is AWS's managed firewall solution. It is a separate service compatible with several API services. Its main function is to deny or allow requests based on <strong>rules</strong> and to give visibility into the requests that are sent to the protected API.<figure class="plantuml image"><svg xmlns="http://www.w3.org/2000/svg"xmlns:xlink="http://www.w3.org/1999/xlink"height="325"preserveAspectRatio="none"style="width:477px;height:325px;background:#fff"viewBox="0 0 477 325"width="477"><path fill="#FFF"style="stroke:#00000000;stroke-width:1.5;fill:#fff"d="M339 7h132v118.922H339z"></path><image height="64"width="64"x="373"xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAIAAAAlC+aJAAADOUlEQVR4Xu2ZsWocMRCG/cB5g7xBnsC1m1Rp4zpFOneGdALbXGE4MOTgCoNh87M/OyialTSzq4tyIPFj1ruz0nwjzUhe34RPt1etG33rujQAemsA9NYA6K0B0FsDoLcaAzx/vjt+/XF+fHp/OX78Pk9zwwWEm2/fH15v7/Vbe9QGgH6Lx3QaDHCaMJA8Qjv9/HX48k33s0ENABBXcRqeIcbg0WYQnIaxwMBY23i1CwAOMerwCTOgDXLCi5gZ1ys5bQeQwDfxY7M2AtB7BD63Wv6ZtgBg7cJ7rIHu3ocNAFgw9F4/2inWX8ytq0D5ANA1q80lYh9XYcbIAuMDYAWsdkqxYkK40E8TMTRssIf3cq2NYzkAuHiqPVL0gHsww6ltYsnKnKKyBqrqVDsA6E21x7CEU/YpJn153ug6Ouco2iAnKwD2V3v4GU7xmDzl7YJHD3nXfmSyAjCKlvAHRctNo+ATupUZi68tsgJM87al7+fEdOdhrvounI4LDk+y2mxVJgCuAeP6oThj0lzvcsbKOSMyAXBJFNZAIgJL1L156RrOBOAKSVhKitgzL8tJHMs14SYArgd9f1WMX5yFLI7lNEiU9FBQewCmb1KvqoUoUTeA3G7N4mifhMYAjF9hEzjMfytiyMJuzSjg52n+s1MbxGoMUN4d+VRa7tiTmBX843TpaVyVCaBwFuBgiDoPXqw/GnXVLFfWWAZWh9MyAXB4CS1+lbGTwYiaa4lZLsauqm0CCEtp53U8QOIKed6XL0KxtFkuxqxj+v6qrABxGsQwYRkPzh2Xb1urScxHVbNLHebiOjj9namYBDKw6QQQM/o9zcmQMysXDK0KQBwk1kGuH7184R8TVHfiMvMenCoAjMd5+S4rYTZmmFfeU1OoAsBprvikacv9klKrHxVUARAd5r2WMPYMc4mJZF/9lBXg0pIE04/K+i8AOLFxZbOrM4AcK7Z5H/oCyPFuT1I1AEDanZz/MsIrTNnCjmZUAwDmH5cBgpojwWohquzHuC7saEY1AAhzkU22i/g8x+888gjXqDb7XafaAFASYzideEyeN8Pncq9aAnTRAOitAdBbA6C3BkBvDYDeunqAPxdjffOs6ZOIAAAAAElFTkSuQmCC"y="17"></image><text font-family="sans-serif"font-size="16"font-weight="bold"textLength="112"x="349"y="112.148">AppSync API</text><path fill="#FFF"style="stroke:#00000000;stroke-width:1.5;fill:#fff"d="M187 7h84v118.922h-84z"></path><image height="64"width="64"x="197"xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAIAAAAlC+aJAAAD6ElEQVR4Xu2aTWobQRCFfeGsss0m6yyyziL7QPaBHCDkAskFkgaDEBgHjMBgxo95qCj165/q0ZiJYcTDSK2aVn3VVdUtjW/Sm7evWjc69Lq0A2ytHWBr7QBbawdo6vjpM6TjK6oD8O/b99Ov3zoe1OOfv5COr6gOALyfpmmU4fDhIwJ/9+Xr0/09hCd4iUG1vF4dgBRmuH33Ho7SuPGAAcxgrDNks+lgUX2A1GNAaB9+/PQuIvEYda4AV4PZaGa4pLYmnK32bqYQQKowIE7mOt7Sei3WAMyMBJdnweaEtWCpogCpxADnMIK/tWhhvPGWXW6Do96nIYAkDHACuaFmceFyI1zgfRoFSMKwlpZ5nxYApB4DKzjeRtIV3qdlAKnOAL9ZnVOpQGu6ZrscAIA3vl5rDGgyxoAHnNOpamJlB7GpAQAutO+VZMB4ZslxuE6GuE/IveKEDUUBEJupFG98mLZ/LgI3r1EGwtearyoK0N0dud2alxZI7MRkUPiiGKn4IoQAWJptD8xR7gx4SXsuAuMa3DRoHFyxEACd0FTx4hIRg6lMAEsnnov0QhUvCVZ/CIAh0XEvOs0DHJeCacCUsHqAQSS0xt9VCCAynUXatgKuWDYODBB2azoSMqoPwBB2F9SbwV1z0VYmzYXBA9x0eYZTcbkaPcPUB2AI2wWQXKpk46wNwnjv23MGPzRFABjCbjCKMWPaWLANoNvWauFQtQAQAHwki/Jx/mrSwCg2GZ8/tJnOxc2ZdR6eJojKlGuvwzoAdFQDllHxJdOpVqZrAlCRFOLnZYNa/XDdmk8NwF+rEVH1ASL1VExoX74q2BdTiIp8KNUH0ECqigDMBDWmmB46ThVbQlF9gFTxz6voTeMqdqHGia2dYF4hgO50evxqu5h1J1UDPlMIoHuYY8p6d+3goMZ4y7cjFWcrXqsKAXT3nXReBOsbtRXAeGap0vVsKASQApMyruSkmTKzxxfB/Dx6YUNRAPai9rwWXSaA38WO7udEiz0GlYRmkf5DRQFS6Ut9URZmPvxzOOc944Q+KFpLXQ0A3F7+rNIWzBjLp/m7Jb8PqBltjIHwRcuaBgC8EKRGFQ4pYxjVEgBd+it1DcMwwOreU4sZxgAy7w/zvTA1i+vo7p0tYxgA0Nizw5zOjV91qN/gsJ7rD1ELGKIA6n2aneA439LVKB5I/Z7wIL9gjzKEANq7mHVMI7k731flXsZMu7u8h3m63BO8hhhCAGn2Uge9EEjsvn7bKj5gALNaypniDFGAITHkdprAE1+sQQUZXgTAVKyBuE7zLWcd93pZgOPm/+zx/2sH2Fo7wNbaAbbWDrC1ngH3I19zON4nRAAAAABJRU5ErkJggg=="y="17"></image><text font-family="sans-serif"font-size="16"font-weight="bold"textLength="40"x="209"y="112.148">WAF</text><path fill="#FFF"style="stroke:#00000000;stroke-width:1.5;fill:#fff"d="M127 201h84v118.922h-84z"></path><image height="64"width="64"x="137"xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAIAAAAlC+aJAAACAklEQVR4Xu2asUoDQRCG86ZWlla2NtYW1hb2gr3gA4S8gD5AVBAkIBFCICDjz60Om51x75q7mTn2Z5rbPdjvS3Yvu0kWFDyLsiFafgW+t9vdchWoAHwksH96Xp+cBioAz1Tg8+5evl9+Cng9AtzhM5KzCUwbyelXAA9KzPiiUXI6FQD929k5eD6urvN2yelRgOlR7xeXeZfktBfAPOGPVarSk8ZpLPD18IhBQZzGrdOTxmksAMo0Lmpzc1unJ43TWIC6KcQOdXrSOO0FqBu997VPkZwuBFLwxKzTk8bpSGBIJGcTmDaSsxTARMTjzG0Br0cgSs1XIPwaaALjRnI2gdGy7zZI+VEhNcYQYB44qO2uBRgGhROP2uVIADvQ3XLFlxX6vNeLAG8NsE2gPvr8Bi8C+XGMzzT/0ZPGaSyAHF5ec/QKPWmc9gIpmEK99KRxehFAsJTr9KRxOhIYEsnZBKaN5CwFotR8BcIf6sOvgSYwbiSnvQDOXNhRb7rdKAeXaCyOY6Rx2gvwbxzssPnbF8kvqyWnvQB2o2no5MD0KHQVN0tOewE6dqjQk8bpQoCEg0pPGqcXgXzmrLP1UERyuhAo6CsOktNeoFi1xZoubpac9gI4iDF9amGH/OuWFMlpL0CdQ7FqcSnpSeN0ITA8knN2AuH/9BelZicQ/q/HcRNe4AclBpC0J8ocegAAAABJRU5ErkJggg=="y="211"></image><text font-family="sans-serif"font-size="16"font-weight="bold"textLength="49"x="144.5"y="306.148">Rule1</text><path fill="#FFF"style="stroke:#00000000;stroke-width:1.5;fill:#fff"d="M246 201h84v118.922h-84z"></path><image height="64"width="64"x="256"xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAIAAAAlC+aJAAACAklEQVR4Xu2asUoDQRCG86ZWlla2NtYW1hb2gr3gA4S8gD5AVBAkIBFCICDjz60Om51x75q7mTn2Z5rbPdjvS3Yvu0kWFDyLsiFafgW+t9vdchWoAHwksH96Xp+cBioAz1Tg8+5evl9+Cng9AtzhM5KzCUwbyelXAA9KzPiiUXI6FQD929k5eD6urvN2yelRgOlR7xeXeZfktBfAPOGPVarSk8ZpLPD18IhBQZzGrdOTxmksAMo0Lmpzc1unJ43TWIC6KcQOdXrSOO0FqBu997VPkZwuBFLwxKzTk8bpSGBIJGcTmDaSsxTARMTjzG0Br0cgSs1XIPwaaALjRnI2gdGy7zZI+VEhNcYQYB44qO2uBRgGhROP2uVIADvQ3XLFlxX6vNeLAG8NsE2gPvr8Bi8C+XGMzzT/0ZPGaSyAHF5ec/QKPWmc9gIpmEK99KRxehFAsJTr9KRxOhIYEsnZBKaN5CwFotR8BcIf6sOvgSYwbiSnvQDOXNhRb7rdKAeXaCyOY6Rx2gvwbxzssPnbF8kvqyWnvQB2o2no5MD0KHQVN0tOewE6dqjQk8bpQoCEg0pPGqcXgXzmrLP1UERyuhAo6CsOktNeoFi1xZoubpac9gI4iDF9amGH/OuWFMlpL0CdQ7FqcSnpSeN0ITA8knN2AuH/9BelZicQ/q/HcRNe4AclBpC0J8ocegAAAABJRU5ErkJggg=="y="211"></image><text font-family="sans-serif"font-size="16"font-weight="bold"textLength="49"x="263.5"y="306.148">Rule2</text><path fill="#FFF"style="stroke:#00000000;stroke-width:1.5;fill:#fff"d="M7 7h84v118.922H7z"></path><image height="64"width="64"x="17"xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAIAAAAlC+aJAAAEyklEQVR4XtVaLY8UQRC9v7YasRYMjqAwJCgEAnfBIM/gCAaFQGBQmyBwl5BgLwS/8AOal62btzXVNdXVPZML91Ihd9MzXf3qq6v7uCj3HBf2wX3DCIGbX78P375f//h5/PPXjvUDk2AqmdCOJdBBADqevXi1e/BQy+Onz6/evR9ggk8+fPyEz82EUPH5y1f79jJSBGDyeula9o+edGmFLfBJPQ8FxKDUfuahTQCepTL88PL1G1gOK8CKYXttQvxqP/aAz/VCL99eYSqZEJNrXZmgahCAGTgjZndDBYr5DhZnh+fAy1yf+zJUgBLfafqhQYCRE1uXXopVYnF8LbYuvYQF2LE5IgLQQdvbsQqIAXkZ9rNjE2jaTMJAqbyMme2YQkSA+gKjaoi7YF07MEHM3zSqAO7KmC8i0KWvqPh2bUZ/uqHvommREhMQfUFIGHCJboSQXhz9Gkg8+cQtHoJFAvRgnL4aiLTAxiSQDMiiUjn4ZJFAmUJoKw8wy90Ac0EP2AGFiIBsUvjXDiyABnODhP7Ju1QWMJ4DNIC7oBpNfV0WoT/jEIgI0GYZlTR/YODMOwT30CABSkygKCfExZgJCqpBxSiTE3YLiU5wF4vNX5oEilKJH+r8g3m43+0SwaZbQ6yyti5UaI1mtEabACyqe+n9qSHFoiG6FcXzmp4LzUFWKbNB9HMojZ0paBMolUpXMmFNMDKXpNntEQ0CcDHDsSmwpbsDaOAF7bdYoLpJIyKAPDO+huUQJ2AF58pZ1pxCRKvrejzUtpBQhApMIhPenI7aeGJOf7FvFwloZW62acgBlzRclQwbvHbVOkYbzwc10CfAj/OpWaZ0D5RhKJmaAp17S02xQ4BlsVnU7wBYAHPG3RMsgfyW1ATCACaUELdjPdAc6iIxI3BUZ9ZhrbK1mbKLX/FwzZxcmDHrjADzLN7nA+hd2RU3DDJY6qNmBIRlZgN3ocsffpaaW1fGrjzWkEDaz7vdMwFG/5j5Wbigxt198JChvFRSYnCFOhPOBLiCAfNw6qZ16YoBMx29e4ozAYmfMdssZVgNXSfsWAL1PcUtAZIbSDIedpNGZTrmt0iCZYaWuiXAwxcISObFoqO8njSGa6zr058ImsIqxwXcErieDqBJ0bolebpCQrJZh2uz/hqxBOiBpGgCEpddxVc+WUOAe+I5iaWbTYoOIdHd5QHJY11MkiEkond02wsNgDmQ7BTobbfr7sUGBJg/yQpGwu5+14sNCBS1PTXXxLasK2cCbEOATtiHbSyG2E0c+jcBF9sQKPMTo7ujNc+cY9iMQJlflmCtiKvL022POfVvuPqyLYHj/ArMlfUHPYPNCMCu2syB7BO3EnlsQEA3+rI+aaiuT/+Z4jhd+BiG+577jgBrCfAksMvdzB3U3e0u3cAGWEWAjfGuMzV1uq/kME7gMB0DxoLhoP6/x8DnxCABHqzWqNcmGM7pQQLsflcGAIMwuJCMMUKAjcPYAdqAW0fQgwQYIVCf69agt5k16CbA6N/E/IL6riGPbgLMvGbJz4ObyUA96CbQeweRAe8pujYTQTeBNe4OUN9TJNFNQDQ9Pv3NeEPhtFZfC90Eki3nmAw4tpuAbsU2l7vwABKuDoCtZKAwdBP433DvCfwDWYFEOt5YljYAAAAASUVORK5CYII="y="17"></image><text font-family="sans-serif"font-size="16"font-weight="bold"textLength="51"x="23.5"y="112.148">Users</text><path d="M91.2 66.5h90.4"fill="none"style="stroke:#666;stroke-width:1;fill:none"></path><path fill="#666"style="stroke:#666;stroke-width:1;fill:#666"d="m186.75 66.5-9-4 4 4-4 4 9-4z"></path><text fill="#666"font-family="sans-serif"font-size="12"textLength="59"x="109.5"y="60.639">Requests</text><path d="M210.67 126.15c-6.89 22.04-14.75 47.2-21.77 69.68"fill="none"style="stroke:#666;stroke-width:1;fill:none"></path><path fill="#666"style="stroke:#666;stroke-width:1;fill:#666"d="m187.32 200.88 6.515-7.386-5.016 2.616-2.616-5.015 1.117 9.785z"></path><text fill="#666"font-family="sans-serif"font-size="12"textLength="24"x="202"y="168.139">Run</text><path d="M247.02 126.15c6.78 22.04 14.51 47.2 21.41 69.68"fill="none"style="stroke:#666;stroke-width:1;fill:none"></path><path fill="#666"style="stroke:#666;stroke-width:1;fill:#666"d="m269.99 200.88 1.205-9.775-2.661 4.992-4.992-2.662 6.448 7.445z"></path><text fill="#666"font-family="sans-serif"font-size="12"textLength="24"x="261"y="168.139">Run</text><path d="M271.16 66.5h62.55"fill="none"style="stroke:#666;stroke-width:1;fill:none"></path><path fill="#666"style="stroke:#666;stroke-width:1;fill:#666"d="m338.79 66.5-9-4 4 4-4 4 9-4z"></path><text fill="#666"font-family="sans-serif"font-size="12"textLength="31"x="289.5"y="60.639">Allow</text></svg><figcaption class="caption">WAF allows/denies requests to the AppSync API based on rules</figcaption></figure><p>The rules have access to the request headers, the body, the IP address, and they can also implement per-IP rate limiting. Also, statements in rules can be combined with AND/OR logic and they can either allow (if they don't match the request is denied) or block (if they don't match the request is allowed) functionality.<p>These rules are managed outside AppSync and you need to associate them with your API after you've configured them. You can define what ACL is effective for an API on the AppSync console:<figure class="image prevp"><img srcset="/assets/iwmAd2FmX2Fzc29jaWF0ZUAzLnBuZyUD.ce781a6489c452c6f705a94e4c94e47fa8245add.png 3x, /assets/iwyAd2FmX2Fzc29jaWF0ZUAzLnBuZyV3LTEyMjID.129030d155bf4fbaaf7e69d11a8533a6c4a5f842.png, /assets/iwyAd2FmX2Fzc29jaWF0ZUAzLnBuZyV3LTE4MzQD.101b6323a69d22ba0450a06260dd95e489a00a3b.png 1.5x"title="Associate the WAF to the AppSync API"><figcaption class="caption">Associate the WAF to the AppSync API</figcaption></figure><p>In this chapter, we'll see a couple of use-cases that you can implement using WAF.<div class="floatbox floatbox-center"><div class="tcolorbox tcolorbox-info"><div class="tbox-header">Note</div><div class="tbox-body"><p>WAF comes with monthly prices as well as per-request prices. This means you'll have costs even if there are no requests to your API.</div></div></div><h4 id="disable-introspection-queries">Disable introspection queries</h4><p>GraphQL defines special queries that are used to get information about the schema called <a href="https://graphql.org/learn/introspection/">introspection</a>. AppSync implements this functionality and allows reconstructing the schema.<p>For example, AppSync can return the types defined in the schema:<pre class="highlight prevp"><code><span class="hljs-keyword">query</span><span class="hljs-literal"> MyQuery</span> {
  __schema {
    types {
      name
    }
  }
}</code></pre><p>This returns a list:<pre class="highlight prevp"><code><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"data"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"__schema"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"types"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Query"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"User"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ID"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        ...
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span></code></pre><p>While introspection queries are protected by the authorization mechanism defined for the API (so there is no anonymous access to them), if you don't need them then it might be a good idea to disable them. Note that it does not provide a real security benefit: the schema isn't a secret, and there might be other ways to extract it from the API.<p>For a simple solution, you can add a rule that matches requests with the <code>__schema</code> string:<pre class="highlight prevp"><code><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"ByteMatchStatement"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"FieldToMatch"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"Body"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"PositionalConstraint"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"CONTAINS"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"SearchString"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"__schema"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"TextTransformations"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"Type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"NONE"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"Priority"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span></code></pre><p>Visually:<figure class="image prevp"><img srcset="/assets/iw6Ad2FmX2Jsb2NrX2ludHJvc3BlY3Rpb25AMy5wbmclAw.ad77c962eefb13592009e0c53e55ed2ae335ca75.png 3x, /assets/CxGAd2FmX2Jsb2NrX2ludHJvc3BlY3Rpb25AMy5wbmcldy03ODED.c5b14d1b8c1bef61508ecc771bcb9cea0cce9967.png, /assets/ixGAd2FmX2Jsb2NrX2ludHJvc3BlY3Rpb25AMy5wbmcldy0xMTcyAw.3587656865af882a0df58d91684c7ac5ec928f04.png 1.5x"title="A statement that denies introspection queries"><figcaption class="caption">A statement that denies introspection queries</figcaption></figure><p>Notice the warning: if the <code>__schema</code> does not appear in the first 8192 bytes of the request, WAF gives up and won't search further. To make it harder to evade this rule, add a second one that matches requests larger than this limit:<pre class="highlight prevp"><code><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"SizeConstraintStatement"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"FieldToMatch"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"Body"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ComparisonOperator"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"GT"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"Size"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">8192</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"TextTransformations"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"Type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"NONE"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"Priority"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span></code></pre><p>Visually:<figure class="image prevp"><img srcset="/assets/Gx4AyIyUbt5EORN2118lQGZhIgfutQUHfZpast-JIJObCAE.257d05aaf5b88028c2e84562b40ecb432064e020.png 3x, /assets/ixGAd2FmX2Jsb2NrX2xhcmdlX3JlcXVlc3RzQDMucG5nJXctNzg0Aw.3078512df7f911092b7fbe1c5467c74fcc5ba8e6.png, /assets/CxKAd2FmX2Jsb2NrX2xhcmdlX3JlcXVlc3RzQDMucG5nJXctMTE3NgM.cdfe8f64b6f0032dede7dea6618c5228ae6710f9.png 1.5x"title="A statement that denies requests larger than 8129 bytes"><figcaption class="caption">A statement that denies requests larger than 8129 bytes</figcaption></figure><p>When associated with the API, WAF sends a 403 response without calling the API:<figure class="image prevp"><img srcset="/assets/iwmAd2FmX2ZvcmJpZGRlbkAyLnBuZyUD.595fe7a29d632346d6324bd7f313db53b864615d.png 2x, /assets/CwyAd2FmX2ZvcmJpZGRlbkAyLnBuZyV3LTk2MAM.4c3d2e37c61710befa3f91e71df053417a4cc747.png, /assets/iwyAd2FmX2ZvcmJpZGRlbkAyLnBuZyV3LTE0NDAD.22e4f090cdf9223f45622387fb28ee6a70bb1fb8.png 1.5x"title="An introspection query is blocked by WAF"><figcaption class="caption">An introspection query is blocked by WAF</figcaption></figure><div class="floatbox floatbox-center"><div class="tcolorbox tcolorbox-info"><div class="tbox-header">Note</div><div class="tbox-body"><p>Disabling introspection queries is useful in some cases, especially when you don't need it, but the above rule only provides a sense of security. For example, it does not disable all types of introspection, such as the <code>__type</code> query.</div></div></div><h4 id="rate-limiting">Rate limiting</h4><p>WAF also allows rate limiting per originating IP address. This helps blocking enumeration and DoS attacks, as well as limit the cost for a misconfigured client. On the other hand, its rate limiting is per-IP, which means if the attack is distributed across many addresses, WAF still won't block that.<p>Rate limiting is implemented using a 5-minute sliding window and requests are blocked if the amount reaches the configured threshold.<figure class="image"><img srcset="/assets/CwqAd2FmX3JhdGVfbGltaXRAMy5wbmclAw.59017792b4c9caccb463057ac08cdd4b84b612b5.png 3x, /assets/iwyAd2FmX3JhdGVfbGltaXRAMy5wbmcldy04MTQD.e739f536100fd5c4371872465e7355ea72fd34ac.png, /assets/Cw2Ad2FmX3JhdGVfbGltaXRAMy5wbmcldy0xMjIyAw.247c6ba1e56a4646d9ae841b11df66f8f2802483.png 1.5x"title="A WAF rule can implement rate limiting per IP address"><figcaption class="caption">A WAF rule can implement rate limiting per IP address</figcaption></figure><p>With a selection rule, you can also define more complex configuration. For example, you can rate limit requests from specific countries, or disable limiting for the company IP address range.<div class="floatbox floatbox-center"><div class="tcolorbox tcolorbox-info"><div class="tbox-header">Note</div><div class="tbox-body"><p>Rate limiting is per-IP address, so it won't help much against a distributed attack.</div></div></div><h4 id="geo-filter">Geo filter</h4><p>A rule can also target countries. With this selection filter, you can deny requests from matching countries, or do the opposite and define an allowlist of countries that can reach the API. This is especially useful if all your users are in a well-defined geographical region.<figure class="image"><img srcset="/assets/CwmAd2FmX2lwX2Jsb2NrQDMucG5nJQM.d6e538f501088059809c872265412f00080c88ff.png 3x, /assets/iwuAd2FmX2lwX2Jsb2NrQDMucG5nJXctODE0Aw.dda1e3c80c742d60c742603717e8bce5421d7c99.png, /assets/CwyAd2FmX2lwX2Jsb2NrQDMucG5nJXctMTIyMgM.762743927ae837cdda038886a4423e4594098ea6.png 1.5x"title="A rule can use the country of the caller"><figcaption class="caption">A rule can use the country of the caller</figcaption></figure><div class="floatbox floatbox-center"><div class="tcolorbox tcolorbox-info"><div class="tbox-header">Note</div><div class="tbox-body"><p>VPNs can circumvent this limitation.</div></div></div><h4 id="ip-filter">IP filter</h4><p>Similar to the geo filter, you can add individual IP addressess and CIDR blocks and define a rule based on this list. This is especially useful when you have dedicated addresses and want to allow traffic only from there. For example, a company might have a fixed IP and an IP filter can allow only requests from that IP.<figure class="image"><img srcset="/assets/iwiAd2FmX2lwX2xpc3RAMy5wbmclAw.ea96ef9ef7ec6798d35af059c79c56fc3cd649ab.png 3x, /assets/CwuAd2FmX2lwX2xpc3RAMy5wbmcldy04MTcD.e9864255e5604cc82d6ddf9ca142320807e3c2c8.png, /assets/iwuAd2FmX2lwX2xpc3RAMy5wbmcldy0xMjI2Aw.fcf0acf5448fbdb3e56fbf59b208bfcbbc92ed00.png 1.5x"title="A rule can use an IP address set"><figcaption class="caption">A rule can use an IP address set</figcaption></figure><p>With rule combinations, you can also implement more complex scenarios. For example, you can block all requests containing the <code>admin</code> string in the body that are not from the company IP address.<div class="tcolorbox tcolorbox-secondary my-5"><div class="tbox-header fw-bold">Master AppSync and GraphQL</div><div class="tbox-body"><div>Support this book and get all future updates and extra chapters in ebook format.</div><div class="d-flex justify-content-center"><a role="button"href="https://tsallai.gumroad.com/l/graphql-on-aws-appsync-book"class="btn btn-primary not-styled mt-3 text-white">Buy the book</a></div></div></div><div class="pagination row"><div class="col-6"><a href="/aws-appsync/api-configuration/custom-domains/"class="border rounded d-block p-3"><div class="pagination-sublabel text-muted small">Previous</div><div class="pagination-title">&lt; Custom domains</div></a></div><div class="col-6"><a href="/aws-appsync/data-sources/"class="border rounded d-block p-3 text-end ms-auto"><div class="pagination-sublabel text-muted small">Next</div><div class="pagination-title">Data sources &gt;</div></a></div></div><footer>Â© TamÃ¡s Sallai - <a href="https://advancedweb.hu">advancedweb.hu</a></footer></div><div class="col-lg-3 d-none d-lg-block"><div class="toc-container"><a style="margin-left: 0em"href="#waf">WAF</a> <a style="margin-left: 1em"href="#disable-introspection-queries">Disable introspection queries</a> <a style="margin-left: 1em"href="#rate-limiting">Rate limiting</a> <a style="margin-left: 1em"href="#geo-filter">Geo filter</a> <a style="margin-left: 1em"href="#ip-filter">IP filter</a></div></div></div></div></div><script src="/assets/main.077454cb0bffe3695e9176b1b5f8a7fd9676d920.js"></script>