<!doctypehtml><html lang="en"><meta charset="utf-8"><link rel="icon"type="image/svg+xml"href="/assets/favicon.15621087ab873d484cfdc234ae6d4f0559d2ece6.svg"><meta name="viewport"content="width=device-width,initial-scale=1"><link href="/assets/main.d3c4fd66da45b5fe1b587fd7bc4b64cc7a34bcf3.css"rel="stylesheet"><title>DynamoDB - Data sources - Building GraphQL APIs with AWS AppSync</title><nav class="navbar navbar-light"><div class="container-fluid flex-nowrap"><a class="navbar-brand"href="/">Building GraphQL APIs with AWS AppSync</a> <button class="navbar-toggler d-lg-none align-self-start"type="button"data-bs-toggle="offcanvas"data-bs-target="#offcanvasNavbar"aria-controls="offcanvasNavbar"><span class="navbar-toggler-icon"></span></button><div class="offcanvas offcanvas-end"tabindex="-1"id="offcanvasNavbar"aria-labelledby="offcanvasNavbarLabel"><div class="offcanvas-header"><h5 class="offcanvas-title"id="offcanvasNavbarLabel">Building GraphQL APIs with AWS AppSync</h5><button type="button"class="btn-close text-reset"data-bs-dismiss="offcanvas"aria-label="Close"></button></div><div class="offcanvas-body keep-scrolltop"><ul class="nav navbar-nav justify-content-end flex-grow-1 pe-3"><li class="nav-item"><a class="nav-link"href="/introduction/">Introduction</a><li class="nav-item"><a class="nav-link"href="/graphql-basics/">GraphQL basics</a><ul class="nav flex-column"><li class="nav-item"><a class="nav-link"href="/graphql-basics/graphql-vs-rest/">GraphQL vs REST</a><li class="nav-item"><a class="nav-link"href="/graphql-basics/schema/">Schema</a><li class="nav-item"><a class="nav-link"href="/graphql-basics/queries-and-mutations/">Queries and Mutations</a><li class="nav-item"><a class="nav-link"href="/graphql-basics/resolvers/">Resolvers</a><li class="nav-item"><a class="nav-link"href="/graphql-basics/access-control/">Access control</a></ul><li class="nav-item"><a class="nav-link active"href="/aws-appsync/">AWS AppSync</a><ul class="nav flex-column"><li class="nav-item"><a class="nav-link"href="/aws-appsync/api-configuration/">API configuration</a><ul class="nav flex-column"><li class="nav-item"><a class="nav-link"href="/aws-appsync/api-configuration/authorization-providers/">Authorization providers</a><li class="nav-item"><a class="nav-link"href="/aws-appsync/api-configuration/logging-and-monitoring/">Logging and monitoring</a><li class="nav-item"><a class="nav-link"href="/aws-appsync/api-configuration/custom-domains/">Custom domains</a><li class="nav-item"><a class="nav-link"href="/aws-appsync/api-configuration/waf/">WAF</a></ul><li class="nav-item"><a class="nav-link active"href="/aws-appsync/data-sources/">Data sources</a><ul class="nav flex-column"><li class="nav-item"><a class="nav-link"href="/aws-appsync/data-sources/lambda-1/">Lambda</a><li class="nav-item"><a class="nav-link active"href="/aws-appsync/data-sources/dynamodb/">DynamoDB</a><li class="nav-item"><span class="nav-link">HTTP ðŸš§</span><li class="nav-item"><span class="nav-link">RDS ðŸš§</span><li class="nav-item"><span class="nav-link">None ðŸš§</span></ul><li class="nav-item"><span class="nav-link">Resolvers ðŸš§</span><li class="nav-item"><span class="nav-link">Authorization ðŸš§</span><li class="nav-item"><span class="nav-link">Error handling ðŸš§</span><li class="nav-item"><span class="nav-link">Real-time data with subscriptions ðŸš§</span></ul><li class="nav-item"><span class="nav-link">Infrastructure-as-code ðŸš§</span><ul class="nav flex-column"><li class="nav-item"><span class="nav-link">Terraform ðŸš§</span><li class="nav-item"><span class="nav-link">CDK ðŸš§</span><li class="nav-item"><span class="nav-link">Amplify ðŸš§</span></ul><li class="nav-item"><span class="nav-link">Example application ðŸš§</span><li class="nav-item"><a class="nav-link"href="/glossary/">Glossary</a><li class="nav-item"><a class="nav-link"href="/about-the-author/">About the author</a><li class="nav-item"><a class="nav-link"href="/changelog/">Changelog</a><li class="nav-item"><a class="nav-link"href="/copyright/">Copyright</a></ul></div></div></div></nav><div class="d-flex flex-row"><ul class="nav flex-column navigation flex-shrink-0 flex-nowrap overflow-auto d-none d-lg-flex keep-scrolltop"><li class="nav-item"><a class="nav-link"href="/introduction/">Introduction</a><li class="nav-item"><a class="nav-link"href="/graphql-basics/">GraphQL basics</a><ul class="nav flex-column"><li class="nav-item"><a class="nav-link"href="/graphql-basics/graphql-vs-rest/">GraphQL vs REST</a><li class="nav-item"><a class="nav-link"href="/graphql-basics/schema/">Schema</a><li class="nav-item"><a class="nav-link"href="/graphql-basics/queries-and-mutations/">Queries and Mutations</a><li class="nav-item"><a class="nav-link"href="/graphql-basics/resolvers/">Resolvers</a><li class="nav-item"><a class="nav-link"href="/graphql-basics/access-control/">Access control</a></ul><li class="nav-item"><a class="nav-link active"href="/aws-appsync/">AWS AppSync</a><ul class="nav flex-column"><li class="nav-item"><a class="nav-link"href="/aws-appsync/api-configuration/">API configuration</a><ul class="nav flex-column"><li class="nav-item"><a class="nav-link"href="/aws-appsync/api-configuration/authorization-providers/">Authorization providers</a><li class="nav-item"><a class="nav-link"href="/aws-appsync/api-configuration/logging-and-monitoring/">Logging and monitoring</a><li class="nav-item"><a class="nav-link"href="/aws-appsync/api-configuration/custom-domains/">Custom domains</a><li class="nav-item"><a class="nav-link"href="/aws-appsync/api-configuration/waf/">WAF</a></ul><li class="nav-item"><a class="nav-link active"href="/aws-appsync/data-sources/">Data sources</a><ul class="nav flex-column"><li class="nav-item"><a class="nav-link"href="/aws-appsync/data-sources/lambda-1/">Lambda</a><li class="nav-item"><a class="nav-link active"href="/aws-appsync/data-sources/dynamodb/">DynamoDB</a><li class="nav-item"><span class="nav-link">HTTP ðŸš§</span><li class="nav-item"><span class="nav-link">RDS ðŸš§</span><li class="nav-item"><span class="nav-link">None ðŸš§</span></ul><li class="nav-item"><span class="nav-link">Resolvers ðŸš§</span><li class="nav-item"><span class="nav-link">Authorization ðŸš§</span><li class="nav-item"><span class="nav-link">Error handling ðŸš§</span><li class="nav-item"><span class="nav-link">Real-time data with subscriptions ðŸš§</span></ul><li class="nav-item"><span class="nav-link">Infrastructure-as-code ðŸš§</span><ul class="nav flex-column"><li class="nav-item"><span class="nav-link">Terraform ðŸš§</span><li class="nav-item"><span class="nav-link">CDK ðŸš§</span><li class="nav-item"><span class="nav-link">Amplify ðŸš§</span></ul><li class="nav-item"><span class="nav-link">Example application ðŸš§</span><li class="nav-item"><a class="nav-link"href="/glossary/">Glossary</a><li class="nav-item"><a class="nav-link"href="/about-the-author/">About the author</a><li class="nav-item"><a class="nav-link"href="/changelog/">Changelog</a><li class="nav-item"><a class="nav-link"href="/copyright/">Copyright</a></ul><div class="flex-grow-1 main container-fluid"><div class="row"><div class="col-lg-9 body p-3"><div class="d-lg-none mb-4"><div class="accordion"id="accordionExample"><div class="accordion-item"><h2 class="accordion-header"id="mobile-toc-header"><button class="accordion-button collapsed"type="button"data-bs-toggle="collapse"data-bs-target="#mobile-toc"aria-expanded="true"aria-controls="mobile-toc">In this chapter</button></h2><div id="mobile-toc"class="accordion-collapse collapse"aria-labelledby="mobile-toc-header"data-bs-parent="#accordionExample"><div class="accordion-body"><div class="toc-container"><a style="margin-left: 0em"href="#dynamodb">DynamoDB</a> <a style="margin-left: 1em"href="#configuring-the-data-source-1">Configuring the data source</a> <a style="margin-left: 1em"href="#operations">Operations</a> <a style="margin-left: 2em"href="#getting-elements">Getting elements</a> <a style="margin-left: 2em"href="#running-queries">Running queries</a> <a style="margin-left: 3em"href="#defined-ddb-pagination">Pagination</a> <a style="margin-left: 2em"href="#changing-data">Changing data</a> <a style="margin-left: 1em"href="#retrying">Retrying</a> <a style="margin-left: 1em"href="#transactions">Transactions</a> <a style="margin-left: 1em"href="#defined-data-modeling">Data modeling</a> <a style="margin-left: 2em"href="#mapping-references">Mapping references</a> <a style="margin-left: 3em"href="#2-way-mapping">2-way mapping</a> <a style="margin-left: 2em"href="#mapping-lists">Mapping lists</a> <a style="margin-left: 3em"href="#ordering-results">Ordering results</a> <a style="margin-left: 3em"href="#efficient-filtering">Efficient filtering</a></div></div></div></div></div></div><h3 id="dynamodb">DynamoDB</h3><p>DynamoDB is the obvious choice for AppSync as they together provide a truly serverless setup. DynamoDB tables can scale up and down easily and AWS also offers per-request pricing (called <a href="https://aws.amazon.com/dynamodb/pricing/on-demand/">on-demand capacity</a>). This makes it possible for the API to scale to any load and also to go back to zero.<p>Also, GraphQL's concept of many individual resolvers usually maps to DynamoDB tables easily. As it is a NoSQL database that does not support complex queries but has no problems handling tons of simple ones, it can work well with AppSync.<p>In this chapter we'll look into how to write resolvers that fetch and store data in DynamoDB and what are the best practices to adapt the data model for efficient GraphQL queries.<h4 id="configuring-the-data-source-1">Configuring the data source</h4><p>When you create a DynamoDB data source, you need to define <strong>a table</strong> and <strong>a role</strong>. The formes defines what table to send the requests (when it's missing, such as for transactions, as we'll see later), and the latter gives AppSync permissions to do the operations.<figure class="image prevp"><img srcset="/assets/iwqAZGRiX2RhdGFfc291cmNlQDMucG5nJQM.4bcf7c2670ef01dd225bc345fbb234fe2cec239b.png 3x, /assets/Cw2AZGRiX2RhdGFfc291cmNlQDMucG5nJXctNzY2Aw.ef6a938b08776e6fdb309b5c3c9fb4d52ad09e60.png, /assets/iw2AZGRiX2RhdGFfc291cmNlQDMucG5nJXctMTE1MAM.8ab99ca511ef4f060b15a6c3be3cd1a3f8bd1b3d.png 1.5x"title="DynamoDB data source configured with a table and an IAM role"><figcaption class="caption">DynamoDB data source configured with a table and an IAM role</figcaption></figure><p>With the IAM role setting, you can give fine-grained permissions for each data source. For example, if you don't add write permissions then AppSync won't be able to change data in the table.<div class="floatbox floatbox-center"><div class="tcolorbox tcolorbox-info"><div class="tbox-header">One role or multiple?</div><div class="tbox-body"><p>With a data source per table, you have the choice to use a separate role for each of them, in contrast to using a single role with all permissions AppSync needs.<p>So, which approach is better?<p>I found that using separate roles adds too much verbosity and brings very little benefits. Since it brings no security benefits, I usually go with a single role per AppSync API.</div></div></div><figure class="plantuml image"><svg xmlns="http://www.w3.org/2000/svg"xmlns:xlink="http://www.w3.org/1999/xlink"height="339"preserveAspectRatio="none"style="width:481px;height:339px;background:#fff"viewBox="0 0 481 339"width="481"><path fill="#FFF"style="stroke:#00000000;stroke-width:1.5;fill:#fff"d="M7 7h132v118.922H7z"></path><image height="64"width="64"x="41"xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAIAAAAlC+aJAAADOUlEQVR4Xu2ZsWocMRCG/cB5g7xBnsC1m1Rp4zpFOneGdALbXGE4MOTgCoNh87M/OyialTSzq4tyIPFj1ruz0nwjzUhe34RPt1etG33rujQAemsA9NYA6K0B0FsDoLcaAzx/vjt+/XF+fHp/OX78Pk9zwwWEm2/fH15v7/Vbe9QGgH6Lx3QaDHCaMJA8Qjv9/HX48k33s0ENABBXcRqeIcbg0WYQnIaxwMBY23i1CwAOMerwCTOgDXLCi5gZ1ys5bQeQwDfxY7M2AtB7BD63Wv6ZtgBg7cJ7rIHu3ocNAFgw9F4/2inWX8ytq0D5ANA1q80lYh9XYcbIAuMDYAWsdkqxYkK40E8TMTRssIf3cq2NYzkAuHiqPVL0gHsww6ltYsnKnKKyBqrqVDsA6E21x7CEU/YpJn153ug6Ouco2iAnKwD2V3v4GU7xmDzl7YJHD3nXfmSyAjCKlvAHRctNo+ATupUZi68tsgJM87al7+fEdOdhrvounI4LDk+y2mxVJgCuAeP6oThj0lzvcsbKOSMyAXBJFNZAIgJL1L156RrOBOAKSVhKitgzL8tJHMs14SYArgd9f1WMX5yFLI7lNEiU9FBQewCmb1KvqoUoUTeA3G7N4mifhMYAjF9hEzjMfytiyMJuzSjg52n+s1MbxGoMUN4d+VRa7tiTmBX843TpaVyVCaBwFuBgiDoPXqw/GnXVLFfWWAZWh9MyAXB4CS1+lbGTwYiaa4lZLsauqm0CCEtp53U8QOIKed6XL0KxtFkuxqxj+v6qrABxGsQwYRkPzh2Xb1urScxHVbNLHebiOjj9namYBDKw6QQQM/o9zcmQMysXDK0KQBwk1kGuH7184R8TVHfiMvMenCoAjMd5+S4rYTZmmFfeU1OoAsBprvikacv9klKrHxVUARAd5r2WMPYMc4mJZF/9lBXg0pIE04/K+i8AOLFxZbOrM4AcK7Z5H/oCyPFuT1I1AEDanZz/MsIrTNnCjmZUAwDmH5cBgpojwWohquzHuC7saEY1AAhzkU22i/g8x+888gjXqDb7XafaAFASYzideEyeN8Pncq9aAnTRAOitAdBbA6C3BkBvDYDeunqAPxdjffOs6ZOIAAAAAElFTkSuQmCC"y="17"></image><text font-family="sans-serif"font-size="16"font-weight="bold"textLength="112"x="17"y="112.148">AppSync API</text><path fill="#FFF"style="stroke:#00000000;stroke-width:1.5;fill:#fff"d="M306.5 215h169v118.922h-169z"></path><image height="64"width="64"x="359"xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAIAAAAlC+aJAAADxUlEQVR4Xu1asYrcMBC9H58yjcs026W6Kt02KV2k3SLtQkgRyJFAIMWFFIGA76GHB63Glmdks86BxeO4s2XpvdHMaGTfg7z58qrxYC+9LhwC9sYhYG8cAvbGISChe/v19O7b4/sf5w8/FfgTF3HL9t8Q7QJA8fLp+en738HRnn//Q2c8srmesADYNSeN38Gs//gL5GDvAriIW4XO6+c/dthmBATAeMoDnKDE9qkDkqjW3mqGVwDmJvVtp18PrwA4Mdg3ezAehPJFNKyqSwCmX2l7Z6yj2WfrcAmg/zQHH+w6JP0wxBw4BSLEPl5HQEDbBDKa317PAXnog4nsrToCAhgG+InkaPvMQc1vb+XAsNBpry8iIID7K2UMaQcArUWbecxPkSG7KGIC+CfmQzyoEjaaENe542rPwWF+j8g5tAhQIPhAEfzAGyQAyAA03D3MmOLaokuiAjgZ+HkSttP8DF+WJIrFpxQuAWok/IKfo9cs7Gse8wP5gHmrD65wCZCRTe7c9UV3mr8ASDO0PCtMeAVwEYbkP4uZR8bSQ88GRN2oDezFL0A9lTIwUyWHqtqi1fdyDh5iL34BQ2IvY1mW51CmHUae2pjVgQLmH6oeVbioHy4BzELF9KB4Hg9lqmduTeqVQjN7CQkAS3vLCe4P9rqsYy8hAdQQ9VGpVuPwvblbTgQEcLIhBcNiSskx5z/r2UtIAFc5j2CG7zl7g5IHsT7OICnG3IS9NAjQK5hbs+pkY3/6T7HrkX19K3QiLMDGQJdKOm5VfXbApc8wgeb+w9phE/YSFaDRfHG/Vikqopw9E7E/libhEiDZRsbDAGXYbgUK/yF73Y85zp0EMJNAg87nWQH6D3tyBLLHIFuFgVcAbcmGWW1OnARZyi179cNhtfnFL4Cu3KfDl06vOXSOB/vk7Ak+OIxuuQYuAYUrd6mey5WwsV7Q3ZpHAiqfJDq3wYXgEsBFn/TXU/os0KdX0CzsAApQhZPsZRTgiaUKAgKik9XZc32iY1rEBAzuE5n6j73V3R6s7yeAfsJZn5beapFlMUhefWgc30+A1jb9/ImsT59qtKbAxWt6ZZR3vqS3GzKu0r0FKFgIkGKup2gqz1YN+wi4Vt9qddkbc3u3wP0EcB+g06tpJ7NqCLZQbYBLgNx+YsLERY3ZgC69BbIHnSi8AtT2/eozlIy2X29+8QuQZDPNJxf3eSDHKX1m5Qiw/Xr2EhJAPK7+0K21xiYIC1Awh+bMKo06bSZdj3YBObrX+M8e/wkOAXvjELA3DgF74xCwN14AdzgE4KRN4cQAAAAASUVORK5CYII="y="225"></image><text font-family="sans-serif"font-size="16"font-weight="bold"textLength="149"x="316.5"y="320.148">DynamoDB Table</text><path fill="#FFF"style="stroke:#00000000;stroke-width:1.5;fill:#fff"d="M24 215h98v118.922H24z"></path><image height="64"width="64"x="41"xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAIAAAAlC+aJAAADcElEQVR4Xu1Yy2pcMQzNn3bVZVfddtN1F1130X2h+0I/oPQHkg+4bSAQAiUDYSAQpgeLEWckW/Z9DM6AD2K4Y8vXOrIk2/fqcOG4sg2XhkGgNwaB3hgEemMQ6I1BoDcGgd44O4GXx0fI/vrm6ddv/ELw1yqtwFkIwMp/377fffg4vXlbEvRCB5p28ExsSQCuffjy1dtaFYx6/vPXvq4N2xDA9PefPnvL0Ajjdj9+In4geIDX0VJSXkBjLQHv9dt372FoiykSadDn4WixeiFWEYAFPDfCellMY3GYBp5b+AuWE4CbeUopL2jEgoCJMQgtEkuBZYYG/lqNHBYSwELrTIhdHwmxQD/LBC7g9ABhq+GwhEBLqYHLJYPxaxaEdbI0eG2rHGYT4LcbgbnxPpXNWozyQxA/qhDH0jwCJmtFYFA8hwfeYyqpz37mkF0owQwC8JOPhLmmM2A079Y+WnS1oWa6FDMI+N0ncEw7uB74TUAn9V2CVgKw9RzWCzgyzTpg2bXLp8qhnYA5mfmQXQnmYMJSAwnpzu2CJgLG/aXVXAnmYJytuecXoYkAF368y3ZvB3U2Qj/b7n3XRIDdv3nwGGismolK7qsT4JUNytlW0HA1c2kUmOJRJ8Dx40v1OaClk23Vfc3YUCfA9cfnkAGmxEx6awlOQdDJboIyXNTwBvwVGlpPTXrUCfCstu8IhFnW0BYRKw+FnV5EFKTXpEGFAO8j2TIs8NuciNwE5FiqYrYUlVK7vIfPHRwIFQJsWZwAd8crS3wgVcjtxx9PpuTvffoAYw5LLDpFhUCwQW4FYVLKtBIBNaZCgE//y3aAl/RhCysJiVdGcxcBo8IWwwC1R8OhSODp9IY65XZBD6lCEuiljEQ7FPx6lhJpovRTnYgA+oK5/XU2iOaqPJx+0tqni44RdlyFAAcMT+Dbp1Q0pNj7rom+RGB6DBfBM/S9d6AZVwhFRIB33CkFDIcsnvnmkRUYt0tVSEeV4BNXxCyIKu/Tt+Fd+mYjmpZAe7n0qwE7fEA3AvMax4mYDPaibsoQkAyTci4FRNLf70G386/zJezKiedFc/rAIVSK5pK0FKW52KfvLpzBsjnu0ufh7BZ5ksS+dHq5Px5dXgkyZVSSRktHwP41IEPgsjAI9MYg0BuDQG8MAr0xCPTGINAbg0Bv/Ae3IF2lX4hXSgAAAABJRU5ErkJggg=="y="225"></image><text font-family="sans-serif"font-size="16"font-weight="bold"textLength="78"x="34"y="320.148">IAM Role</text><path d="M73 126.26v83.15"fill="none"style="stroke:#666;stroke-width:1;fill:none"></path><path fill="#666"style="stroke:#666;stroke-width:1;fill:#666"d="m73 214.67 4-9-4 4-4-4 4 9z"></path><text fill="#666"font-family="sans-serif"font-size="12"textLength="207"x="74"y="168.139">Service:appsync.amazonaws.com</text><text fill="#666"font-family="sans-serif"font-size="12"textLength="142"x="74"y="182.107">Action:sts:AssumeRole</text><path d="M122.34 274.5h178.68"fill="none"style="stroke:#666;stroke-width:1;fill:none"></path><path fill="#666"style="stroke:#666;stroke-width:1;fill:#666"d="m306.22 274.5-9-4 4 4-4 4 9-4z"></path><text fill="#666"font-family="sans-serif"font-size="12"textLength="148"x="140.25"y="268.639">Action:dynamodb:Query</text></svg><figcaption class="caption">AppSync permission model for DynamoDB</figcaption></figure><h4 id="operations">Operations</h4><p>DynamoDB resolvers implement the same operations (GetItem, Query, Scan, DeleteItem, UpdateItem, etc) as you'd find anywhere else and while the structure is different they work the same. This means all usual constraints apply: you can only get an item with the full key, you can query with the partition key, and scanning is expensive. Moreover, you can use indices (local and global) the same way as in other languages.<p>To find out what structure each operation expects, the best resource is the <a href="https://docs.aws.amazon.com/appsync/latest/devguide/resolver-mapping-template-reference-dynamodb.html">official documentation</a>. It contains examples for each section.<p>Note that you can't copy-paste DynamoDB code from other languages as the resolvers require a different structure. For example, this <a href="https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/clients/client-dynamodb/interfaces/putitemcommandinput.html">PutItemCommand</a> uses the Javascript v3 SDK:<pre class="highlight"><code>{
  <span class="hljs-title class_">TableName</span>: <span class="hljs-variable constant_">COUNTS_TABLE</span>,
  <span class="hljs-title class_">Item</span>: {
    <span class="hljs-attr">type</span>: {<span class="hljs-attr">S</span>: <span class="hljs-string">"users"</span>},
    <span class="hljs-attr">count</span>: {<span class="hljs-attr">N</span>: <span class="hljs-string">"0"</span>},
  },
  <span class="hljs-title class_">ConditionExpression</span>: <span class="hljs-string">"attribute_not_exists(#pk)"</span>,
  <span class="hljs-title class_">ExpressionAttributeNames</span>: {<span class="hljs-string">"#pk"</span>: <span class="hljs-string">"type"</span>},
}</code></pre><p>Converted to an AppSync resolver:<pre class="highlight"><code><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2018-05-29"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"operation"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"PutItem"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"key"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"S"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"users"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"count"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"N"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"0"</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"condition"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"expression"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"attribute_not_exists(id)"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"expressionNames"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"#pk"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"type"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span></code></pre><div class="floatbox floatbox-center"><div class="tcolorbox tcolorbox-info"><div class="tbox-header">Expression names and values</div><div class="tbox-body"><p>If you read the documentation you'll see that the <code>expressionNames</code> and the <code>expressionValues</code> are present in multiple places:<ul><li><code>"update"</code><li><code>"query"</code><li><code>"filter"</code><li><code>"condition"</code></ul><p>While it's not obvious, these collapse into a single value. This means if you have both an <code>update</code> and a <code>condition</code> block with the same expression names, one will overwrite the other. Make sure you use different names in different blocks.</div></div></div><p>Error handling is a common theme in all DynamoDB operations and it follows the usual AppSync way: when an operation fails, the response mapping template will get the error in the <code>$ctx.error</code> value. By default, the resolver should throw an error when the operation fails:<pre class="highlight"><code>#if($ctx.error)
  $util.error($ctx.error.message, $ctx.error.type)
#end
...</code></pre><h5 id="getting-elements">Getting elements</h5><p>(<a href="https://docs.aws.amazon.com/appsync/latest/devguide/resolver-mapping-template-reference-dynamodb.html#aws-appsync-resolver-mapping-template-reference-dynamodb-getitem">Official docs</a>)<p>The <code>GetItem</code> <a href="https://docs.aws.amazon.com/appsync/latest/devguide/resolver-mapping-template-reference-dynamodb.html#aws-appsync-resolver-mapping-template-reference-dynamodb-getitem">operation</a> retrieves an element defined by its full key. For example, to implement a resolver for the field <code>groupById(id: String!): Group</code>, use:<pre class="highlight"><code>{
  "version": "2018-05-29",
  "operation": "GetItem",
  "key": {
    "id": {"S": $util.toJson($ctx.args.id)}
  },
  "consistentRead": true
}</code></pre><p>The resolver gets the <code>id</code> argument as <code>$ctx.args.id</code> and constructs the input for the data source. The table has only the <code>id</code> defined as a key, so specifying a value for that is enough.<figure class="plantuml image"><svg xmlns="http://www.w3.org/2000/svg"xmlns:xlink="http://www.w3.org/1999/xlink"height="268"preserveAspectRatio="none"style="width:440px;height:268px;background:#fff"viewBox="0 0 440 268"width="440"><defs><filter height="300%"id="d30fbdebd383f94182a9cbb1df062a6e35b0e66aeb894a82d4bb0db0fb3b11e9__a"width="300%"x="-1"y="-1"><feGaussianBlur result="blurOut"stdDeviation="2"></feGaussianBlur><feColorMatrix in="blurOut"result="blurOut2"values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"></feColorMatrix><feOffset dx="4"dy="4"in="blurOut2"result="blurOut3"></feOffset><feBlend in="SourceGraphic"in2="blurOut3"></feBlend></filter></defs><path style="stroke:#a80036;stroke-width:1;stroke-dasharray:5,5"d="M108 88v173.781M326 88v173.781"></path><path fill="#FFF"filter="url(#d30fbdebd383f94182a9cbb1df062a6e35b0e66aeb894a82d4bb0db0fb3b11e9__a)"style="stroke:#f90;stroke-width:1.5;fill:#fff"d="M5 5h203v78H5z"></path><image height="64"width="64"x="12"xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAIAAAAlC+aJAAADOUlEQVR4Xu2ZsWocMRCG/cB5g7xBnsC1m1Rp4zpFOneGdALbXGE4MOTgCoNh87M/OyialTSzq4tyIPFj1ruz0nwjzUhe34RPt1etG33rujQAemsA9NYA6K0B0FsDoLcaAzx/vjt+/XF+fHp/OX78Pk9zwwWEm2/fH15v7/Vbe9QGgH6Lx3QaDHCaMJA8Qjv9/HX48k33s0ENABBXcRqeIcbg0WYQnIaxwMBY23i1CwAOMerwCTOgDXLCi5gZ1ys5bQeQwDfxY7M2AtB7BD63Wv6ZtgBg7cJ7rIHu3ocNAFgw9F4/2inWX8ytq0D5ANA1q80lYh9XYcbIAuMDYAWsdkqxYkK40E8TMTRssIf3cq2NYzkAuHiqPVL0gHsww6ltYsnKnKKyBqrqVDsA6E21x7CEU/YpJn153ug6Ouco2iAnKwD2V3v4GU7xmDzl7YJHD3nXfmSyAjCKlvAHRctNo+ATupUZi68tsgJM87al7+fEdOdhrvounI4LDk+y2mxVJgCuAeP6oThj0lzvcsbKOSMyAXBJFNZAIgJL1L156RrOBOAKSVhKitgzL8tJHMs14SYArgd9f1WMX5yFLI7lNEiU9FBQewCmb1KvqoUoUTeA3G7N4mifhMYAjF9hEzjMfytiyMJuzSjg52n+s1MbxGoMUN4d+VRa7tiTmBX843TpaVyVCaBwFuBgiDoPXqw/GnXVLFfWWAZWh9MyAXB4CS1+lbGTwYiaa4lZLsauqm0CCEtp53U8QOIKed6XL0KxtFkuxqxj+v6qrABxGsQwYRkPzh2Xb1urScxHVbNLHebiOjj9namYBDKw6QQQM/o9zcmQMysXDK0KQBwk1kGuH7184R8TVHfiMvMenCoAjMd5+S4rYTZmmFfeU1OoAsBprvikacv9klKrHxVUARAd5r2WMPYMc4mJZF/9lBXg0pIE04/K+i8AOLFxZbOrM4AcK7Z5H/oCyPFuT1I1AEDanZz/MsIrTNnCjmZUAwDmH5cBgpojwWohquzHuC7saEY1AAhzkU22i/g8x+888gjXqDb7XafaAFASYzideEyeN8Pncq9aAnTRAOitAdBbA6C3BkBvDYDeunqAPxdjffOs6ZOIAAAAAElFTkSuQmCC"y="12"></image><text font-family="sans-serif"font-size="14"font-style="italic"textLength="80"x="101.5"y="24.995">Â«AppSyncÂ»</text><text font-family="sans-serif"font-size="14"textLength="119"x="82"y="41.292">AppSync resolver</text><text font-family="sans-serif"font-size="12"textLength="10"x="136.5"y="55.732">[]</text><path fill="#FFF"filter="url(#d30fbdebd383f94182a9cbb1df062a6e35b0e66aeb894a82d4bb0db0fb3b11e9__a)"style="stroke:#f90;stroke-width:1.5;fill:#fff"d="M222 5h204v78H222z"></path><image height="64"width="64"x="229"xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAIAAAAlC+aJAAADxUlEQVR4Xu1asYrcMBC9H58yjcs026W6Kt02KV2k3SLtQkgRyJFAIMWFFIGA76GHB63Glmdks86BxeO4s2XpvdHMaGTfg7z58qrxYC+9LhwC9sYhYG8cAvbGISChe/v19O7b4/sf5w8/FfgTF3HL9t8Q7QJA8fLp+en738HRnn//Q2c8srmesADYNSeN38Gs//gL5GDvAriIW4XO6+c/dthmBATAeMoDnKDE9qkDkqjW3mqGVwDmJvVtp18PrwA4Mdg3ezAehPJFNKyqSwCmX2l7Z6yj2WfrcAmg/zQHH+w6JP0wxBw4BSLEPl5HQEDbBDKa317PAXnog4nsrToCAhgG+InkaPvMQc1vb+XAsNBpry8iIID7K2UMaQcArUWbecxPkSG7KGIC+CfmQzyoEjaaENe542rPwWF+j8g5tAhQIPhAEfzAGyQAyAA03D3MmOLaokuiAjgZ+HkSttP8DF+WJIrFpxQuAWok/IKfo9cs7Gse8wP5gHmrD65wCZCRTe7c9UV3mr8ASDO0PCtMeAVwEYbkP4uZR8bSQ88GRN2oDezFL0A9lTIwUyWHqtqi1fdyDh5iL34BQ2IvY1mW51CmHUae2pjVgQLmH6oeVbioHy4BzELF9KB4Hg9lqmduTeqVQjN7CQkAS3vLCe4P9rqsYy8hAdQQ9VGpVuPwvblbTgQEcLIhBcNiSskx5z/r2UtIAFc5j2CG7zl7g5IHsT7OICnG3IS9NAjQK5hbs+pkY3/6T7HrkX19K3QiLMDGQJdKOm5VfXbApc8wgeb+w9phE/YSFaDRfHG/Vikqopw9E7E/libhEiDZRsbDAGXYbgUK/yF73Y85zp0EMJNAg87nWQH6D3tyBLLHIFuFgVcAbcmGWW1OnARZyi179cNhtfnFL4Cu3KfDl06vOXSOB/vk7Ak+OIxuuQYuAYUrd6mey5WwsV7Q3ZpHAiqfJDq3wYXgEsBFn/TXU/os0KdX0CzsAApQhZPsZRTgiaUKAgKik9XZc32iY1rEBAzuE5n6j73V3R6s7yeAfsJZn5beapFlMUhefWgc30+A1jb9/ImsT59qtKbAxWt6ZZR3vqS3GzKu0r0FKFgIkGKup2gqz1YN+wi4Vt9qddkbc3u3wP0EcB+g06tpJ7NqCLZQbYBLgNx+YsLERY3ZgC69BbIHnSi8AtT2/eozlIy2X29+8QuQZDPNJxf3eSDHKX1m5Qiw/Xr2EhJAPK7+0K21xiYIC1Awh+bMKo06bSZdj3YBObrX+M8e/wkOAXvjELA3DgF74xCwN14AdzgE4KRN4cQAAAAASUVORK5CYII="y="12"></image><text font-family="sans-serif"font-size="14"font-style="italic"textLength="97"x="310.5"y="24.995">Â«DynamoDBÂ»</text><text font-family="sans-serif"font-size="14"textLength="120"x="299"y="41.292">DynamoDB Table</text><text font-family="sans-serif"font-size="12"textLength="10"x="354"y="55.732">[]</text><path fill="#666"style="stroke:#666;stroke-width:1;fill:#666"d="m96.5 113.969 10 4-10 4 4-4z"></path><path style="stroke:#666;stroke-width:1"d="M0 117.969h102.5"></path><text fill="#666"font-family="sans-serif"font-size="12"textLength="11"x="7"y="113.139">id</text><path fill="#666"style="stroke:#666;stroke-width:1;fill:#666"d="m314 183.844 10 4-10 4 4-4z"></path><path style="stroke:#666;stroke-width:1"d="M108.5 187.844H320"></path><text fill="#666"font-family="sans-serif"font-size="12"textLength="49"x="115.5"y="141.107">GetItem</text><text fill="#666"font-family="sans-serif"font-size="12"textLength="25"x="115.5"y="155.076">key:</text><text fill="#666"font-family="sans-serif"font-size="12"textLength="90"x="123.5"y="169.045">{"id": {"S": id}</text><text fill="#666"font-family="sans-serif"font-size="12"textLength="8"x="115.5"y="183.014">}</text><path fill="#666"style="stroke:#666;stroke-width:1;fill:#666"d="m119.5 211.813-10 4 10 4-4-4z"></path><path style="stroke:#666;stroke-width:1"d="M113.5 215.813H325"></path><text fill="#666"font-family="sans-serif"font-size="12"textLength="27"x="125.5"y="210.982">item</text><path fill="#666"style="stroke:#666;stroke-width:1;fill:#666"d="m11 239.781-10 4 10 4-4-4z"></path><path style="stroke:#666;stroke-width:1"d="M5 243.781h102.5"></path><text fill="#666"font-family="sans-serif"font-size="12"textLength="27"x="17"y="238.951">item</text></svg><figcaption class="caption">GetItem operation</figcaption></figure><p>The <code>$util.toJson</code> structure is important even though things usually work without it. It converts the argument value to a JSON string, making sure that every special character is safely escaped. VTL is string concatenation, so any user input that goes to the result directly opens a way for injection attacks.<p>Then notice the DynamoDB type system: <code>"id": {"S": "123"}</code>. The data source follows the same structure as other utilities for types, so it's always <code>"&lt;property&gt;": {"type": "value"}</code>, even for numbers: <code>{"N": "15"}</code>.<p>AppSync provides a few <a href="https://docs.aws.amazon.com/appsync/latest/devguide/dynamodb-helpers-in-util-dynamodb.html">utility functions</a> that convert these types into native JSON types, but I find myself opting out of them. A similar <a href="https://docs.aws.amazon.com/appsync/latest/devguide/transformation-helpers-in-utils-transform.html">helpes</a> exists for filter expressions too.<p>Finally, the <code>"consistentRead": true</code> sends a strongly consistent read, meaning the result will always be the most up-to-date version of the item. While it is more expensive, it provides an opt-out of DynamoDB's eventual consistency model.<div class="floatbox floatbox-center"><div class="tcolorbox tcolorbox-info"><div class="tbox-header">Item keys</div><div class="tbox-body"><p>As DynamoDB is a key-value store, you need to specify the full ID of the item.</div></div></div><p>The result is the a JSON with the properties of the item converted to native JSON types. This means, apart from error handling, if it matches the GraphQL schema then it can be returned as-is.<pre class="highlight prevp"><code>#if($ctx.error)
  $util.error($ctx.error.message, $ctx.error.type)
#end
$util.toJson($ctx.result)</code></pre><h5 id="running-queries">Running queries</h5><p>(<a href="https://docs.aws.amazon.com/appsync/latest/devguide/resolver-mapping-template-reference-dynamodb.html#aws-appsync-resolver-mapping-template-reference-dynamodb-query">Official docs</a>)<p>To get a list of items from DynamoDB, you can use a Query. This is when you specify the partition key and get an ordered list of results. As is common in DynamoDB data modeling, you need to plan in advance: if your API needs to send a query that gets elements for a given partition key, a table or an index needs to be in place to support that. We'll cover this aspect a bit more in the <a href="#defined-data-modeling">Data modeling</a> chapter.<p>The data source <a href="https://docs.aws.amazon.com/appsync/latest/devguide/resolver-mapping-template-reference-dynamodb.html#aws-appsync-resolver-mapping-template-reference-dynamodb-query">supports queries</a> on indices (local and global) as well as the table itself. In the query expression you need to define the partition key, and optionally a range for the range key.<p>For example, if users belong to groups and there is a global secondary index (GSI) with the partition key as the group ID, this resolver mapping template returns users belonging to a given group:<pre class="highlight prevp"><code>{
  "version": "2018-05-29",
  "operation": "Query",
  "index": "groupId",
  "query": {
    "expression": "#groupId = :groupId",
    "expressionNames": {
      "#groupId": "groupId"
    },
    "expressionValues": {
      ":groupId": {"S": $util.toJson($ctx.source.id)}
    }
  }
}</code></pre><figure class="plantuml image"><svg xmlns="http://www.w3.org/2000/svg"xmlns:xlink="http://www.w3.org/1999/xlink"height="282"preserveAspectRatio="none"style="width:440px;height:282px;background:#fff"viewBox="0 0 440 282"width="440"><defs><filter height="300%"id="1a3e056c5fe8b01f7ed2492124705f1221f05675389be354b4fbb3a0f8f4ea44__a"width="300%"x="-1"y="-1"><feGaussianBlur result="blurOut"stdDeviation="2"></feGaussianBlur><feColorMatrix in="blurOut"result="blurOut2"values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"></feColorMatrix><feOffset dx="4"dy="4"in="blurOut2"result="blurOut3"></feOffset><feBlend in="SourceGraphic"in2="blurOut3"></feBlend></filter></defs><path style="stroke:#a80036;stroke-width:1;stroke-dasharray:5,5"d="M108 88v187.75M326 88v187.75"></path><path fill="#FFF"filter="url(#1a3e056c5fe8b01f7ed2492124705f1221f05675389be354b4fbb3a0f8f4ea44__a)"style="stroke:#f90;stroke-width:1.5;fill:#fff"d="M5 5h203v78H5z"></path><image height="64"width="64"x="12"xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAIAAAAlC+aJAAADOUlEQVR4Xu2ZsWocMRCG/cB5g7xBnsC1m1Rp4zpFOneGdALbXGE4MOTgCoNh87M/OyialTSzq4tyIPFj1ruz0nwjzUhe34RPt1etG33rujQAemsA9NYA6K0B0FsDoLcaAzx/vjt+/XF+fHp/OX78Pk9zwwWEm2/fH15v7/Vbe9QGgH6Lx3QaDHCaMJA8Qjv9/HX48k33s0ENABBXcRqeIcbg0WYQnIaxwMBY23i1CwAOMerwCTOgDXLCi5gZ1ys5bQeQwDfxY7M2AtB7BD63Wv6ZtgBg7cJ7rIHu3ocNAFgw9F4/2inWX8ytq0D5ANA1q80lYh9XYcbIAuMDYAWsdkqxYkK40E8TMTRssIf3cq2NYzkAuHiqPVL0gHsww6ltYsnKnKKyBqrqVDsA6E21x7CEU/YpJn153ug6Ouco2iAnKwD2V3v4GU7xmDzl7YJHD3nXfmSyAjCKlvAHRctNo+ATupUZi68tsgJM87al7+fEdOdhrvounI4LDk+y2mxVJgCuAeP6oThj0lzvcsbKOSMyAXBJFNZAIgJL1L156RrOBOAKSVhKitgzL8tJHMs14SYArgd9f1WMX5yFLI7lNEiU9FBQewCmb1KvqoUoUTeA3G7N4mifhMYAjF9hEzjMfytiyMJuzSjg52n+s1MbxGoMUN4d+VRa7tiTmBX843TpaVyVCaBwFuBgiDoPXqw/GnXVLFfWWAZWh9MyAXB4CS1+lbGTwYiaa4lZLsauqm0CCEtp53U8QOIKed6XL0KxtFkuxqxj+v6qrABxGsQwYRkPzh2Xb1urScxHVbNLHebiOjj9namYBDKw6QQQM/o9zcmQMysXDK0KQBwk1kGuH7184R8TVHfiMvMenCoAjMd5+S4rYTZmmFfeU1OoAsBprvikacv9klKrHxVUARAd5r2WMPYMc4mJZF/9lBXg0pIE04/K+i8AOLFxZbOrM4AcK7Z5H/oCyPFuT1I1AEDanZz/MsIrTNnCjmZUAwDmH5cBgpojwWohquzHuC7saEY1AAhzkU22i/g8x+888gjXqDb7XafaAFASYzideEyeN8Pncq9aAnTRAOitAdBbA6C3BkBvDYDeunqAPxdjffOs6ZOIAAAAAElFTkSuQmCC"y="12"></image><text font-family="sans-serif"font-size="14"font-style="italic"textLength="80"x="101.5"y="24.995">Â«AppSyncÂ»</text><text font-family="sans-serif"font-size="14"textLength="119"x="82"y="41.292">AppSync resolver</text><text font-family="sans-serif"font-size="12"textLength="10"x="136.5"y="55.732">[]</text><path fill="#FFF"filter="url(#1a3e056c5fe8b01f7ed2492124705f1221f05675389be354b4fbb3a0f8f4ea44__a)"style="stroke:#f90;stroke-width:1.5;fill:#fff"d="M222 5h204v78H222z"></path><image height="64"width="64"x="229"xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAIAAAAlC+aJAAADxUlEQVR4Xu1asYrcMBC9H58yjcs026W6Kt02KV2k3SLtQkgRyJFAIMWFFIGA76GHB63Glmdks86BxeO4s2XpvdHMaGTfg7z58qrxYC+9LhwC9sYhYG8cAvbGISChe/v19O7b4/sf5w8/FfgTF3HL9t8Q7QJA8fLp+en738HRnn//Q2c8srmesADYNSeN38Gs//gL5GDvAriIW4XO6+c/dthmBATAeMoDnKDE9qkDkqjW3mqGVwDmJvVtp18PrwA4Mdg3ezAehPJFNKyqSwCmX2l7Z6yj2WfrcAmg/zQHH+w6JP0wxBw4BSLEPl5HQEDbBDKa317PAXnog4nsrToCAhgG+InkaPvMQc1vb+XAsNBpry8iIID7K2UMaQcArUWbecxPkSG7KGIC+CfmQzyoEjaaENe542rPwWF+j8g5tAhQIPhAEfzAGyQAyAA03D3MmOLaokuiAjgZ+HkSttP8DF+WJIrFpxQuAWok/IKfo9cs7Gse8wP5gHmrD65wCZCRTe7c9UV3mr8ASDO0PCtMeAVwEYbkP4uZR8bSQ88GRN2oDezFL0A9lTIwUyWHqtqi1fdyDh5iL34BQ2IvY1mW51CmHUae2pjVgQLmH6oeVbioHy4BzELF9KB4Hg9lqmduTeqVQjN7CQkAS3vLCe4P9rqsYy8hAdQQ9VGpVuPwvblbTgQEcLIhBcNiSskx5z/r2UtIAFc5j2CG7zl7g5IHsT7OICnG3IS9NAjQK5hbs+pkY3/6T7HrkX19K3QiLMDGQJdKOm5VfXbApc8wgeb+w9phE/YSFaDRfHG/Vikqopw9E7E/libhEiDZRsbDAGXYbgUK/yF73Y85zp0EMJNAg87nWQH6D3tyBLLHIFuFgVcAbcmGWW1OnARZyi179cNhtfnFL4Cu3KfDl06vOXSOB/vk7Ak+OIxuuQYuAYUrd6mey5WwsV7Q3ZpHAiqfJDq3wYXgEsBFn/TXU/os0KdX0CzsAApQhZPsZRTgiaUKAgKik9XZc32iY1rEBAzuE5n6j73V3R6s7yeAfsJZn5beapFlMUhefWgc30+A1jb9/ImsT59qtKbAxWt6ZZR3vqS3GzKu0r0FKFgIkGKup2gqz1YN+wi4Vt9qddkbc3u3wP0EcB+g06tpJ7NqCLZQbYBLgNx+YsLERY3ZgC69BbIHnSi8AtT2/eozlIy2X29+8QuQZDPNJxf3eSDHKX1m5Qiw/Xr2EhJAPK7+0K21xiYIC1Awh+bMKo06bSZdj3YBObrX+M8e/wkOAXvjELA3DgF74xCwN14AdzgE4KRN4cQAAAAASUVORK5CYII="y="12"></image><text font-family="sans-serif"font-size="14"font-style="italic"textLength="97"x="310.5"y="24.995">Â«DynamoDBÂ»</text><text font-family="sans-serif"font-size="14"textLength="120"x="299"y="41.292">DynamoDB Table</text><text font-family="sans-serif"font-size="12"textLength="10"x="354"y="55.732">[]</text><path fill="#666"style="stroke:#666;stroke-width:1;fill:#666"d="m96.5 113.969 10 4-10 4 4-4z"></path><path style="stroke:#666;stroke-width:1"d="M0 117.969h102.5"></path><text fill="#666"font-family="sans-serif"font-size="12"textLength="11"x="7"y="113.139">id</text><path fill="#666"style="stroke:#666;stroke-width:1;fill:#666"d="m314 169.875 10 4-10 4 4-4z"></path><path style="stroke:#666;stroke-width:1"d="M108.5 173.875H320"></path><text fill="#666"font-family="sans-serif"font-size="12"textLength="36"x="115.5"y="141.107">Query</text><text fill="#666"font-family="sans-serif"font-size="12"textLength="138"x="115.5"y="155.076">"#groupId = :groupId"</text><text fill="#666"font-family="sans-serif"font-size="12"textLength="123"x="115.5"y="169.045">":groupId": {"S": id}</text><path fill="#666"style="stroke:#666;stroke-width:1;fill:#666"d="m119.5 211.813-10 4 10 4-4-4z"></path><path style="stroke:#666;stroke-width:1"d="M113.5 215.813H325"></path><text fill="#666"font-family="sans-serif"font-size="12"textLength="34"x="125.5"y="197.014">items</text><text fill="#666"font-family="sans-serif"font-size="12"textLength="65"x="125.5"y="210.982">nextToken</text><path fill="#666"style="stroke:#666;stroke-width:1;fill:#666"d="m11 253.75-10 4 10 4-4-4z"></path><path style="stroke:#666;stroke-width:1"d="M5 257.75h102.5"></path><text fill="#666"font-family="sans-serif"font-size="12"textLength="35"x="17"y="238.951">users</text><text fill="#666"font-family="sans-serif"font-size="12"textLength="65"x="17"y="252.92">nextToken</text></svg><figcaption class="caption">Query operation</figcaption></figure><p>The <code>consistentRead</code> is also a valid argument for queries, but only for the table itself or a local secondary index (LSI). This is again a limitation of DynamoDB.<p>Also, the <code>scanIndexForward</code> defines whether the items are read in increasing or decreasing order. Finally, the <code>limit</code> defines the maximum number of items the query can return.<div class="floatbox floatbox-center"><div class="tcolorbox tcolorbox-info"><div class="tbox-header">Limit</div><div class="tbox-body"><p>Limit sets the <em>maximum</em> number of items, there are no guarantees that the result will return that many elements even if the table has that many items.</div></div></div><p>The result is an object with an <code>items</code> and a <code>nextToken</code> field. The former contains the result items while the latter is important for pagination, which we'll see in the <a href="#defined-ddb-pagination">Pagination</a> chapter. Here, you can return this structure without changing, or you can map the result properties to another names:<pre class="highlight prevp"><code>#if($ctx.error)
  $util.error($ctx.error.message, $ctx.error.type)
#end
{
  "users": $utils.toJson($ctx.result.items),
  "nextToken": $util.toJson($ctx.result.nextToken)
}</code></pre><div class="floatbox floatbox-center"><div class="tcolorbox tcolorbox-info"><div class="tbox-header">Query vs Scan</div><div class="tbox-body"><p>The other operation that returns a list is the Scan. The difference is that Scan evaluates <em>all items in the table</em>, while Query reads only those with a given partition key. While it's not a problem for small tables, it becomes extremely costly and slow to run scans when the table has many items.<p>Try to store your data in a way that you don't need to use scans only queries.</div></div></div><h6 id="defined-ddb-pagination">Pagination</h6><p>Pagination is an important topic in DynamoDB as every operation that returns a list of items return pages. This means the AppSync resolver might not get all the results of a query just some, along with a continuation token called <code>nextToken</code>. If that token is <strong>null</strong> then there are guaranteed that a query returns no more results. If it is <strong>non-null</strong> then sending it along with the same query might return more items. To get all the elements for a query or a scan, send the same operation over and over again passing the previous token until the <code>nextToken</code> becomes null.<figure class="plantuml image"><svg xmlns="http://www.w3.org/2000/svg"xmlns:xlink="http://www.w3.org/1999/xlink"height="450"preserveAspectRatio="none"style="width:507px;height:450px;background:#fff"viewBox="0 0 507 450"width="507"><defs><filter height="300%"id="b1ff968128a0537b8e6e8f4874dd77e2c26102954d760e9ea0c549f168bd7e8a__a"width="300%"x="-1"y="-1"><feGaussianBlur result="blurOut"stdDeviation="2"></feGaussianBlur><feColorMatrix in="blurOut"result="blurOut2"values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"></feColorMatrix><feOffset dx="4"dy="4"in="blurOut2"result="blurOut3"></feOffset><feBlend in="SourceGraphic"in2="blurOut3"></feBlend></filter></defs><path style="stroke:#a80036;stroke-width:1;stroke-dasharray:5,5"d="M175.5 88v355.5M393.5 88v355.5"></path><path fill="#FFF"filter="url(#b1ff968128a0537b8e6e8f4874dd77e2c26102954d760e9ea0c549f168bd7e8a__a)"style="stroke:#f90;stroke-width:1.5;fill:#fff"d="M72.5 5h203v78h-203z"></path><image height="64"width="64"x="79.5"xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAIAAAAlC+aJAAADOUlEQVR4Xu2ZsWocMRCG/cB5g7xBnsC1m1Rp4zpFOneGdALbXGE4MOTgCoNh87M/OyialTSzq4tyIPFj1ruz0nwjzUhe34RPt1etG33rujQAemsA9NYA6K0B0FsDoLcaAzx/vjt+/XF+fHp/OX78Pk9zwwWEm2/fH15v7/Vbe9QGgH6Lx3QaDHCaMJA8Qjv9/HX48k33s0ENABBXcRqeIcbg0WYQnIaxwMBY23i1CwAOMerwCTOgDXLCi5gZ1ys5bQeQwDfxY7M2AtB7BD63Wv6ZtgBg7cJ7rIHu3ocNAFgw9F4/2inWX8ytq0D5ANA1q80lYh9XYcbIAuMDYAWsdkqxYkK40E8TMTRssIf3cq2NYzkAuHiqPVL0gHsww6ltYsnKnKKyBqrqVDsA6E21x7CEU/YpJn153ug6Ouco2iAnKwD2V3v4GU7xmDzl7YJHD3nXfmSyAjCKlvAHRctNo+ATupUZi68tsgJM87al7+fEdOdhrvounI4LDk+y2mxVJgCuAeP6oThj0lzvcsbKOSMyAXBJFNZAIgJL1L156RrOBOAKSVhKitgzL8tJHMs14SYArgd9f1WMX5yFLI7lNEiU9FBQewCmb1KvqoUoUTeA3G7N4mifhMYAjF9hEzjMfytiyMJuzSjg52n+s1MbxGoMUN4d+VRa7tiTmBX843TpaVyVCaBwFuBgiDoPXqw/GnXVLFfWWAZWh9MyAXB4CS1+lbGTwYiaa4lZLsauqm0CCEtp53U8QOIKed6XL0KxtFkuxqxj+v6qrABxGsQwYRkPzh2Xb1urScxHVbNLHebiOjj9namYBDKw6QQQM/o9zcmQMysXDK0KQBwk1kGuH7184R8TVHfiMvMenCoAjMd5+S4rYTZmmFfeU1OoAsBprvikacv9klKrHxVUARAd5r2WMPYMc4mJZF/9lBXg0pIE04/K+i8AOLFxZbOrM4AcK7Z5H/oCyPFuT1I1AEDanZz/MsIrTNnCjmZUAwDmH5cBgpojwWohquzHuC7saEY1AAhzkU22i/g8x+888gjXqDb7XafaAFASYzideEyeN8Pncq9aAnTRAOitAdBbA6C3BkBvDYDeunqAPxdjffOs6ZOIAAAAAElFTkSuQmCC"y="12"></image><text font-family="sans-serif"font-size="14"font-style="italic"textLength="80"x="169"y="24.995">Â«AppSyncÂ»</text><text font-family="sans-serif"font-size="14"textLength="119"x="149.5"y="41.292">AppSync resolver</text><text font-family="sans-serif"font-size="12"textLength="10"x="204"y="55.732">[]</text><path fill="#FFF"filter="url(#b1ff968128a0537b8e6e8f4874dd77e2c26102954d760e9ea0c549f168bd7e8a__a)"style="stroke:#f90;stroke-width:1.5;fill:#fff"d="M289.5 5h204v78h-204z"></path><image height="64"width="64"x="296.5"xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAIAAAAlC+aJAAADxUlEQVR4Xu1asYrcMBC9H58yjcs026W6Kt02KV2k3SLtQkgRyJFAIMWFFIGA76GHB63Glmdks86BxeO4s2XpvdHMaGTfg7z58qrxYC+9LhwC9sYhYG8cAvbGISChe/v19O7b4/sf5w8/FfgTF3HL9t8Q7QJA8fLp+en738HRnn//Q2c8srmesADYNSeN38Gs//gL5GDvAriIW4XO6+c/dthmBATAeMoDnKDE9qkDkqjW3mqGVwDmJvVtp18PrwA4Mdg3ezAehPJFNKyqSwCmX2l7Z6yj2WfrcAmg/zQHH+w6JP0wxBw4BSLEPl5HQEDbBDKa317PAXnog4nsrToCAhgG+InkaPvMQc1vb+XAsNBpry8iIID7K2UMaQcArUWbecxPkSG7KGIC+CfmQzyoEjaaENe542rPwWF+j8g5tAhQIPhAEfzAGyQAyAA03D3MmOLaokuiAjgZ+HkSttP8DF+WJIrFpxQuAWok/IKfo9cs7Gse8wP5gHmrD65wCZCRTe7c9UV3mr8ASDO0PCtMeAVwEYbkP4uZR8bSQ88GRN2oDezFL0A9lTIwUyWHqtqi1fdyDh5iL34BQ2IvY1mW51CmHUae2pjVgQLmH6oeVbioHy4BzELF9KB4Hg9lqmduTeqVQjN7CQkAS3vLCe4P9rqsYy8hAdQQ9VGpVuPwvblbTgQEcLIhBcNiSskx5z/r2UtIAFc5j2CG7zl7g5IHsT7OICnG3IS9NAjQK5hbs+pkY3/6T7HrkX19K3QiLMDGQJdKOm5VfXbApc8wgeb+w9phE/YSFaDRfHG/Vikqopw9E7E/libhEiDZRsbDAGXYbgUK/yF73Y85zp0EMJNAg87nWQH6D3tyBLLHIFuFgVcAbcmGWW1OnARZyi179cNhtfnFL4Cu3KfDl06vOXSOB/vk7Ak+OIxuuQYuAYUrd6mey5WwsV7Q3ZpHAiqfJDq3wYXgEsBFn/TXU/os0KdX0CzsAApQhZPsZRTgiaUKAgKik9XZc32iY1rEBAzuE5n6j73V3R6s7yeAfsJZn5beapFlMUhefWgc30+A1jb9/ImsT59qtKbAxWt6ZZR3vqS3GzKu0r0FKFgIkGKup2gqz1YN+wi4Vt9qddkbc3u3wP0EcB+g06tpJ7NqCLZQbYBLgNx+YsLERY3ZgC69BbIHnSi8AtT2/eozlIy2X29+8QuQZDPNJxf3eSDHKX1m5Qiw/Xr2EhJAPK7+0K21xiYIC1Awh+bMKo06bSZdj3YBObrX+M8e/wkOAXvjELA3DgF74xCwN14AdzgE4KRN4cQAAAAASUVORK5CYII="y="12"></image><text font-family="sans-serif"font-size="14"font-style="italic"textLength="97"x="378"y="24.995">Â«DynamoDBÂ»</text><text font-family="sans-serif"font-size="14"textLength="120"x="366.5"y="41.292">DynamoDB Table</text><text font-family="sans-serif"font-size="12"textLength="10"x="421.5"y="55.732">[]</text><path fill="#666"style="stroke:#666;stroke-width:1;fill:#666"d="m164 113.969 10 4-10 4 4-4z"></path><path style="stroke:#666;stroke-width:1"d="M0 117.969h170"></path><text fill="#666"font-family="sans-serif"font-size="12"textLength="11"x="7"y="113.139">id</text><path fill="#666"style="stroke:#666;stroke-width:1;fill:#666"d="m381.5 169.875 10 4-10 4 4-4z"></path><path style="stroke:#666;stroke-width:1"d="M176 173.875h211.5"></path><text fill="#666"font-family="sans-serif"font-size="12"textLength="36"x="183"y="141.107">Query</text><text fill="#666"font-family="sans-serif"font-size="12"textLength="138"x="183"y="155.076">"#groupId = :groupId"</text><text fill="#666"font-family="sans-serif"font-size="12"textLength="81"x="183"y="169.045">":groupId": id</text><path fill="#666"style="stroke:#666;stroke-width:1;fill:#666"d="m187 211.813-10 4 10 4-4-4z"></path><path style="stroke:#666;stroke-width:1"d="M181 215.813h211.5"></path><text fill="#666"font-family="sans-serif"font-size="12"textLength="78"x="193"y="197.014">item1, item2</text><text fill="#666"font-family="sans-serif"font-size="12"font-weight="bold"textLength="152"x="193"y="210.982">nextToken:&nbsp;&lt;token1&gt;</text><path fill="#666"style="stroke:#666;stroke-width:1;fill:#666"d="m11 253.75-10 4 10 4-4-4z"></path><path style="stroke:#666;stroke-width:1"d="M5 257.75h170"></path><text fill="#666"font-family="sans-serif"font-size="12"textLength="78"x="17"y="238.951">item1, item2</text><text fill="#666"font-family="sans-serif"font-size="12"font-weight="bold"textLength="152"x="17"y="252.92">nextToken:&nbsp;&lt;token1&gt;</text><path fill="#666"style="stroke:#666;stroke-width:1;fill:#666"d="m164 295.688 10 4-10 4 4-4z"></path><path style="stroke:#666;stroke-width:1"d="M0 299.688h170"></path><text fill="#666"font-family="sans-serif"font-size="12"textLength="11"x="7"y="280.889">id</text><text fill="#666"font-family="sans-serif"font-size="12"font-weight="bold"textLength="152"x="7"y="294.857">nextToken:&nbsp;&lt;token1&gt;</text><path fill="#666"style="stroke:#666;stroke-width:1;fill:#666"d="m381.5 365.563 10 4-10 4 4-4z"></path><path style="stroke:#666;stroke-width:1"d="M176 369.563h211.5"></path><text fill="#666"font-family="sans-serif"font-size="12"textLength="36"x="183"y="322.826">Query</text><text fill="#666"font-family="sans-serif"font-size="12"textLength="138"x="183"y="336.795">"#groupId = :groupId"</text><text fill="#666"font-family="sans-serif"font-size="12"textLength="81"x="183"y="350.764">":groupId": id</text><text fill="#666"font-family="sans-serif"font-size="12"font-weight="bold"textLength="152"x="183"y="364.732">nextToken:&nbsp;&lt;token1&gt;</text><path fill="#666"style="stroke:#666;stroke-width:1;fill:#666"d="m187 393.531-10 4 10 4-4-4z"></path><path style="stroke:#666;stroke-width:1"d="M181 397.531h211.5"></path><text fill="#666"font-family="sans-serif"font-size="12"textLength="35"x="193"y="392.701">item3</text><path fill="#666"style="stroke:#666;stroke-width:1;fill:#666"d="m11 421.5-10 4 10 4-4-4z"></path><path style="stroke:#666;stroke-width:1"d="M5 425.5h170"></path><text fill="#666"font-family="sans-serif"font-size="12"textLength="35"x="17"y="420.67">item3</text></svg><figcaption class="caption">Paginating DynamoDB queries with nextToken</figcaption></figure><p>This is called cursor-based pagination as a cursor value (the <code>nextToken</code>) is used to get the next page of items. In the SQL world the so-called offset-based pagination is more prevalent, where you define an OFFSET that skips the first <em>n</em> items. Both have advantages and disadvantages, and the main reason why DynamoDB opted for cursors is that all operations run fast no matter which page you fetch.<p>DynamoDB pagination has some strange properties that might feel overly restrictive at first but are the direct consequences of one fundamental idea: all operations must be fast. Because of this, the database guarantees only a few things in terms of pagination.<p>If you use <em>limit</em>, the number of the returned items will never be more than the limit specified. On the other hand, it can have fewer items than the specified limit, even if the table has more results. In an extreme case, it can happen that a query returns zero items but a non-null <code>nextToken</code> and only the next page will start returning data. Moreover, it can happen that client needs to fetch several pages but all of them containg zero elements. The only guarantee here is that if there are more items then the <code>nextToken</code> will be non-null and that eventually it becomes null.<p>These limitations are inherent to DynamoDB and have nothing to do with AppSync. But as an API developer, it's good to know about them so that consumers of the API can have the right expectations.<div class="floatbox floatbox-center"><div class="tcolorbox tcolorbox-info"><div class="tbox-header">Limit and nextToken</div><div class="tbox-body"><p>The <code>nextToken</code> defines where DynamoDB starts searching for elements. Think of it as a range query that means "start from here" and that it has no concept of previously sent queries.<p>Because of this, the <code>limit</code> only affects the current operation. If you want to get 10 items and the first query returns 3, set the limit to 7 for the next page.</div></div></div><p>The AppSync resolver can only send one query, which means it can fetch only a single page. Purely with the DynamoDB data source you can't implement a "fetch all items"-type functionality. While you could use a Lambda function between AppSync and the database that implements this, I don't recommend it. AppSync resolvers are meant to return a small amount of data and should run fast. Writing them in a way that might require an unbounded amount of time (for paging through potentially a large number of items) will reach a threshold eventually.<p>It is a best practice to expose DynamoDB pagination through the GraphQL schema and not hide it behind some abstraction. This way the clients can decide how to fetch pages and when to stop.<p>To implement this, whenever the API returns a list based on a DynamoDB query or a scan, add a <code>nextToken</code> argument and an indirection that exposes the result's <code>nextToken</code>.<pre class="highlight"><code><span class="hljs-keyword">type</span><span class="hljs-literal"> User</span> {
  id: <span class="hljs-literal">ID</span>!
  name:<span class="hljs-literal"> String</span>!
}

<span class="hljs-keyword">type</span><span class="hljs-literal"> PaginatedUsers</span> {
  users: [<span class="hljs-literal">User</span>!]!
  nextToken:<span class="hljs-literal"> String</span>
}

<span class="hljs-keyword">type</span><span class="hljs-literal"> Group</span> {
  id: <span class="hljs-literal">ID</span>!
  name:<span class="hljs-literal"> String</span>!
  users(count:<span class="hljs-literal"> Int</span>, nextToken:<span class="hljs-literal"> String</span>):<span class="hljs-literal"> PaginatedUsers</span>!
}</code></pre><p>The resolver can then use the argument, potentially also adding a count:<pre class="highlight prevp"><code>{
  "version": "2018-05-29",
  "operation": "Query",
  "index": "groupId",
  "query": {
    "expression": "#groupId = :groupId",
    "expressionNames": {
      "#groupId": "groupId"
    },
    "expressionValues": {
      ":groupId": {"S": $util.toJson($ctx.source.id)}
    }
  },
  "limit": $util.toJson($ctx.args.count),
  "nextToken": $util.toJson($ctx.args.nextToken)
}</code></pre><p>Then the response mapping template can extract the items and the token from the data source's response:<pre class="highlight prevp"><code>#if($ctx.error)
  $util.error($ctx.error.message, $ctx.error.type)
#end
{
  "users": $utils.toJson($ctx.result.items),
  "nextToken": $util.toJson($ctx.result.nextToken)
}</code></pre><figure class="plantuml image"><svg xmlns="http://www.w3.org/2000/svg"xmlns:xlink="http://www.w3.org/1999/xlink"height="534"preserveAspectRatio="none"style="width:559px;height:534px;background:#fff"viewBox="0 0 559 534"width="559"><defs><filter height="300%"id="b032eb7a55e1a62e6b796d349e518ec20ef7fcd6824786dc8c528af8a3abd253__a"width="300%"x="-1"y="-1"><feGaussianBlur result="blurOut"stdDeviation="2"></feGaussianBlur><feColorMatrix in="blurOut"result="blurOut2"values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"></feColorMatrix><feOffset dx="4"dy="4"in="blurOut2"result="blurOut3"></feOffset><feBlend in="SourceGraphic"in2="blurOut3"></feBlend></filter></defs><path style="stroke:#a80036;stroke-width:1;stroke-dasharray:5,5"d="M215.5 88v439.313M445.5 88v439.313"></path><path fill="#FFF"filter="url(#b032eb7a55e1a62e6b796d349e518ec20ef7fcd6824786dc8c528af8a3abd253__a)"style="stroke:#f90;stroke-width:1.5;fill:#fff"d="M100.5 5h227v78h-227z"></path><image height="64"width="64"x="107.5"xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAIAAAAlC+aJAAADOUlEQVR4Xu2ZsWocMRCG/cB5g7xBnsC1m1Rp4zpFOneGdALbXGE4MOTgCoNh87M/OyialTSzq4tyIPFj1ruz0nwjzUhe34RPt1etG33rujQAemsA9NYA6K0B0FsDoLcaAzx/vjt+/XF+fHp/OX78Pk9zwwWEm2/fH15v7/Vbe9QGgH6Lx3QaDHCaMJA8Qjv9/HX48k33s0ENABBXcRqeIcbg0WYQnIaxwMBY23i1CwAOMerwCTOgDXLCi5gZ1ys5bQeQwDfxY7M2AtB7BD63Wv6ZtgBg7cJ7rIHu3ocNAFgw9F4/2inWX8ytq0D5ANA1q80lYh9XYcbIAuMDYAWsdkqxYkK40E8TMTRssIf3cq2NYzkAuHiqPVL0gHsww6ltYsnKnKKyBqrqVDsA6E21x7CEU/YpJn153ug6Ouco2iAnKwD2V3v4GU7xmDzl7YJHD3nXfmSyAjCKlvAHRctNo+ATupUZi68tsgJM87al7+fEdOdhrvounI4LDk+y2mxVJgCuAeP6oThj0lzvcsbKOSMyAXBJFNZAIgJL1L156RrOBOAKSVhKitgzL8tJHMs14SYArgd9f1WMX5yFLI7lNEiU9FBQewCmb1KvqoUoUTeA3G7N4mifhMYAjF9hEzjMfytiyMJuzSjg52n+s1MbxGoMUN4d+VRa7tiTmBX843TpaVyVCaBwFuBgiDoPXqw/GnXVLFfWWAZWh9MyAXB4CS1+lbGTwYiaa4lZLsauqm0CCEtp53U8QOIKed6XL0KxtFkuxqxj+v6qrABxGsQwYRkPzh2Xb1urScxHVbNLHebiOjj9namYBDKw6QQQM/o9zcmQMysXDK0KQBwk1kGuH7184R8TVHfiMvMenCoAjMd5+S4rYTZmmFfeU1OoAsBprvikacv9klKrHxVUARAd5r2WMPYMc4mJZF/9lBXg0pIE04/K+i8AOLFxZbOrM4AcK7Z5H/oCyPFuT1I1AEDanZz/MsIrTNnCjmZUAwDmH5cBgpojwWohquzHuC7saEY1AAhzkU22i/g8x+888gjXqDb7XafaAFASYzideEyeN8Pncq9aAnTRAOitAdBbA6C3BkBvDYDeunqAPxdjffOs6ZOIAAAAAElFTkSuQmCC"y="12"></image><text font-family="sans-serif"font-size="14"font-style="italic"textLength="80"x="209"y="24.995">Â«AppSyncÂ»</text><text font-family="sans-serif"font-size="14"textLength="143"x="177.5"y="41.292">Query.users resolver</text><text font-family="sans-serif"font-size="12"textLength="10"x="244"y="55.732">[]</text><path fill="#FFF"filter="url(#b032eb7a55e1a62e6b796d349e518ec20ef7fcd6824786dc8c528af8a3abd253__a)"style="stroke:#f90;stroke-width:1.5;fill:#fff"d="M341.5 5h204v78h-204z"></path><image height="64"width="64"x="348.5"xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAIAAAAlC+aJAAADxUlEQVR4Xu1asYrcMBC9H58yjcs026W6Kt02KV2k3SLtQkgRyJFAIMWFFIGA76GHB63Glmdks86BxeO4s2XpvdHMaGTfg7z58qrxYC+9LhwC9sYhYG8cAvbGISChe/v19O7b4/sf5w8/FfgTF3HL9t8Q7QJA8fLp+en738HRnn//Q2c8srmesADYNSeN38Gs//gL5GDvAriIW4XO6+c/dthmBATAeMoDnKDE9qkDkqjW3mqGVwDmJvVtp18PrwA4Mdg3ezAehPJFNKyqSwCmX2l7Z6yj2WfrcAmg/zQHH+w6JP0wxBw4BSLEPl5HQEDbBDKa317PAXnog4nsrToCAhgG+InkaPvMQc1vb+XAsNBpry8iIID7K2UMaQcArUWbecxPkSG7KGIC+CfmQzyoEjaaENe542rPwWF+j8g5tAhQIPhAEfzAGyQAyAA03D3MmOLaokuiAjgZ+HkSttP8DF+WJIrFpxQuAWok/IKfo9cs7Gse8wP5gHmrD65wCZCRTe7c9UV3mr8ASDO0PCtMeAVwEYbkP4uZR8bSQ88GRN2oDezFL0A9lTIwUyWHqtqi1fdyDh5iL34BQ2IvY1mW51CmHUae2pjVgQLmH6oeVbioHy4BzELF9KB4Hg9lqmduTeqVQjN7CQkAS3vLCe4P9rqsYy8hAdQQ9VGpVuPwvblbTgQEcLIhBcNiSskx5z/r2UtIAFc5j2CG7zl7g5IHsT7OICnG3IS9NAjQK5hbs+pkY3/6T7HrkX19K3QiLMDGQJdKOm5VfXbApc8wgeb+w9phE/YSFaDRfHG/Vikqopw9E7E/libhEiDZRsbDAGXYbgUK/yF73Y85zp0EMJNAg87nWQH6D3tyBLLHIFuFgVcAbcmGWW1OnARZyi179cNhtfnFL4Cu3KfDl06vOXSOB/vk7Ak+OIxuuQYuAYUrd6mey5WwsV7Q3ZpHAiqfJDq3wYXgEsBFn/TXU/os0KdX0CzsAApQhZPsZRTgiaUKAgKik9XZc32iY1rEBAzuE5n6j73V3R6s7yeAfsJZn5beapFlMUhefWgc30+A1jb9/ImsT59qtKbAxWt6ZZR3vqS3GzKu0r0FKFgIkGKup2gqz1YN+wi4Vt9qddkbc3u3wP0EcB+g06tpJ7NqCLZQbYBLgNx+YsLERY3ZgC69BbIHnSi8AtT2/eozlIy2X29+8QuQZDPNJxf3eSDHKX1m5Qiw/Xr2EhJAPK7+0K21xiYIC1Awh+bMKo06bSZdj3YBObrX+M8e/wkOAXvjELA3DgF74xCwN14AdzgE4KRN4cQAAAAASUVORK5CYII="y="12"></image><text font-family="sans-serif"font-size="14"font-style="italic"textLength="97"x="430"y="24.995">Â«DynamoDBÂ»</text><text font-family="sans-serif"font-size="14"textLength="120"x="418.5"y="41.292">DynamoDB Table</text><text font-family="sans-serif"font-size="12"textLength="10"x="473.5"y="55.732">[]</text><path fill="#666"style="stroke:#666;stroke-width:1;fill:#666"d="m204 141.906 10 4-10 4 4-4z"></path><path style="stroke:#666;stroke-width:1"d="M0 145.906h210"></path><text fill="#666"font-family="sans-serif"font-size="12"textLength="47"x="7"y="113.139">users {</text><text fill="#666"font-family="sans-serif"font-size="12"textLength="35"x="15"y="127.107">name</text><text fill="#666"font-family="sans-serif"font-size="12"textLength="8"x="7"y="141.076">}</text><path fill="#666"style="stroke:#666;stroke-width:1;fill:#666"d="m433.5 169.875 10 4-10 4 4-4z"></path><path style="stroke:#666;stroke-width:1"d="M216 173.875h223.5"></path><text fill="#666"font-family="sans-serif"font-size="12"textLength="36"x="223"y="169.045">Query</text><path fill="#666"style="stroke:#666;stroke-width:1;fill:#666"d="m227 253.719-10 4 10 4-4-4z"></path><path style="stroke:#666;stroke-width:1"d="M221 257.719h223.5"></path><text fill="#666"font-family="sans-serif"font-size="12"textLength="8"x="233"y="197.014">{</text><text fill="#666"font-family="sans-serif"font-size="12"textLength="136"x="241"y="210.982">items: [user1, user2],</text><text fill="#666"font-family="sans-serif"font-size="12"textLength="69"x="241"y="224.951">nextToken:</text><text fill="#666"font-family="sans-serif"font-size="12"textLength="74"x="249"y="238.92">"&lt;token1&gt;"</text><text fill="#666"font-family="sans-serif"font-size="12"textLength="8"x="233"y="252.889">}</text><path fill="#666"style="stroke:#666;stroke-width:1;fill:#666"d="m11 295.656-10 4 10 4-4-4z"></path><path style="stroke:#666;stroke-width:1"d="M5 299.656h210"></path><text fill="#666"font-family="sans-serif"font-size="12"textLength="84"x="17"y="280.857">user1, user2,</text><text fill="#666"font-family="sans-serif"font-size="12"textLength="65"x="17"y="294.826">nextToken</text><path fill="#666"style="stroke:#666;stroke-width:1;fill:#666"d="m204 365.531 10 4-10 4 4-4z"></path><path style="stroke:#666;stroke-width:1"d="M0 369.531h210"></path><text fill="#666"font-family="sans-serif"font-size="12"textLength="192"x="7"y="322.795">users(nextToken:&nbsp;"&lt;token1&gt;")</text><text fill="#666"font-family="sans-serif"font-size="12"textLength="8"x="7"y="336.764">{</text><text fill="#666"font-family="sans-serif"font-size="12"textLength="35"x="15"y="350.732">name</text><text fill="#666"font-family="sans-serif"font-size="12"textLength="8"x="7"y="364.701">}</text><path fill="#666"style="stroke:#666;stroke-width:1;fill:#666"d="m433.5 407.469 10 4-10 4 4-4z"></path><path style="stroke:#666;stroke-width:1"d="M216 411.469h223.5"></path><text fill="#666"font-family="sans-serif"font-size="12"textLength="36"x="223"y="392.67">Query</text><text fill="#666"font-family="sans-serif"font-size="12"textLength="147"x="223"y="406.639">nextToken: "&lt;token1&gt;"</text><path fill="#666"style="stroke:#666;stroke-width:1;fill:#666"d="m227 477.344-10 4 10 4-4-4z"></path><path style="stroke:#666;stroke-width:1"d="M221 481.344h223.5"></path><text fill="#666"font-family="sans-serif"font-size="12"textLength="8"x="233"y="434.607">{</text><text fill="#666"font-family="sans-serif"font-size="12"textLength="92"x="241"y="448.576">items: [user3],</text><text fill="#666"font-family="sans-serif"font-size="12"textLength="95"x="241"y="462.545">nextToken: null</text><text fill="#666"font-family="sans-serif"font-size="12"textLength="8"x="233"y="476.514">}</text><path fill="#666"style="stroke:#666;stroke-width:1;fill:#666"d="m11 505.313-10 4 10 4-4-4z"></path><path style="stroke:#666;stroke-width:1"d="M5 509.313h210"></path><text fill="#666"font-family="sans-serif"font-size="12"textLength="36"x="17"y="504.482">user3</text></svg><figcaption class="caption">DynamoDB pagination in GraphQL</figcaption></figure><div class="floatbox floatbox-center"><div class="tcolorbox tcolorbox-info"><div class="tbox-header">Pagination guarantees</div><div class="tbox-body"><p>Note that by directly exposing the DynamoDB pagination to the clients, the GraphQL API also inherits all its problems. Consumers of the API need to handle things like zero-result pages.</div></div></div><h5 id="changing-data">Changing data</h5><p>(<a href="https://docs.aws.amazon.com/appsync/latest/devguide/resolver-mapping-template-reference-dynamodb.html#aws-appsync-resolver-mapping-template-reference-dynamodb-putitem">Official docs</a>)<p>Storing single items into DynamoDB tables is straightforward: you need to define the keys and the attributes. For example, this resolver adds an item with a generated ID and the provided name:<pre class="highlight prevp"><code>{
  "version": "2018-05-29",
  "operation": "PutItem",
  "key": {
    "id": {"S": "$util.autoId()"}
  },
  "attributeValues": {
    "name": {"S": $util.toJson($ctx.args.name)}
  }
}</code></pre><p>The <code>$util.autoId()</code> is an AppSync-provided function that generates a random UUID string. Using a random ID is a best practice for databases that don't provide auto-incrementing values as it's unlikely that they will collide.<p>The data source returns the inserted item without the DynamoDB type markup, so if the structure matches the GraphQL schema it is enough to check for errors and return the result:<pre class="highlight prevp"><code>#if($ctx.error)
  $util.error($ctx.error.message, $ctx.error.type)
#end
$util.toJson($ctx.result)</code></pre><p>When you need to use the generated ID in multiple places, such as when it is also present in an attribute, you can save it to a variable:<pre class="highlight prevp"><code>#set($id=$util.autoId())</code></pre><p>And to use it in a pipeline resolver, store it in the stash:<pre class="highlight prevp"><code>$util.qr($ctx.stash.put("id", $util.autoId()))</code></pre><p>Deleting items works the same, just without the attribute values (<a href="https://docs.aws.amazon.com/appsync/latest/devguide/resolver-mapping-template-reference-dynamodb.html#aws-appsync-resolver-mapping-template-reference-dynamodb-deleteitem">Official docs</a>):<pre class="highlight prevp"><code>{
  "version": "2018-05-29",
  "operation": "DeleteItem",
  "key": {
    "id": {"S": $util.toJson($ctx.args.id)}
  }
}</code></pre><p>And for updating, use the <code>UpdateItem</code> operation with an update expression (<a href="https://docs.aws.amazon.com/appsync/latest/devguide/resolver-mapping-template-reference-dynamodb.html#aws-appsync-resolver-mapping-template-reference-dynamodb-updateitem">Official docs</a>):<pre class="highlight prevp"><code>{
  "version": "2018-05-29",
  "operation": "UpdateItem",
  "key": {
    "id": {"S": $util.toJson($ctx.args.id)}
  },
  "update": {
    "expression": "SET #groupId = :groupId"
    "expressionNames": {
      "#groupId": "groupId"
    },
    "expressionValues": {
      ":groupId": {"S": $util.toJson($ctx.args.groupId)}
    }
  },
}</code></pre><div class="floatbox floatbox-center"><div class="tcolorbox tcolorbox-info"><div class="tbox-header">Conditions</div><div class="tbox-body"><p>All operations that change data supports conditions. A condition expression is evaluated atomically during the write and will fail the operation if it evaluates to false. This is called optimistic concurrency control as it relies on the assumption that concurrent modifications of the same data is rare. Combined with transactions, you can implement strong data consistency measures across several tables in DynamoDB.<pre class="highlight"><code>{
  "version": "2018-05-29",
  "operation": "UpdateItem",
  "key": {
    "id": {"S": $util.toJson($ctx.args.id)}
  },
  "update": {
    "expression": "SET #groupId = :groupId",
    "expressionNames": {
      "#groupId": "groupId"
    },
    "expressionValues": {
      ":groupId": {"S": $util.toJson($ctx.args.groupId)}
    }
  },
  "condition": {
    "expression": "attribute_not_exists(#groupId)"
  }
}</code></pre></div></div></div><h4 id="retrying">Retrying</h4><p>DynamoDB can return errors for all sorts of reasons. The service might be degraded or the capacity might not be enough, even for <a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/HowItWorks.ReadWriteCapacityMode.html#HowItWorks.PeakTraffic">on-demand capacity mode</a>. Moreover, conditions can fail if multiple operations change the same data, and transactions can easily produce transaction conflict errors. Failures are expected, so plan for them.<p>AppSync does not offer automatic retrying. If an operation fails, the resolver response will include the error that the mapping template can return to the caller, but there is no easy built-in way of running the same query again.<p>As a best practice, throw the error to the caller and let them retry the operation. This way, they can define a retry strategy that suits the application and the overall solution will be more resilient.<div class="floatbox floatbox-center"><div class="tcolorbox tcolorbox-info"><div class="tbox-header">Retrying algorithm</div><div class="tbox-body"><p>A good way to implement retrying is to use an exponential backoff with added jitter. See <a href="https://aws.amazon.com/blogs/architecture/exponential-backoff-and-jitter/">here</a> for more info.</div></div></div><h4 id="transactions">Transactions</h4><p>(<a href="https://docs.aws.amazon.com/appsync/latest/devguide/resolver-mapping-template-reference-dynamodb.html#aws-appsync-resolver-mapping-template-reference-dynamodb-transact-write-items">Official docs</a>)<p>The data source supports DynamoDB transactions too. With it you can implement atomic updates to multiple objects even across different tables. This is an extremely useful tool that opens a lot of possibilities that were not available in DynamoDB before: unique constraints, foreign keys, accurate counts.<p>Transactions feel like an afterthought for the DynamoDB data source as you need to define a table for the data source then a table for each individual transaction item. Then the table configured for the data source will be simply ignored, but on the other hand the resolver itself will need to know the tabl names which can be a problem when they are generated by a tool.<p>This transaction inserts a user into the users table but also checks if the referenced group exists:<pre class="highlight prevp"><code>{
  "version": "2018-05-29",
  "operation": "TransactWriteItems",
  "transactItems": [
    {
      "table": "user-13b359215bd4d5fb",
      "operation": "PutItem",
      "key": {
        "id" : {"S": "$util.autoId()"}
      },
      "attributeValues": {
        "name": {"S": $util.toJson($ctx.args.name)},
        "groupId": {"S": $util.toJson($ctx.args.groupId)}
      }
    },
    {
      "table": "group-13b359215bd4d5fb",
      "operation": "ConditionCheck",
      "key":{
        "id": {"S": $util.toJson($ctx.args.groupId)}
      },
      "condition":{
        "expression": "attribute_exists(#pk)",
        "expressionNames": {
          "#pk": "id"
        }
      }
    }
  ]
}</code></pre><p>The role that is configured for the data source needs to have access to all the tables that the transaction touches. This makes it easier to use a single role for all AppSync operations.<p>The usual DynamoDB constraints apply here: maximum 25 items can be included in a transaction, and each item can only be included once. Moreover, as DynamoDB locks the items as part of the operation, concurrent reads and writes can fail with a transaction conflict error.<p>The result of the data source for the TransactWriteItems operation is a list with the keys for each transaction item. For example, to check for errors then return the first item's id:<pre class="highlight prevp"><code>#if($ctx.error)
  $util.error($ctx.error.message, $ctx.error.type)
#end
$util.toJson($ctx.result.keys[0].id)</code></pre><div class="floatbox floatbox-center"><div class="tcolorbox tcolorbox-info"><div class="tbox-header">Transactions and batches</div><div class="tbox-body"><p>DynamoDB supports another construct that operates on multiple items: batches. The main difference between the two is that transactions are atomic (either all or none of the operations are effective) while batches can partially fail.<p>Batches are good when you can easily retry failed operations, which is not easy to implement in AppSync. I almost never use them with resolvers because of this.</div></div></div><h4 id="defined-data-modeling">Data modeling</h4><p>Choosing how to store data in DynamoDB is all about access patterns. Since the only performant operations are the item-level ones, where you know the key, and the Query, where you know the partition key, you need to think about what data the API will need and store it accordingly.<p>In this chapter, we'll see a few basic cases that happens most of the time when using DynamoDB with AppSync.<h5 id="mapping-references">Mapping references</h5><p>When an item references another item then make sure that it stores the target's key. For example, if a User references a Group, such as in this schema:<pre class="highlight prevp"><code><span class="hljs-keyword">type</span><span class="hljs-literal"> User</span> {
  id: <span class="hljs-literal">ID</span>!
  group:<span class="hljs-literal"> Group</span>!
}

<span class="hljs-keyword">type</span><span class="hljs-literal"> Group</span> {
  id: <span class="hljs-literal">ID</span>!
}</code></pre><p>The entry for the user should contain the group's id.<figure class="plantuml image"><svg width="406pt"height="92pt"viewBox="0 0 405.5 92"xmlns="http://www.w3.org/2000/svg"><g class="28345344537da3918a8917f6552e7c59c19649e7e6d1eea6cebc4282f853f9a9__graph"><path fill="#fff"stroke="transparent"d="M-4 4v-92h405.5V4H-4z"style="fill:#fff"transform="translate(4 88)"></path><g class="28345344537da3918a8917f6552e7c59c19649e7e6d1eea6cebc4282f853f9a9__node"><path fill="none"stroke="#000"d="M.5-63v-21h193v21H.5z"style="fill:none"transform="translate(4 88)"></path><text x="51.5"y="-70.8"font-family="monospace"font-weight="bold"font-size="14"transform="translate(4 88)">Users table</text><path fill="#f0f8ff"stroke="transparent"d="M.5-42v-21h64v21H.5z"style="fill:#f0f8ff"transform="translate(4 88)"></path><path fill="none"stroke="#000"d="M.5-42v-21h64v21H.5z"style="fill:none"transform="translate(4 88)"></path><text x="3.5"y="-49.8"font-family="monospace"font-style="italic"font-size="14"transform="translate(4 88)">id (PK)</text><path fill="#f0f8ff"stroke="transparent"d="M64.5-42v-21h56v21h-56z"style="fill:#f0f8ff"transform="translate(4 88)"></path><path fill="none"stroke="#000"d="M64.5-42v-21h56v21h-56z"style="fill:none"transform="translate(4 88)"></path><text x="75.5"y="-49.8"font-family="monospace"font-style="italic"font-size="14"transform="translate(4 88)">name</text><path fill="#f0f8ff"stroke="transparent"d="M120.5-42v-21h73v21h-73z"style="fill:#f0f8ff"transform="translate(4 88)"></path><path fill="none"stroke="#000"d="M120.5-42v-21h73v21h-73z"style="fill:none"transform="translate(4 88)"></path><text x="123.5"y="-49.8"font-family="monospace"font-style="italic"font-size="14"transform="translate(4 88)">group_id</text><path fill="none"stroke="#000"d="M.5-21v-21h64v21H.5z"style="fill:none"transform="translate(4 88)"></path><text x="11.5"y="-27.8"font-family="monospace"font-size="14"transform="translate(4 88)">user1</text><path fill="none"stroke="#000"d="M64.5-21v-21h56v21h-56z"style="fill:none"transform="translate(4 88)"></path><text x="67.5"y="-27.8"font-family="monospace"font-size="14"transform="translate(4 88)">User 1</text><path fill="none"stroke="#000"d="M120.5-21v-21h73v21h-73z"style="fill:none"transform="translate(4 88)"></path><text x="132"y="-27.8"font-family="monospace"font-size="14"transform="translate(4 88)">group1</text><path fill="none"stroke="#000"d="M.5 0v-21h64V0H.5z"style="fill:none"transform="translate(4 88)"></path><text x="11.5"y="-6.8"font-family="monospace"font-size="14"transform="translate(4 88)">user2</text><path fill="none"stroke="#000"d="M64.5 0v-21h56V0h-56z"style="fill:none"transform="translate(4 88)"></path><text x="67.5"y="-6.8"font-family="monospace"font-size="14"transform="translate(4 88)">User 2</text><path fill="none"stroke="#000"d="M120.5 0v-21h73V0h-73z"style="fill:none"transform="translate(4 88)"></path><text x="132"y="-6.8"font-family="monospace"font-size="14"transform="translate(4 88)">group2</text></g><g class="28345344537da3918a8917f6552e7c59c19649e7e6d1eea6cebc4282f853f9a9__node"><path fill="none"stroke="#000"d="M211.5-63v-21h186v21h-186z"style="fill:none"transform="translate(4 88)"></path><text x="254.5"y="-70.8"font-family="monospace"font-weight="bold"font-size="14"transform="translate(4 88)">Groups table</text><path fill="#f0f8ff"stroke="transparent"d="M211.5-42v-21h64v21h-64z"style="fill:#f0f8ff"transform="translate(4 88)"></path><path fill="none"stroke="#000"d="M211.5-42v-21h64v21h-64z"style="fill:none"transform="translate(4 88)"></path><text x="214.5"y="-49.8"font-family="monospace"font-style="italic"font-size="14"transform="translate(4 88)">id (PK)</text><path fill="#f0f8ff"stroke="transparent"d="M275.5-42v-21h122v21h-122z"style="fill:#f0f8ff"transform="translate(4 88)"></path><path fill="none"stroke="#000"d="M275.5-42v-21h122v21h-122z"style="fill:none"transform="translate(4 88)"></path><text x="319.5"y="-49.8"font-family="monospace"font-style="italic"font-size="14"transform="translate(4 88)">name</text><path fill="none"stroke="#000"d="M211.5-21v-21h64v21h-64z"style="fill:none"transform="translate(4 88)"></path><text x="218.5"y="-27.8"font-family="monospace"font-size="14"transform="translate(4 88)">group1</text><path fill="none"stroke="#000"d="M275.5-21v-21h122v21h-122z"style="fill:none"transform="translate(4 88)"></path><text x="295"y="-27.8"font-family="monospace"font-size="14"transform="translate(4 88)">base_users</text><path fill="none"stroke="#000"d="M211.5 0v-21h64V0h-64z"style="fill:none"transform="translate(4 88)"></path><text x="218.5"y="-6.8"font-family="monospace"font-size="14"transform="translate(4 88)">group2</text><path fill="none"stroke="#000"d="M275.5 0v-21h122V0h-122z"style="fill:none"transform="translate(4 88)"></path><text x="278.5"y="-6.8"font-family="monospace"font-size="14"transform="translate(4 88)">administrators</text></g></g></svg><figcaption class="caption">Storing a reference to another object</figcaption></figure><p>The resolver can use the id from the source object (the User) to do a GetItem operation to fetch the target (the Group).<p>An implementation for the <code>User.group</code> resolver:<pre class="highlight prevp"><code>{
  "version": "2018-05-29",
  "operation": "GetItem",
  "key": {
    "id": {"S": $util.toJson($ctx.source.group_id)}
  },
  "consistentRead": true
}</code></pre><h6 id="2-way-mapping">2-way mapping</h6><p>When objects have one-to-one relations, such as a User can reference another User and the other User can reference back, you need to store the id of the other object on both ends even if it is redundant.<p>For example, let's say Users can pair-program and each participant references the other one. This relation is mapped with this template:<pre class="highlight prevp"><code><span class="hljs-keyword">type</span><span class="hljs-literal"> User</span> {
  id: <span class="hljs-literal">ID</span>!
  paired_with:<span class="hljs-literal"> User</span>
}</code></pre><figure class="plantuml image"><svg width="209pt"height="113pt"viewBox="0 0 209 113"xmlns="http://www.w3.org/2000/svg"><g class="0a3d373c80f9d9a892e4adeef1987bc8ec57f15867f7c5c3bd84b642f6e9c57b__graph"><path fill="#fff"stroke="transparent"d="M-4 4v-113h209V4H-4z"style="fill:#fff"transform="translate(4 109)"></path><g class="0a3d373c80f9d9a892e4adeef1987bc8ec57f15867f7c5c3bd84b642f6e9c57b__node"><path fill="none"stroke="#000"d="M.5-83.5v-21h201v21H.5z"style="fill:none"transform="translate(4 109)"></path><text x="55.5"y="-91.3"font-family="monospace"font-weight="bold"font-size="14"transform="translate(4 109)">Users table</text><path fill="#f0f8ff"stroke="transparent"d="M.5-62.5v-21h48v21H.5z"style="fill:#f0f8ff"transform="translate(4 109)"></path><path fill="none"stroke="#000"d="M.5-62.5v-21h48v21H.5z"style="fill:none"transform="translate(4 109)"></path><text x="16"y="-70.3"font-family="monospace"font-style="italic"font-size="14"transform="translate(4 109)">id</text><path fill="#f0f8ff"stroke="transparent"d="M48.5-62.5v-21h56v21h-56z"style="fill:#f0f8ff"transform="translate(4 109)"></path><path fill="none"stroke="#000"d="M48.5-62.5v-21h56v21h-56z"style="fill:none"transform="translate(4 109)"></path><text x="59.5"y="-70.3"font-family="monospace"font-style="italic"font-size="14"transform="translate(4 109)">name</text><path fill="#f0f8ff"stroke="transparent"d="M104.5-62.5v-21h97v21h-97z"style="fill:#f0f8ff"transform="translate(4 109)"></path><path fill="none"stroke="#000"d="M104.5-62.5v-21h97v21h-97z"style="fill:none"transform="translate(4 109)"></path><text x="107.5"y="-70.3"font-family="monospace"font-style="italic"font-size="14"transform="translate(4 109)">paired_with</text><path fill="none"stroke="#000"d="M.5-41.5v-21h48v21H.5z"style="fill:none"transform="translate(4 109)"></path><text x="3.5"y="-48.3"font-family="monospace"font-size="14"transform="translate(4 109)">user1</text><path fill="none"stroke="#000"d="M48.5-41.5v-21h56v21h-56z"style="fill:none"transform="translate(4 109)"></path><text x="51.5"y="-48.3"font-family="monospace"font-size="14"transform="translate(4 109)">User 1</text><path fill="none"stroke="#000"d="M104.5-41.5v-21h97v21h-97z"style="fill:none"transform="translate(4 109)"></path><text x="132"y="-48.3"font-family="monospace"font-size="14"transform="translate(4 109)">user3</text><path fill="none"stroke="#000"d="M.5-20.5v-21h48v21H.5z"style="fill:none"transform="translate(4 109)"></path><text x="3.5"y="-27.3"font-family="monospace"font-size="14"transform="translate(4 109)">user2</text><path fill="none"stroke="#000"d="M48.5-20.5v-21h56v21h-56z"style="fill:none"transform="translate(4 109)"></path><text x="51.5"y="-27.3"font-family="monospace"font-size="14"transform="translate(4 109)">User 2</text><path fill="none"stroke="#000"d="M104.5-20.5v-21h97v21h-97zM.5.5v-21h48v21H.5z"style="fill:none"transform="translate(4 109)"></path><text x="3.5"y="-6.3"font-family="monospace"font-size="14"transform="translate(4 109)">user3</text><path fill="none"stroke="#000"d="M48.5.5v-21h56v21h-56z"style="fill:none"transform="translate(4 109)"></path><text x="51.5"y="-6.3"font-family="monospace"font-size="14"transform="translate(4 109)">User 3</text><path fill="none"stroke="#000"d="M104.5.5v-21h97v21h-97z"style="fill:none"transform="translate(4 109)"></path><text x="132"y="-6.3"font-family="monospace"font-size="14"transform="translate(4 109)">user1</text></g></g></svg><figcaption class="caption">Storing references on both ends</figcaption></figure><p>With this structure, both participants can move to the other end with a simple GetItem:<pre class="highlight prevp"><code>{
  "version": "2018-05-29",
  "operation": "GetItem",
  "key": {
    "id": {"S": $util.toJson($ctx.source.paired_with)}
  },
  "consistentRead": true
}</code></pre><p>Since this introduces redundancy (the same data is stored twice), updating needs some extra care. Use a transaction to update both ends atomically.<h5 id="mapping-lists">Mapping lists</h5><p>Efficient queries in DynamoDB relies on a composite key: one part, the partition key, is known, and the result is an ordered list of the other part. Usually, this naturally maps to GraphQL: when you want to get the users in a group, the resolver knows the group's id. To get employees under a manager, the manager's id is known. Or appointments for a doctor, then the doctor's id is in the source object. The only thing needed is a table or an index with a partition key as the known value. Then you can optionally define the sort key for ordering.<p>Usually, the target of the query will be a GSI (global secondary index) as it gives the most versatility.<p>For example, let's implement a data structure that allows efficient querying of users in a group:<pre class="highlight prevp"><code><span class="hljs-keyword">type</span><span class="hljs-literal"> User</span> {
  id: <span class="hljs-literal">ID</span>!
}

<span class="hljs-keyword">type</span><span class="hljs-literal"> Group</span> {
  id: <span class="hljs-literal">ID</span>!
  users: [<span class="hljs-literal">User</span>!]!
}</code></pre><figure class="plantuml image"><svg width="398pt"height="233pt"viewBox="0 0 397.5 233"xmlns="http://www.w3.org/2000/svg"><g class="7446fcddd8ea7e18170dd61163b061c42503017c0a5e8c0dba2268fbcbc19739__graph"><path fill="#fff"stroke="transparent"d="M-4 4v-233h397.5V4H-4z"style="fill:#fff"transform="translate(4 229)"></path><g class="7446fcddd8ea7e18170dd61163b061c42503017c0a5e8c0dba2268fbcbc19739__node"><path fill="none"stroke="#000"d="M.5-203.5v-21h193v21H.5z"style="fill:none"transform="translate(4 229)"></path><text x="51.5"y="-211.3"font-family="monospace"font-weight="bold"font-size="14"transform="translate(4 229)">Users table</text><path fill="#f0f8ff"stroke="transparent"d="M.5-182.5v-21h64v21H.5z"style="fill:#f0f8ff"transform="translate(4 229)"></path><path fill="none"stroke="#000"d="M.5-182.5v-21h64v21H.5z"style="fill:none"transform="translate(4 229)"></path><text x="3.5"y="-190.3"font-family="monospace"font-style="italic"font-size="14"transform="translate(4 229)">id (PK)</text><path fill="#f0f8ff"stroke="transparent"d="M64.5-182.5v-21h56v21h-56z"style="fill:#f0f8ff"transform="translate(4 229)"></path><path fill="none"stroke="#000"d="M64.5-182.5v-21h56v21h-56z"style="fill:none"transform="translate(4 229)"></path><text x="75.5"y="-190.3"font-family="monospace"font-style="italic"font-size="14"transform="translate(4 229)">name</text><path fill="#f0f8ff"stroke="transparent"d="M120.5-182.5v-21h73v21h-73z"style="fill:#f0f8ff"transform="translate(4 229)"></path><path fill="none"stroke="#000"d="M120.5-182.5v-21h73v21h-73z"style="fill:none"transform="translate(4 229)"></path><text x="123.5"y="-190.3"font-family="monospace"font-style="italic"font-size="14"transform="translate(4 229)">group_id</text><path fill="none"stroke="#000"d="M.5-161.5v-21h64v21H.5z"style="fill:none"transform="translate(4 229)"></path><text x="11.5"y="-168.3"font-family="monospace"font-size="14"transform="translate(4 229)">user1</text><path fill="none"stroke="#000"d="M64.5-161.5v-21h56v21h-56z"style="fill:none"transform="translate(4 229)"></path><text x="67.5"y="-168.3"font-family="monospace"font-size="14"transform="translate(4 229)">User 1</text><path fill="none"stroke="#000"d="M120.5-161.5v-21h73v21h-73z"style="fill:none"transform="translate(4 229)"></path><text x="132"y="-168.3"font-family="monospace"font-size="14"transform="translate(4 229)">group1</text><path fill="none"stroke="#000"d="M.5-140.5v-21h64v21H.5z"style="fill:none"transform="translate(4 229)"></path><text x="11.5"y="-147.3"font-family="monospace"font-size="14"transform="translate(4 229)">user2</text><path fill="none"stroke="#000"d="M64.5-140.5v-21h56v21h-56z"style="fill:none"transform="translate(4 229)"></path><text x="67.5"y="-147.3"font-family="monospace"font-size="14"transform="translate(4 229)">User 2</text><path fill="none"stroke="#000"d="M120.5-140.5v-21h73v21h-73z"style="fill:none"transform="translate(4 229)"></path><text x="132"y="-147.3"font-family="monospace"font-size="14"transform="translate(4 229)">group2</text><path fill="none"stroke="#000"d="M.5-119.5v-21h64v21H.5z"style="fill:none"transform="translate(4 229)"></path><text x="11.5"y="-126.3"font-family="monospace"font-size="14"transform="translate(4 229)">user3</text><path fill="none"stroke="#000"d="M64.5-119.5v-21h56v21h-56z"style="fill:none"transform="translate(4 229)"></path><text x="67.5"y="-126.3"font-family="monospace"font-size="14"transform="translate(4 229)">User 2</text><path fill="none"stroke="#000"d="M120.5-119.5v-21h73v21h-73z"style="fill:none"transform="translate(4 229)"></path><text x="132"y="-126.3"font-family="monospace"font-size="14"transform="translate(4 229)">group1</text></g><g class="7446fcddd8ea7e18170dd61163b061c42503017c0a5e8c0dba2268fbcbc19739__node"><path fill="none"stroke="#000"d="M3.5-63v-21h186v21H3.5z"style="fill:none"transform="translate(4 229)"></path><text x="46.5"y="-70.8"font-family="monospace"font-weight="bold"font-size="14"transform="translate(4 229)">Groups table</text><path fill="#f0f8ff"stroke="transparent"d="M3.5-42v-21h64v21h-64z"style="fill:#f0f8ff"transform="translate(4 229)"></path><path fill="none"stroke="#000"d="M3.5-42v-21h64v21h-64z"style="fill:none"transform="translate(4 229)"></path><text x="6.5"y="-49.8"font-family="monospace"font-style="italic"font-size="14"transform="translate(4 229)">id (PK)</text><path fill="#f0f8ff"stroke="transparent"d="M67.5-42v-21h122v21h-122z"style="fill:#f0f8ff"transform="translate(4 229)"></path><path fill="none"stroke="#000"d="M67.5-42v-21h122v21h-122z"style="fill:none"transform="translate(4 229)"></path><text x="111.5"y="-49.8"font-family="monospace"font-style="italic"font-size="14"transform="translate(4 229)">name</text><path fill="none"stroke="#000"d="M3.5-21v-21h64v21h-64z"style="fill:none"transform="translate(4 229)"></path><text x="10.5"y="-27.8"font-family="monospace"font-size="14"transform="translate(4 229)">group1</text><path fill="none"stroke="#000"d="M67.5-21v-21h122v21h-122z"style="fill:none"transform="translate(4 229)"></path><text x="87"y="-27.8"font-family="monospace"font-size="14"transform="translate(4 229)">base_users</text><path fill="none"stroke="#000"d="M3.5 0v-21h64V0h-64z"style="fill:none"transform="translate(4 229)"></path><text x="10.5"y="-6.8"font-family="monospace"font-size="14"transform="translate(4 229)">group2</text><path fill="none"stroke="#000"d="M67.5 0v-21h122V0h-122z"style="fill:none"transform="translate(4 229)"></path><text x="70.5"y="-6.8"font-family="monospace"font-size="14"transform="translate(4 229)">administrators</text></g><g class="7446fcddd8ea7e18170dd61163b061c42503017c0a5e8c0dba2268fbcbc19739__node"><path fill="#f0fff8"stroke="transparent"d="M211.5-203.5v-21h178v21h-178z"style="fill:#f0fff8"transform="translate(4 229)"></path><path fill="none"stroke="#000"d="M211.5-203.5v-21h178v21h-178z"style="fill:none"transform="translate(4 229)"></path><text x="263"y="-211.3"font-family="monospace"font-weight="bold"font-size="14"transform="translate(4 229)">Users GSI</text><path fill="#f0f8ff"stroke="transparent"d="M211.5-182.5v-21h114v21h-114z"style="fill:#f0f8ff"transform="translate(4 229)"></path><path fill="none"stroke="#000"d="M211.5-182.5v-21h114v21h-114z"style="fill:none"transform="translate(4 229)"></path><text x="214.5"y="-190.3"font-family="monospace"font-style="italic"font-size="14"transform="translate(4 229)">group_id (PK)</text><path fill="#f0f8ff"stroke="transparent"d="M325.5-182.5v-21h64v21h-64z"style="fill:#f0f8ff"transform="translate(4 229)"></path><path fill="none"stroke="#000"d="M325.5-182.5v-21h64v21h-64z"style="fill:none"transform="translate(4 229)"></path><text x="328.5"y="-190.3"font-family="monospace"font-style="italic"font-size="14"transform="translate(4 229)">id (SK)</text><path fill="none"stroke="#000"d="M211.5-161.5v-21h114v21h-114z"style="fill:none"transform="translate(4 229)"></path><text x="243.5"y="-168.3"font-family="monospace"font-size="14"transform="translate(4 229)">group1</text><path fill="none"stroke="#000"d="M325.5-161.5v-21h64v21h-64z"style="fill:none"transform="translate(4 229)"></path><text x="336.5"y="-168.3"font-family="monospace"font-size="14"transform="translate(4 229)">user1</text><path fill="none"stroke="#000"d="M211.5-140.5v-21h114v21h-114z"style="fill:none"transform="translate(4 229)"></path><text x="243.5"y="-147.3"font-family="monospace"font-size="14"transform="translate(4 229)">group2</text><path fill="none"stroke="#000"d="M325.5-140.5v-21h64v21h-64z"style="fill:none"transform="translate(4 229)"></path><text x="336.5"y="-147.3"font-family="monospace"font-size="14"transform="translate(4 229)">user2</text><path fill="none"stroke="#000"d="M211.5-119.5v-21h114v21h-114z"style="fill:none"transform="translate(4 229)"></path><text x="243.5"y="-126.3"font-family="monospace"font-size="14"transform="translate(4 229)">group1</text><path fill="none"stroke="#000"d="M325.5-119.5v-21h64v21h-64z"style="fill:none"transform="translate(4 229)"></path><text x="336.5"y="-126.3"font-family="monospace"font-size="14"transform="translate(4 229)">user3</text></g></g></svg><figcaption class="caption">Storing data in a GSI for efficient querying</figcaption></figure><p>The resolver can then run a Query operation on the GSI using the <code>group_id</code> as the partition key:<pre class="highlight prevp"><code>{
  "version": "2018-05-29",
  "operation": "Query",
  "index": "groupId",
  "query": {
    "expression": "#groupId = :groupId",
    "expressionNames": {
      "#groupId": "group_id"
    },
    "expressionValues": {
      ":groupId": {"S": $util.toJson($ctx.source.id)}
    }
  }
}</code></pre><div class="floatbox floatbox-center"><div class="tcolorbox tcolorbox-info"><div class="tbox-header">Eventual consistency</div><div class="tbox-body"><p>Queries on GSIs are eventually consistent which means the newly changed data might not be immediately available in the results. This is usually not a problem, but since DynamoDB does not guarantee an upper limit on how long this inconsistency can last, it's good to know about it.</div></div></div><h6 id="ordering-results">Ordering results</h6><p>Adding a sort key enables ordering and efficient range queries. For example, if users have a <code>last_active</code> field:<pre class="highlight prevp"><code><span class="hljs-keyword">type</span><span class="hljs-literal"> User</span> {
  id: <span class="hljs-literal">ID</span>!
  last_active:<span class="hljs-type"> AWSDate</span>!
}

<span class="hljs-keyword">type</span><span class="hljs-literal"> Group</span> {
  id: <span class="hljs-literal">ID</span>!
  users: [<span class="hljs-literal">User</span>!]!
}</code></pre><p>Then the GSI can include that as the sort key.<figure class="plantuml image"><svg width="412"height="374pt"viewBox="0 0 309 374"xmlns="http://www.w3.org/2000/svg"><g class="40c331094f05c98ad1cdccc80e06ed35738296058c7cac2ac57b6827814079b6__graph"><path fill="#fff"stroke="transparent"d="M-4 4v-374h309V4H-4z"style="fill:#fff"transform="translate(4 370)"></path><g class="40c331094f05c98ad1cdccc80e06ed35738296058c7cac2ac57b6827814079b6__node"><path fill="none"stroke="#000"d="M5.5-344.5v-21h290v21H5.5z"style="fill:none"transform="translate(4 370)"></path><text x="105"y="-352.3"font-family="monospace"font-weight="bold"font-size="14"transform="translate(4 370)">Users table</text><path fill="#f0f8ff"stroke="transparent"d="M5.5-323.5v-21h64v21h-64z"style="fill:#f0f8ff"transform="translate(4 370)"></path><path fill="none"stroke="#000"d="M5.5-323.5v-21h64v21h-64z"style="fill:none"transform="translate(4 370)"></path><text x="8.5"y="-331.3"font-family="monospace"font-style="italic"font-size="14"transform="translate(4 370)">id (PK)</text><path fill="#f0f8ff"stroke="transparent"d="M69.5-323.5v-21h56v21h-56z"style="fill:#f0f8ff"transform="translate(4 370)"></path><path fill="none"stroke="#000"d="M69.5-323.5v-21h56v21h-56z"style="fill:none"transform="translate(4 370)"></path><text x="80.5"y="-331.3"font-family="monospace"font-style="italic"font-size="14"transform="translate(4 370)">name</text><path fill="#f0f8ff"stroke="transparent"d="M125.5-323.5v-21h73v21h-73z"style="fill:#f0f8ff"transform="translate(4 370)"></path><path fill="none"stroke="#000"d="M125.5-323.5v-21h73v21h-73z"style="fill:none"transform="translate(4 370)"></path><text x="128.5"y="-331.3"font-family="monospace"font-style="italic"font-size="14"transform="translate(4 370)">group_id</text><path fill="#f0f8ff"stroke="transparent"d="M198.5-323.5v-21h97v21h-97z"style="fill:#f0f8ff"transform="translate(4 370)"></path><path fill="none"stroke="#000"d="M198.5-323.5v-21h97v21h-97z"style="fill:none"transform="translate(4 370)"></path><text x="201.5"y="-331.3"font-family="monospace"font-style="italic"font-size="14"transform="translate(4 370)">last_active</text><path fill="none"stroke="#000"d="M5.5-302.5v-21h64v21h-64z"style="fill:none"transform="translate(4 370)"></path><text x="16.5"y="-309.3"font-family="monospace"font-size="14"transform="translate(4 370)">user1</text><path fill="none"stroke="#000"d="M69.5-302.5v-21h56v21h-56z"style="fill:none"transform="translate(4 370)"></path><text x="72.5"y="-309.3"font-family="monospace"font-size="14"transform="translate(4 370)">User 1</text><path fill="none"stroke="#000"d="M125.5-302.5v-21h73v21h-73z"style="fill:none"transform="translate(4 370)"></path><text x="137"y="-309.3"font-family="monospace"font-size="14"transform="translate(4 370)">group1</text><path fill="none"stroke="#000"d="M198.5-302.5v-21h97v21h-97z"style="fill:none"transform="translate(4 370)"></path><text x="205.5"y="-309.3"font-family="monospace"font-size="14"transform="translate(4 370)">2022-06-15</text><path fill="none"stroke="#000"d="M5.5-281.5v-21h64v21h-64z"style="fill:none"transform="translate(4 370)"></path><text x="16.5"y="-288.3"font-family="monospace"font-size="14"transform="translate(4 370)">user2</text><path fill="none"stroke="#000"d="M69.5-281.5v-21h56v21h-56z"style="fill:none"transform="translate(4 370)"></path><text x="72.5"y="-288.3"font-family="monospace"font-size="14"transform="translate(4 370)">User 2</text><path fill="none"stroke="#000"d="M125.5-281.5v-21h73v21h-73z"style="fill:none"transform="translate(4 370)"></path><text x="137"y="-288.3"font-family="monospace"font-size="14"transform="translate(4 370)">group2</text><path fill="none"stroke="#000"d="M198.5-281.5v-21h97v21h-97z"style="fill:none"transform="translate(4 370)"></path><text x="205.5"y="-288.3"font-family="monospace"font-size="14"transform="translate(4 370)">2022-06-16</text><path fill="none"stroke="#000"d="M5.5-260.5v-21h64v21h-64z"style="fill:none"transform="translate(4 370)"></path><text x="16.5"y="-267.3"font-family="monospace"font-size="14"transform="translate(4 370)">user3</text><path fill="none"stroke="#000"d="M69.5-260.5v-21h56v21h-56z"style="fill:none"transform="translate(4 370)"></path><text x="72.5"y="-267.3"font-family="monospace"font-size="14"transform="translate(4 370)">User 2</text><path fill="none"stroke="#000"d="M125.5-260.5v-21h73v21h-73z"style="fill:none"transform="translate(4 370)"></path><text x="137"y="-267.3"font-family="monospace"font-size="14"transform="translate(4 370)">group1</text><path fill="none"stroke="#000"d="M198.5-260.5v-21h97v21h-97z"style="fill:none"transform="translate(4 370)"></path><text x="205.5"y="-267.3"font-family="monospace"font-size="14"transform="translate(4 370)">2022-01-01</text></g><g class="40c331094f05c98ad1cdccc80e06ed35738296058c7cac2ac57b6827814079b6__node"><path fill="#f0fff8"stroke="transparent"d="M.5-203.5v-21h301v21H.5z"style="fill:#f0fff8"transform="translate(4 370)"></path><path fill="none"stroke="#000"d="M.5-203.5v-21h301v21H.5z"style="fill:none"transform="translate(4 370)"></path><text x="113.5"y="-211.3"font-family="monospace"font-weight="bold"font-size="14"transform="translate(4 370)">Users GSI</text><path fill="#f0f8ff"stroke="transparent"d="M.5-182.5v-21h114v21H.5z"style="fill:#f0f8ff"transform="translate(4 370)"></path><path fill="none"stroke="#000"d="M.5-182.5v-21h114v21H.5z"style="fill:none"transform="translate(4 370)"></path><text x="3.5"y="-190.3"font-family="monospace"font-style="italic"font-size="14"transform="translate(4 370)">group_id (PK)</text><path fill="#f0f8ff"stroke="transparent"d="M114.5-182.5v-21h139v21h-139z"style="fill:#f0f8ff"transform="translate(4 370)"></path><path fill="none"stroke="#000"d="M114.5-182.5v-21h139v21h-139z"style="fill:none"transform="translate(4 370)"></path><text x="117.5"y="-190.3"font-family="monospace"font-style="italic"font-size="14"transform="translate(4 370)">last_active (SK)</text><path fill="#f0f8ff"stroke="transparent"d="M253.5-182.5v-21h48v21h-48z"style="fill:#f0f8ff"transform="translate(4 370)"></path><path fill="none"stroke="#000"d="M253.5-182.5v-21h48v21h-48z"style="fill:none"transform="translate(4 370)"></path><text x="269"y="-190.3"font-family="monospace"font-style="italic"font-size="14"transform="translate(4 370)">id</text><path fill="none"stroke="#000"d="M.5-161.5v-21h114v21H.5z"style="fill:none"transform="translate(4 370)"></path><text x="32.5"y="-168.3"font-family="monospace"font-size="14"transform="translate(4 370)">group1</text><path fill="none"stroke="#000"d="M114.5-161.5v-21h139v21h-139z"style="fill:none"transform="translate(4 370)"></path><text x="142.5"y="-168.3"font-family="monospace"font-size="14"transform="translate(4 370)">2022-06-15</text><path fill="none"stroke="#000"d="M253.5-161.5v-21h48v21h-48z"style="fill:none"transform="translate(4 370)"></path><text x="256.5"y="-168.3"font-family="monospace"font-size="14"transform="translate(4 370)">user1</text><path fill="none"stroke="#000"d="M.5-140.5v-21h114v21H.5z"style="fill:none"transform="translate(4 370)"></path><text x="32.5"y="-147.3"font-family="monospace"font-size="14"transform="translate(4 370)">group2</text><path fill="none"stroke="#000"d="M114.5-140.5v-21h139v21h-139z"style="fill:none"transform="translate(4 370)"></path><text x="142.5"y="-147.3"font-family="monospace"font-size="14"transform="translate(4 370)">2022-06-16</text><path fill="none"stroke="#000"d="M253.5-140.5v-21h48v21h-48z"style="fill:none"transform="translate(4 370)"></path><text x="256.5"y="-147.3"font-family="monospace"font-size="14"transform="translate(4 370)">user2</text><path fill="none"stroke="#000"d="M.5-119.5v-21h114v21H.5z"style="fill:none"transform="translate(4 370)"></path><text x="32.5"y="-126.3"font-family="monospace"font-size="14"transform="translate(4 370)">group1</text><path fill="none"stroke="#000"d="M114.5-119.5v-21h139v21h-139z"style="fill:none"transform="translate(4 370)"></path><text x="142.5"y="-126.3"font-family="monospace"font-size="14"transform="translate(4 370)">2022-01-01</text><path fill="none"stroke="#000"d="M253.5-119.5v-21h48v21h-48z"style="fill:none"transform="translate(4 370)"></path><text x="256.5"y="-126.3"font-family="monospace"font-size="14"transform="translate(4 370)">user3</text></g><g class="40c331094f05c98ad1cdccc80e06ed35738296058c7cac2ac57b6827814079b6__node"><path fill="none"stroke="#000"d="M57.5-63v-21h186v21h-186z"style="fill:none"transform="translate(4 370)"></path><text x="100.5"y="-70.8"font-family="monospace"font-weight="bold"font-size="14"transform="translate(4 370)">Groups table</text><path fill="#f0f8ff"stroke="transparent"d="M57.5-42v-21h64v21h-64z"style="fill:#f0f8ff"transform="translate(4 370)"></path><path fill="none"stroke="#000"d="M57.5-42v-21h64v21h-64z"style="fill:none"transform="translate(4 370)"></path><text x="60.5"y="-49.8"font-family="monospace"font-style="italic"font-size="14"transform="translate(4 370)">id (PK)</text><path fill="#f0f8ff"stroke="transparent"d="M121.5-42v-21h122v21h-122z"style="fill:#f0f8ff"transform="translate(4 370)"></path><path fill="none"stroke="#000"d="M121.5-42v-21h122v21h-122z"style="fill:none"transform="translate(4 370)"></path><text x="165.5"y="-49.8"font-family="monospace"font-style="italic"font-size="14"transform="translate(4 370)">name</text><path fill="none"stroke="#000"d="M57.5-21v-21h64v21h-64z"style="fill:none"transform="translate(4 370)"></path><text x="64.5"y="-27.8"font-family="monospace"font-size="14"transform="translate(4 370)">group1</text><path fill="none"stroke="#000"d="M121.5-21v-21h122v21h-122z"style="fill:none"transform="translate(4 370)"></path><text x="141"y="-27.8"font-family="monospace"font-size="14"transform="translate(4 370)">base_users</text><path fill="none"stroke="#000"d="M57.5 0v-21h64V0h-64z"style="fill:none"transform="translate(4 370)"></path><text x="64.5"y="-6.8"font-family="monospace"font-size="14"transform="translate(4 370)">group2</text><path fill="none"stroke="#000"d="M121.5 0v-21h122V0h-122z"style="fill:none"transform="translate(4 370)"></path><text x="124.5"y="-6.8"font-family="monospace"font-size="14"transform="translate(4 370)">administrators</text></g></g></svg><figcaption class="caption">Using a sort key with a GSI</figcaption></figure><p>Here, the <code>last_active</code> determines the ordering of the items, so querying <code>group3</code> will return <code>user3</code> then <code>user1</code>, in that order (or in reverse, depending on the <code>scanIndexForward</code> attribute).<h6 id="efficient-filtering">Efficient filtering</h6><p>DynamoDB supports <a href="https://docs.aws.amazon.com/appsync/latest/devguide/resolver-mapping-template-reference-dynamodb.html#aws-appsync-resolver-mapping-template-reference-dynamodb-filter">filter expressions</a> that you can use to define what items you need in the result. While this seems like a solution so many filtering-related problems, it is woefully inefficient in some cases.<p>The filter expression works by first reading the table, then dropping the non-conforming items. Because of this, the performance will be similar to not filtering at all, that can be a problem when there are many dropped items.<p>Let's say a GraphQL field can return user items that have a specific status field:<pre class="highlight prevp"><code><span class="hljs-keyword">type</span><span class="hljs-literal"> User</span> {
  id: <span class="hljs-literal">ID</span>!
  status:<span class="hljs-literal"> String</span>!
}

<span class="hljs-keyword">type</span><span class="hljs-literal"> Group</span> {
  id: <span class="hljs-literal">ID</span>!
  users(status:<span class="hljs-literal"> String</span>!): [<span class="hljs-literal">User</span>!]!
}</code></pre><p>If the table has many users and the requested status is rare then clients will receive many empty or almost empty pages.<figure class="plantuml image"><svg width="308pt"height="395pt"viewBox="0 0 308 395"xmlns="http://www.w3.org/2000/svg"><g class="04af265203bdc4e93e4fb78780dc766a3c5800f53f73a99389a64d7d0f469d8f__graph"><path fill="#fff"stroke="transparent"d="M-4 4v-395h308V4H-4z"style="fill:#fff"transform="translate(4 391)"></path><g class="04af265203bdc4e93e4fb78780dc766a3c5800f53f73a99389a64d7d0f469d8f__node"><path fill="none"stroke="#000"d="M0-366v-21h300v21H0z"style="fill:none"transform="translate(4 391)"></path><text x="104.5"y="-373.8"font-family="monospace"font-weight="bold"font-size="14"transform="translate(4 391)">Users table</text><path fill="#f0f8ff"stroke="transparent"d="M0-345v-21h73v21H0z"style="fill:#f0f8ff"transform="translate(4 391)"></path><path fill="none"stroke="#000"d="M0-345v-21h73v21H0z"style="fill:none"transform="translate(4 391)"></path><text x="7.5"y="-352.8"font-family="monospace"font-style="italic"font-size="14"transform="translate(4 391)">id (PK)</text><path fill="#f0f8ff"stroke="transparent"d="M73-345v-21h81v21H73z"style="fill:#f0f8ff"transform="translate(4 391)"></path><path fill="none"stroke="#000"d="M73-345v-21h81v21H73z"style="fill:none"transform="translate(4 391)"></path><text x="96.5"y="-352.8"font-family="monospace"font-style="italic"font-size="14"transform="translate(4 391)">name</text><path fill="#f0f8ff"stroke="transparent"d="M154-345v-21h73v21h-73z"style="fill:#f0f8ff"transform="translate(4 391)"></path><path fill="none"stroke="#000"d="M154-345v-21h73v21h-73z"style="fill:none"transform="translate(4 391)"></path><text x="157"y="-352.8"font-family="monospace"font-style="italic"font-size="14"transform="translate(4 391)">group_id</text><path fill="#f0f8ff"stroke="transparent"d="M227-345v-21h73v21h-73z"style="fill:#f0f8ff"transform="translate(4 391)"></path><path fill="none"stroke="#000"d="M227-345v-21h73v21h-73z"style="fill:none"transform="translate(4 391)"></path><text x="238.5"y="-352.8"font-family="monospace"font-style="italic"font-size="14"transform="translate(4 391)">status</text><path fill="none"stroke="#000"d="M0-324v-21h73v21H0z"style="fill:none"transform="translate(4 391)"></path><text x="15.5"y="-330.8"font-family="monospace"font-size="14"transform="translate(4 391)">user1</text><path fill="none"stroke="#000"d="M73-324v-21h81v21H73z"style="fill:none"transform="translate(4 391)"></path><text x="88.5"y="-330.8"font-family="monospace"font-size="14"transform="translate(4 391)">User 1</text><path fill="none"stroke="#000"d="M154-324v-21h73v21h-73z"style="fill:none"transform="translate(4 391)"></path><text x="165.5"y="-330.8"font-family="monospace"font-size="14"transform="translate(4 391)">group1</text><path fill="none"stroke="#000"d="M227-324v-21h73v21h-73z"style="fill:none"transform="translate(4 391)"></path><text x="230"y="-330.8"font-family="monospace"font-size="14"transform="translate(4 391)">INACTIVE</text><path fill="none"stroke="#000"d="M0-303v-21h73v21H0z"style="fill:none"transform="translate(4 391)"></path><text x="15.5"y="-309.8"font-family="monospace"font-size="14"transform="translate(4 391)">user2</text><path fill="none"stroke="#000"d="M73-303v-21h81v21H73z"style="fill:none"transform="translate(4 391)"></path><text x="88.5"y="-309.8"font-family="monospace"font-size="14"transform="translate(4 391)">User 2</text><path fill="none"stroke="#000"d="M154-303v-21h73v21h-73z"style="fill:none"transform="translate(4 391)"></path><text x="165.5"y="-309.8"font-family="monospace"font-size="14"transform="translate(4 391)">group1</text><path fill="none"stroke="#000"d="M227-303v-21h73v21h-73z"style="fill:none"transform="translate(4 391)"></path><text x="230"y="-309.8"font-family="monospace"font-size="14"transform="translate(4 391)">INACTIVE</text><path fill="none"stroke="#000"d="M0-282v-21h73v21H0z"style="fill:none"transform="translate(4 391)"></path><text x="24"y="-288.8"font-family="monospace"font-size="14"transform="translate(4 391)">...</text><path fill="none"stroke="#000"d="M73-282v-21h81v21H73z"style="fill:none"transform="translate(4 391)"></path><text x="101"y="-288.8"font-family="monospace"font-size="14"transform="translate(4 391)">...</text><path fill="none"stroke="#000"d="M154-282v-21h73v21h-73z"style="fill:none"transform="translate(4 391)"></path><text x="178"y="-288.8"font-family="monospace"font-size="14"transform="translate(4 391)">...</text><path fill="none"stroke="#000"d="M227-282v-21h73v21h-73z"style="fill:none"transform="translate(4 391)"></path><text x="251"y="-288.8"font-family="monospace"font-size="14"transform="translate(4 391)">...</text><path fill="none"stroke="#000"d="M0-261v-21h73v21H0z"style="fill:none"transform="translate(4 391)"></path><text x="3"y="-267.8"font-family="monospace"font-size="14"transform="translate(4 391)">user1000</text><path fill="none"stroke="#000"d="M73-261v-21h81v21H73z"style="fill:none"transform="translate(4 391)"></path><text x="76"y="-267.8"font-family="monospace"font-size="14"transform="translate(4 391)">User 1000</text><path fill="none"stroke="#000"d="M154-261v-21h73v21h-73z"style="fill:none"transform="translate(4 391)"></path><text x="165.5"y="-267.8"font-family="monospace"font-size="14"transform="translate(4 391)">group1</text><path fill="none"stroke="#000"d="M227-261v-21h73v21h-73z"style="fill:none"transform="translate(4 391)"></path><text x="238.5"y="-267.8"font-family="monospace"font-size="14"transform="translate(4 391)">ACTIVE</text></g><g class="04af265203bdc4e93e4fb78780dc766a3c5800f53f73a99389a64d7d0f469d8f__node"><path fill="#f0fff8"stroke="transparent"d="M20-204v-21h260v21H20z"style="fill:#f0fff8"transform="translate(4 391)"></path><path fill="none"stroke="#000"d="M20-204v-21h260v21H20z"style="fill:none"transform="translate(4 391)"></path><text x="112.5"y="-211.8"font-family="monospace"font-weight="bold"font-size="14"transform="translate(4 391)">Users GSI</text><path fill="#f0f8ff"stroke="transparent"d="M20-183v-21h114v21H20z"style="fill:#f0f8ff"transform="translate(4 391)"></path><path fill="none"stroke="#000"d="M20-183v-21h114v21H20z"style="fill:none"transform="translate(4 391)"></path><text x="23"y="-190.8"font-family="monospace"font-style="italic"font-size="14"transform="translate(4 391)">group_id (PK)</text><path fill="#f0f8ff"stroke="transparent"d="M134-183v-21h73v21h-73z"style="fill:#f0f8ff"transform="translate(4 391)"></path><path fill="none"stroke="#000"d="M134-183v-21h73v21h-73z"style="fill:none"transform="translate(4 391)"></path><text x="141.5"y="-190.8"font-family="monospace"font-style="italic"font-size="14"transform="translate(4 391)">id (SK)</text><path fill="#f0f8ff"stroke="transparent"d="M207-183v-21h73v21h-73z"style="fill:#f0f8ff"transform="translate(4 391)"></path><path fill="none"stroke="#000"d="M207-183v-21h73v21h-73z"style="fill:none"transform="translate(4 391)"></path><text x="218.5"y="-190.8"font-family="monospace"font-style="italic"font-size="14"transform="translate(4 391)">status</text><path fill="none"stroke="#000"d="M20-162v-21h114v21H20z"style="fill:none"transform="translate(4 391)"></path><text x="52"y="-168.8"font-family="monospace"font-size="14"transform="translate(4 391)">group1</text><path fill="none"stroke="#000"d="M134-162v-21h73v21h-73z"style="fill:none"transform="translate(4 391)"></path><text x="149.5"y="-168.8"font-family="monospace"font-size="14"transform="translate(4 391)">user1</text><path fill="none"stroke="#000"d="M207-162v-21h73v21h-73z"style="fill:none"transform="translate(4 391)"></path><text x="210"y="-168.8"font-family="monospace"font-size="14"transform="translate(4 391)">INACTIVE</text><path fill="none"stroke="#000"d="M20-141v-21h114v21H20z"style="fill:none"transform="translate(4 391)"></path><text x="52"y="-147.8"font-family="monospace"font-size="14"transform="translate(4 391)">group1</text><path fill="none"stroke="#000"d="M134-141v-21h73v21h-73z"style="fill:none"transform="translate(4 391)"></path><text x="149.5"y="-147.8"font-family="monospace"font-size="14"transform="translate(4 391)">user2</text><path fill="none"stroke="#000"d="M207-141v-21h73v21h-73z"style="fill:none"transform="translate(4 391)"></path><text x="210"y="-147.8"font-family="monospace"font-size="14"transform="translate(4 391)">INACTIVE</text><path fill="none"stroke="#000"d="M20-120v-21h114v21H20z"style="fill:none"transform="translate(4 391)"></path><text x="52"y="-126.8"font-family="monospace"font-size="14"transform="translate(4 391)">group1</text><path fill="none"stroke="#000"d="M134-120v-21h73v21h-73z"style="fill:none"transform="translate(4 391)"></path><text x="158"y="-126.8"font-family="monospace"font-size="14"transform="translate(4 391)">...</text><path fill="none"stroke="#000"d="M207-120v-21h73v21h-73z"style="fill:none"transform="translate(4 391)"></path><text x="210"y="-126.8"font-family="monospace"font-size="14"transform="translate(4 391)">INACTIVE</text><path fill="none"stroke="#000"d="M20-99v-21h114v21H20z"style="fill:none"transform="translate(4 391)"></path><text x="52"y="-105.8"font-family="monospace"font-size="14"transform="translate(4 391)">group1</text><path fill="none"stroke="#000"d="M134-99v-21h73v21h-73z"style="fill:none"transform="translate(4 391)"></path><text x="137"y="-105.8"font-family="monospace"font-size="14"transform="translate(4 391)">user1000</text><path fill="none"stroke="#000"d="M207-99v-21h73v21h-73z"style="fill:none"transform="translate(4 391)"></path><text x="218.5"y="-105.8"font-family="monospace"font-size="14"transform="translate(4 391)">ACTIVE</text></g><g class="04af265203bdc4e93e4fb78780dc766a3c5800f53f73a99389a64d7d0f469d8f__node"><path fill="none"stroke="#000"d="M74-41.5v-21h153v21H74z"style="fill:none"transform="translate(4 391)"></path><text x="100.5"y="-49.3"font-family="monospace"font-weight="bold"font-size="14"transform="translate(4 391)">Groups table</text><path fill="#f0f8ff"stroke="transparent"d="M74-20.5v-21h64v21H74z"style="fill:#f0f8ff"transform="translate(4 391)"></path><path fill="none"stroke="#000"d="M74-20.5v-21h64v21H74z"style="fill:none"transform="translate(4 391)"></path><text x="77"y="-28.3"font-family="monospace"font-style="italic"font-size="14"transform="translate(4 391)">id (PK)</text><path fill="#f0f8ff"stroke="transparent"d="M138-20.5v-21h89v21h-89z"style="fill:#f0f8ff"transform="translate(4 391)"></path><path fill="none"stroke="#000"d="M138-20.5v-21h89v21h-89z"style="fill:none"transform="translate(4 391)"></path><text x="165.5"y="-28.3"font-family="monospace"font-style="italic"font-size="14"transform="translate(4 391)">name</text><path fill="none"stroke="#000"d="M74 .5v-21h64v21H74z"style="fill:none"transform="translate(4 391)"></path><text x="81"y="-6.3"font-family="monospace"font-size="14"transform="translate(4 391)">group1</text><path fill="none"stroke="#000"d="M138 .5v-21h89v21h-89z"style="fill:none"transform="translate(4 391)"></path><text x="141"y="-6.3"font-family="monospace"font-size="14"transform="translate(4 391)">base_users</text></g></g></svg><figcaption class="caption">Inefficient filtering is similar to performance to no filtering at all</figcaption></figure><p>Efficient filtering works by adding the status to the partition key so that the query returns only the matching entities and nothing is dropped from the result. This is done by string concatenation in a single key, usually with the <code>#</code> symbol.<figure class="plantuml image"><svg width="404pt"height="374pt"viewBox="0 0 404 374"xmlns="http://www.w3.org/2000/svg"><g class="2c0b5c7c1f485ac0929b19ccfb148103edb6a650239c735d3f1038afd528b25b__graph"><path fill="#fff"stroke="transparent"d="M-4 4v-374h404V4H-4z"style="fill:#fff"transform="translate(4 370)"></path><g class="2c0b5c7c1f485ac0929b19ccfb148103edb6a650239c735d3f1038afd528b25b__node"><path fill="none"stroke="#000"d="M0-344.5v-21h396v21H0z"style="fill:none"transform="translate(4 370)"></path><text x="152.5"y="-352.3"font-family="monospace"font-weight="bold"font-size="14"transform="translate(4 370)">Users table</text><path fill="#f0f8ff"stroke="transparent"d="M0-323.5v-21h64v21H0z"style="fill:#f0f8ff"transform="translate(4 370)"></path><path fill="none"stroke="#000"d="M0-323.5v-21h64v21H0z"style="fill:none"transform="translate(4 370)"></path><text x="3"y="-331.3"font-family="monospace"font-style="italic"font-size="14"transform="translate(4 370)">id (PK)</text><path fill="#f0f8ff"stroke="transparent"d="M64-323.5v-21h56v21H64z"style="fill:#f0f8ff"transform="translate(4 370)"></path><path fill="none"stroke="#000"d="M64-323.5v-21h56v21H64z"style="fill:none"transform="translate(4 370)"></path><text x="75"y="-331.3"font-family="monospace"font-style="italic"font-size="14"transform="translate(4 370)">name</text><path fill="#f0f8ff"stroke="transparent"d="M120-323.5v-21h73v21h-73z"style="fill:#f0f8ff"transform="translate(4 370)"></path><path fill="none"stroke="#000"d="M120-323.5v-21h73v21h-73z"style="fill:none"transform="translate(4 370)"></path><text x="123"y="-331.3"font-family="monospace"font-style="italic"font-size="14"transform="translate(4 370)">group_id</text><path fill="#f0f8ff"stroke="transparent"d="M193-323.5v-21h73v21h-73z"style="fill:#f0f8ff"transform="translate(4 370)"></path><path fill="none"stroke="#000"d="M193-323.5v-21h73v21h-73z"style="fill:none"transform="translate(4 370)"></path><text x="204.5"y="-331.3"font-family="monospace"font-style="italic"font-size="14"transform="translate(4 370)">status</text><path fill="#f0f8ff"stroke="transparent"d="M266-323.5v-21h130v21H266z"style="fill:#f0f8ff"transform="translate(4 370)"></path><path fill="none"stroke="#000"d="M266-323.5v-21h130v21H266z"style="fill:none"transform="translate(4 370)"></path><text x="269"y="-331.3"font-family="monospace"font-style="italic"font-size="14"transform="translate(4 370)">group_id#status</text><path fill="none"stroke="#000"d="M0-302.5v-21h64v21H0z"style="fill:none"transform="translate(4 370)"></path><text x="11"y="-309.3"font-family="monospace"font-size="14"transform="translate(4 370)">user1</text><path fill="none"stroke="#000"d="M64-302.5v-21h56v21H64z"style="fill:none"transform="translate(4 370)"></path><text x="67"y="-309.3"font-family="monospace"font-size="14"transform="translate(4 370)">User 1</text><path fill="none"stroke="#000"d="M120-302.5v-21h73v21h-73z"style="fill:none"transform="translate(4 370)"></path><text x="131.5"y="-309.3"font-family="monospace"font-size="14"transform="translate(4 370)">group1</text><path fill="none"stroke="#000"d="M193-302.5v-21h73v21h-73z"style="fill:none"transform="translate(4 370)"></path><text x="196"y="-309.3"font-family="monospace"font-size="14"transform="translate(4 370)">INACTIVE</text><path fill="none"stroke="#000"d="M266-302.5v-21h130v21H266z"style="fill:none"transform="translate(4 370)"></path><text x="269"y="-309.3"font-family="monospace"font-size="14"transform="translate(4 370)">group1#INACTIVE</text><path fill="none"stroke="#000"d="M0-281.5v-21h64v21H0z"style="fill:none"transform="translate(4 370)"></path><text x="11"y="-288.3"font-family="monospace"font-size="14"transform="translate(4 370)">user2</text><path fill="none"stroke="#000"d="M64-281.5v-21h56v21H64z"style="fill:none"transform="translate(4 370)"></path><text x="67"y="-288.3"font-family="monospace"font-size="14"transform="translate(4 370)">User 2</text><path fill="none"stroke="#000"d="M120-281.5v-21h73v21h-73z"style="fill:none"transform="translate(4 370)"></path><text x="131.5"y="-288.3"font-family="monospace"font-size="14"transform="translate(4 370)">group2</text><path fill="none"stroke="#000"d="M193-281.5v-21h73v21h-73z"style="fill:none"transform="translate(4 370)"></path><text x="196"y="-288.3"font-family="monospace"font-size="14"transform="translate(4 370)">INACTIVE</text><path fill="none"stroke="#000"d="M266-281.5v-21h130v21H266z"style="fill:none"transform="translate(4 370)"></path><text x="269"y="-288.3"font-family="monospace"font-size="14"transform="translate(4 370)">group2#INACTIVE</text><path fill="none"stroke="#000"d="M0-260.5v-21h64v21H0z"style="fill:none"transform="translate(4 370)"></path><text x="11"y="-267.3"font-family="monospace"font-size="14"transform="translate(4 370)">user3</text><path fill="none"stroke="#000"d="M64-260.5v-21h56v21H64z"style="fill:none"transform="translate(4 370)"></path><text x="67"y="-267.3"font-family="monospace"font-size="14"transform="translate(4 370)">User 3</text><path fill="none"stroke="#000"d="M120-260.5v-21h73v21h-73z"style="fill:none"transform="translate(4 370)"></path><text x="131.5"y="-267.3"font-family="monospace"font-size="14"transform="translate(4 370)">group1</text><path fill="none"stroke="#000"d="M193-260.5v-21h73v21h-73z"style="fill:none"transform="translate(4 370)"></path><text x="204.5"y="-267.3"font-family="monospace"font-size="14"transform="translate(4 370)">ACTIVE</text><path fill="none"stroke="#000"d="M266-260.5v-21h130v21H266z"style="fill:none"transform="translate(4 370)"></path><text x="277"y="-267.3"font-family="monospace"font-size="14"transform="translate(4 370)">group1#ACTIVE</text></g><g class="2c0b5c7c1f485ac0929b19ccfb148103edb6a650239c735d3f1038afd528b25b__node"><path fill="#f0fff8"stroke="transparent"d="M80-203.5v-21h236v21H80z"style="fill:#f0fff8"transform="translate(4 370)"></path><path fill="none"stroke="#000"d="M80-203.5v-21h236v21H80z"style="fill:none"transform="translate(4 370)"></path><text x="160.5"y="-211.3"font-family="monospace"font-weight="bold"font-size="14"transform="translate(4 370)">Users GSI</text><path fill="#f0f8ff"stroke="transparent"d="M80-182.5v-21h172v21H80z"style="fill:#f0f8ff"transform="translate(4 370)"></path><path fill="none"stroke="#000"d="M80-182.5v-21h172v21H80z"style="fill:none"transform="translate(4 370)"></path><text x="83"y="-190.3"font-family="monospace"font-style="italic"font-size="14"transform="translate(4 370)">group_id#status (PK)</text><path fill="#f0f8ff"stroke="transparent"d="M252-182.5v-21h64v21h-64z"style="fill:#f0f8ff"transform="translate(4 370)"></path><path fill="none"stroke="#000"d="M252-182.5v-21h64v21h-64z"style="fill:none"transform="translate(4 370)"></path><text x="255"y="-190.3"font-family="monospace"font-style="italic"font-size="14"transform="translate(4 370)">id (SK)</text><path fill="none"stroke="#000"d="M80-161.5v-21h172v21H80z"style="fill:none"transform="translate(4 370)"></path><text x="104"y="-168.3"font-family="monospace"font-size="14"transform="translate(4 370)">group1#INACTIVE</text><path fill="none"stroke="#000"d="M252-161.5v-21h64v21h-64z"style="fill:none"transform="translate(4 370)"></path><text x="263"y="-168.3"font-family="monospace"font-size="14"transform="translate(4 370)">user1</text><path fill="none"stroke="#000"d="M80-140.5v-21h172v21H80z"style="fill:none"transform="translate(4 370)"></path><text x="104"y="-147.3"font-family="monospace"font-size="14"transform="translate(4 370)">group2#INACTIVE</text><path fill="none"stroke="#000"d="M252-140.5v-21h64v21h-64z"style="fill:none"transform="translate(4 370)"></path><text x="263"y="-147.3"font-family="monospace"font-size="14"transform="translate(4 370)">user2</text><path fill="none"stroke="#000"d="M80-119.5v-21h172v21H80z"style="fill:none"transform="translate(4 370)"></path><text x="112"y="-126.3"font-family="monospace"font-size="14"transform="translate(4 370)">group1#ACTIVE</text><path fill="none"stroke="#000"d="M252-119.5v-21h64v21h-64z"style="fill:none"transform="translate(4 370)"></path><text x="263"y="-126.3"font-family="monospace"font-size="14"transform="translate(4 370)">user3</text></g><g class="2c0b5c7c1f485ac0929b19ccfb148103edb6a650239c735d3f1038afd528b25b__node"><path fill="none"stroke="#000"d="M105-63v-21h186v21H105z"style="fill:none"transform="translate(4 370)"></path><text x="148"y="-70.8"font-family="monospace"font-weight="bold"font-size="14"transform="translate(4 370)">Groups table</text><path fill="#f0f8ff"stroke="transparent"d="M105-42v-21h64v21h-64z"style="fill:#f0f8ff"transform="translate(4 370)"></path><path fill="none"stroke="#000"d="M105-42v-21h64v21h-64z"style="fill:none"transform="translate(4 370)"></path><text x="108"y="-49.8"font-family="monospace"font-style="italic"font-size="14"transform="translate(4 370)">id (PK)</text><path fill="#f0f8ff"stroke="transparent"d="M169-42v-21h122v21H169z"style="fill:#f0f8ff"transform="translate(4 370)"></path><path fill="none"stroke="#000"d="M169-42v-21h122v21H169z"style="fill:none"transform="translate(4 370)"></path><text x="213"y="-49.8"font-family="monospace"font-style="italic"font-size="14"transform="translate(4 370)">name</text><path fill="none"stroke="#000"d="M105-21v-21h64v21h-64z"style="fill:none"transform="translate(4 370)"></path><text x="112"y="-27.8"font-family="monospace"font-size="14"transform="translate(4 370)">group1</text><path fill="none"stroke="#000"d="M169-21v-21h122v21H169z"style="fill:none"transform="translate(4 370)"></path><text x="188.5"y="-27.8"font-family="monospace"font-size="14"transform="translate(4 370)">base_users</text><path fill="none"stroke="#000"d="M105 0v-21h64V0h-64z"style="fill:none"transform="translate(4 370)"></path><text x="112"y="-6.8"font-family="monospace"font-size="14"transform="translate(4 370)">group2</text><path fill="none"stroke="#000"d="M169 0v-21h122V0H169z"style="fill:none"transform="translate(4 370)"></path><text x="172"y="-6.8"font-family="monospace"font-size="14"transform="translate(4 370)">administrators</text></g></g></svg><figcaption class="caption">Adding the filtered fields to the partition key allows efficient filtering</figcaption></figure><p>Since the resolver knows the <code>group_id</code> (from the source object) as well as the <code>status</code> (from the resolver argument), it can construct the partition key for the query.<pre class="highlight"><code>#set($groupIdStatus =
  $util.escapeJavaScript($ctx.source.id) +
  "#" +
  $util.escapeJavaScript($ctx.args.status)
)
{
  "version": "2018-05-29",
  "operation": "Query",
  "index": "groupIdStatus",
  "query": {
    "expression": "#groupIdStatus = :groupIdStatus",
    "expressionNames": {
      "#groupIdStatus": "group_id#status"
    },
    "expressionValues": {
      ":groupIdStatus" : {"S": "$groupIdStatus"}
    }
  }
}</code></pre><div class="floatbox floatbox-center"><div class="tcolorbox tcolorbox-info"><div class="tbox-header">How to make filtering optional</div><div class="tbox-body"><p>In the above example, there is no way to query users in a group regardless of their status. To also support that case, add a separate GSI with only the <code>group_id</code> as the partition key and check in the resolver whether the value is supplied or not.</div></div></div><div class="floatbox floatbox-center"><div class="tcolorbox tcolorbox-info"><div class="tbox-header">Filter expression or composite partition key?</div><div class="tbox-body"><p>Filter expressions are good when:<ul><li>The table is small (not many elements)<li>The number of dropped items for most queries is small and<li>Clients usually don't want to retrieve all matching items</ul><p>The composite partition key is good when:<ul><li>The table is large (many elements)<li>The number of dropped items can be large</ul></div></div></div><div class="tcolorbox tcolorbox-secondary my-5"><div class="tbox-header fw-bold">Master AppSync and GraphQL</div><div class="tbox-body"><div>Support this book and get all future updates and extra chapters in ebook format.</div><div class="d-flex justify-content-center"><a role="button"href="https://tsallai.gumroad.com/l/graphql-on-aws-appsync-book"class="btn btn-primary not-styled mt-3 text-white">Buy the book</a></div></div></div><div class="pagination row"><div class="col-6"><a href="/aws-appsync/data-sources/lambda-1/"class="border rounded d-block p-3"><div class="pagination-sublabel text-muted small">Previous</div><div class="pagination-title">&lt; Lambda</div></a></div><div class="col-6"><span class="border rounded d-block p-3 text-end ms-auto text-muted"><div class="pagination-sublabel text-muted small">Next</div><div class="pagination-title">HTTP &gt;</div></span></div></div><footer>Â© TamÃ¡s Sallai - <a href="https://advancedweb.hu">advancedweb.hu</a></footer></div><div class="col-lg-3 d-none d-lg-block"><div class="toc-container"><a style="margin-left: 0em"href="#dynamodb">DynamoDB</a> <a style="margin-left: 1em"href="#configuring-the-data-source-1">Configuring the data source</a> <a style="margin-left: 1em"href="#operations">Operations</a> <a style="margin-left: 2em"href="#getting-elements">Getting elements</a> <a style="margin-left: 2em"href="#running-queries">Running queries</a> <a style="margin-left: 3em"href="#defined-ddb-pagination">Pagination</a> <a style="margin-left: 2em"href="#changing-data">Changing data</a> <a style="margin-left: 1em"href="#retrying">Retrying</a> <a style="margin-left: 1em"href="#transactions">Transactions</a> <a style="margin-left: 1em"href="#defined-data-modeling">Data modeling</a> <a style="margin-left: 2em"href="#mapping-references">Mapping references</a> <a style="margin-left: 3em"href="#2-way-mapping">2-way mapping</a> <a style="margin-left: 2em"href="#mapping-lists">Mapping lists</a> <a style="margin-left: 3em"href="#ordering-results">Ordering results</a> <a style="margin-left: 3em"href="#efficient-filtering">Efficient filtering</a></div></div></div></div></div><script src="/assets/main.077454cb0bffe3695e9176b1b5f8a7fd9676d920.js"></script>